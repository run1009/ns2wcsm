cscope 16 $HOME\ns-allinone-2.31\ns-2.31\wimax\mesh"               0000162134
	@wimsh_buffers.cc

20 
	~<wimsh_bufãrs.h
>

22 
	~<.h
>

30 
	gWimshF¿gm’tiÚBufãr
::
	$WimshF¿gm’tiÚBufãr
 ()

32 
f¢_
 = 0;

33 
bur¡_
 = 0;

34 
Ï¡Pdu_
 = 0;

35 
	}
}

37 
boŞ


38 
	gWimshF¿gm’tiÚBufãr
::
ÃwBur¡
 (
wimax
::
Bur¡Profe
 
p
, 
size
)

40 
	gsize_
 = 
size
;

41 
	gbur¡_
 = 
Ãw
 
WimshBur¡
;

42 
	gbur¡_
->
´ofe
 (èğ
p
;

51 iàĞ
	gÏ¡Pdu_
 =ğ0 )  
Œue
;

59 
	gÃeded
 = 
Ï¡Pdu_
->
size
();

62 iàĞ
	gÃeded
 <ğ
size_
 ) {

65 iàĞ
Ï¡Pdu_
->
hdr
().
äagm’tiÚ
(è=ğ
Œue
 )

66 
Ï¡Pdu_
->
fsh
().
¡©e
(èğ
WimaxFsh
::
LAST_FRAG
;

68 
	gbur¡_
->
addD©a
 (
Ï¡Pdu_
);

69 
	gsize_
 -ğ
Ï¡Pdu_
->
size
();

71 
	gÏ¡Pdu_
 = 0;

72 iàĞ
	gsize_
 > 
	gWimaxPdu
::
mšSize
(èè 
Œue
;

73  
	gçl£
;

78 
	gäagsize
 =

79 
size_


80 - 
Ï¡Pdu_
->
hdr
().
size
()

81 - 
WimaxPdu
::
meshSubhdrSize
()

82 - 
WimaxFsh
::
size
();

85 iàĞ
	gäagsize
 < 1 )  
	gçl£
;

89 
WimaxPdu
* 
	gÃwpdu
 = 
Ãw
 WimaxPdu (*
Ï¡Pdu_
);

90 
WimaxSdu
* 
	gÃwsdu
 = 
Ãw
 WimaxSdu (*
Ï¡Pdu_
->
sdu
());

91 
	gÃwsdu
->
cİyPaylßd
 (
Ï¡Pdu_
->
sdu
());

92 
	gÃwpdu
->
sdu
(èğ
Ãwsdu
;

94 iàĞ
	gÏ¡Pdu_
->
hdr
().
äagm’tiÚ
(è=ğ
çl£
 ) {

96 
Ãwpdu
->
hdr
().
äagm’tiÚ
(èğ
Œue
;

97 
	gÃwpdu
->
fsh
().
¡©e
(èğ
WimaxFsh
::
FIRST_FRAG
;

98 
	gÃwpdu
->
fsh
().
f¢
(èğ
f¢_
;

99 
	gÃwpdu
->
size
 (
äagsize
);

102 
f¢
 ();

105 
	gÏ¡Pdu_
->
hdr
().
äagm’tiÚ
(èğ
Œue
;

106 
	gÏ¡Pdu_
->
fsh
().
f¢
(èğ
Ãwpdu
->fsh().fsn();

107 
	gÏ¡Pdu_
->
size
 (
Ï¡Pdu_
->
sdu
()->size(è- 
äagsize
);

110 
	gÃwpdu
->
hdr
().
äagm’tiÚ
(èğ
Œue
;

111 
	gÃwpdu
->
fsh
().
¡©e
(èğ
WimaxFsh
::
CONT_FRAG
;

112 
	gÃwpdu
->
fsh
().
f¢
(èğ
Ï¡Pdu_
->fsh().fsn();

113 
	gÃwpdu
->
size
 (
äagsize
);

116 
	gÏ¡Pdu_
->
hdr
().
Ëngth
(èğ
Ï¡Pdu_
->
size
 (è- 
äagsize
;

119 
	gsize_
 = 0;

120 
	gbur¡_
->
addD©a
 (
Ãwpdu
);

121  
	gçl£
;

125 
boŞ


126 
	gWimshF¿gm’tiÚBufãr
::
	$addPdu
 (
WimaxPdu
* 
pdu
)

130 iàĞ
size_
 >ğ
pdu
->
	`size
() ) {

133 
bur¡_
->
	`addD©a
 (
pdu
);

137 
	`f¢
 ();

140 
size_
 -ğ
pdu
->
	`size
();

144 iàĞ
size_
 > 
WimaxPdu
::
	`mšSize
(èè 
Œue
;

145  
çl£
;

154 
Ï¡Pdu_
 = 
pdu
;

157 
äagsize
 =

158 
size_


159 - 
pdu
->
	`hdr
().
	`size
()

160 - 
WimaxPdu
::
	`meshSubhdrSize
()

161 - 
WimaxFsh
::
	`size
();

163 iàĞ
äagsize
 > 0 ) {

165 
WimaxPdu
* 
Ãwpdu
 = 
Ãw
 
	`WimaxPdu
 (*
pdu
);

166 
WimaxSdu
* 
Ãwsdu
 = 
Ãw
 
	`WimaxSdu
 (*
pdu
->
	`sdu
());

167 
Ãwsdu
->
	`cİyPaylßd
 (
pdu
->
	`sdu
());

168 
Ãwpdu
->
	`sdu
(èğ
Ãwsdu
;

171 
Ãwpdu
->
	`hdr
().
	`äagm’tiÚ
(èğ
Œue
;

172 
Ãwpdu
->
	`fsh
().
	`¡©e
(èğ
WimaxFsh
::
FIRST_FRAG
;

173 
Ãwpdu
->
	`fsh
().
	`f¢
(èğ
f¢_
;

174 
Ãwpdu
->
	`size
 (
äagsize
);

177 
	`f¢
();

180 
Ï¡Pdu_
->
	`hdr
().
	`äagm’tiÚ
(èğ
Œue
;

181 
Ï¡Pdu_
->
	`fsh
().
	`f¢
(èğ
Ãwpdu
->fsh().fsn();

182 
Ï¡Pdu_
->
	`size
 (Ï¡Pdu_->
	`sdu
()->size(è- 
äagsize
);

184 
size_
 = 0;

185 
bur¡_
->
	`addD©a
 (
Ãwpdu
);

189  
çl£
;

190 
	}
}

	@wimsh_buffers.h

20 #iâdeà
__NS2_WIMSH_BUFFERS_H


21 
	#__NS2_WIMSH_BUFFERS_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<wimsh_·ck‘.h
>

26 
	~<veùÜ
>

28 
şass
 
	gWimaxMac
;

49 şas 
	cWimshF¿gm’tiÚBufãr
 {

51 
WimshBur¡
* 
	mbur¡_
;

53 
	msize_
;

55 
WimaxPdu
* 
	mÏ¡Pdu_
;

57 
	mf¢_
;

58 
	mpublic
:

60 
WimshF¿gm’tiÚBufãr
 ();

62 ~
	$WimshF¿gm’tiÚBufãr
 () { }

75 
boŞ
 
	`ÃwBur¡
 (
wimax
::
Bur¡Profe
 
p
, 
size
);

77 
boŞ
 
	`addPdu
 (
WimaxPdu
* 
pdu
);

79 
WimshBur¡
* 
	$g‘Bur¡
 (è{  
bur¡_
; 
	}
}

81 
	$size
 (è{  
size_
; 
	}
}

83 
	g´Ùeùed
:

85 
addBacklogFsh
 (
WimaxPdu
* 
pdu
);

87 
	$f¢
 (è{ 
f¢_
 = ( f¢_ + 1 ) % 
WimaxFsh
::
	`f¢Size
(); 
	}
}

	@wimsh_bwmanager.cc

20 
	~<wimsh_bwmªag”.h
>

22 
	~<wimsh_mac.h
>

23 
	~<wimsh_·ck‘.h
>

31 
	gWimshBwMªag”
::
	$WimshBwMªag”
 (
WimshMac
* 
m
è: 
	`mac_
 (m), 
	$tim”_
 (
this
)

34 
g¿Ás_
.
	`»size
 (
HORIZON
);

35 
d¡_
.
	`»size
 (
HORIZON
);

36 
chªÃl_
.
	`»size
 (
HORIZON
);

38  
i
 = 0 ; i < 
HORIZON
 ; i++ ) {

40 
g¿Ás_
[
i
].
	`»£t
();

43 
d¡_
[
i
].
	`»size
 (
MAX_SLOTS
);

44 
chªÃl_
[
i
].
	`»size
 (
MAX_SLOTS
);

47  
j
 = 0 ; j < 
MAX_SLOTS
 ; j++ ) 
chªÃl_
[
i
][j] = 0;

52 
tim”_
.
	`¡¬t
 (
mac_
->
	`phyMib
()->
	`cÚŒŞDu¿tiÚ
());

54 
Ï¡SlÙ_
 = 0;

55 
	}
}

58 
	gWimshBwMªag”
::
	$hªdË
 ()

60 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::hªdË"èè
	`årštf
 (
¡d”r
,

62 
NOW
, 
mac_
->
	`nodeId
(), mac_->
	`äame
(è% 
HORIZON
, 
Ï¡SlÙ_
);

64 cÚ¡ 
F
 = 
mac_
->
	`äame
(è% 
HORIZON
;

65 cÚ¡ 
N
 = 
mac_
->
	`phyMib
()->
	`¦ÙP”F¿me
();

67 
boŞ
 
¡©us
 = 
Œue
;

68 
WimaxNodeId
 
d¡
 = 0;

69 
chªÃl
 = 0;

70 
¡¬t
;

71 
¿nge
 = 0;

77  ; 
Ï¡SlÙ_
 < 
N
 ;†astSlot_++ ) {

78 iàĞ
¿nge
 == 0 ) {

79 
¡©us
 = 
g¿Ás_
[
F
][
Ï¡SlÙ_
];

80 iàĞ
¡©us
 =ğ
Œue
 ) 
d¡
 = 
d¡_
[
F
][
Ï¡SlÙ_
];

81 
chªÃl
 = 
chªÃl_
[
F
][
Ï¡SlÙ_
];

82 
¡¬t
 = 
Ï¡SlÙ_
;

83 
¿nge
 = 1;

85 iàĞ
chªÃl_
[
F
][
Ï¡SlÙ_
] =ğ
chªÃl
 &&

86 
g¿Ás_
[
F
][
Ï¡SlÙ_
] =ğ
¡©us
 &&

87 ĞĞ
¡©us
 =ğ
Œue
 && 
d¡_
[
F
][
Ï¡SlÙ_
] =ğ
d¡
 ) ||

88 Ğ
¡©us
 =ğ
çl£
 ) )

89 è++
¿nge
;

94 iàĞ
¡©us
 =ğ
Œue
 ) {

96 
mac_
->
	`Œªsm™
 (
¿nge
, 
d¡
, 
chªÃl
);

99 
mac_
->
	`»ûive
 (
chªÃl
);

105 iàĞ
Ï¡SlÙ_
 =ğ
N
 ) {

106 
tim”_
.
	`¡¬t
 (

107 
mac_
->
	`phyMib
()->
	`ÃxtF¿me
()

108 + 
mac_
->
	`phyMib
()->
	`cÚŒŞDu¿tiÚ
()

109 - 
NOW
);

112 
	`šv®id©e
 (
F
);

115 
Ï¡SlÙ_
 = 0;

120 
tim”_
.
	`¡¬t
 ( 
¿nge
 * 
mac_
->
	`phyMib
()->
	`¦ÙDu¿tiÚ
() );

122 
	}
}

125 
	gWimshBwMªag”
::
	$šv®id©e
 (
F
)

127 
g¿Ás_
[
F
].
	`»£t
();

128  
i
 = 0 ; i < 
MAX_SLOTS
 ; i++ ) 
chªÃl_
[
F
][i] = 0;

129 
	}
}

137 
	gWimshBwMªag”Dummy
::
	$WimshBwMªag”Dummy
 (
WimshMac
* 
m
) :

138 
	$WimshBwMªag”
 (
m
)

141 
	}
}

144 
WimshBwMªag”Dummy
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

146 iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
 (
¬gv
[0], "static") == 0 ) {

148 
	`£tRªge
 ( 
	`©oi
(
¬gv
[1]),‡toi(argv[2]),‡toi(argv[3]) );

149  
TCL_OK
;

152  
TCL_ERROR
;

153 
	}
}

156 
	gWimshBwMªag”Dummy
::
	$»cvMshDsch
 (
WimshMshDsch
* 
dsch
)

158 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::»cvMshDsch"èè
	`årštf
 (
¡d”r
,

159 "%.9àWBWM::»cvMshDsch[%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

162 
¡d
::
li¡
<
WimshMshDsch
::
GÁIE
>& 
gÁ
 = 
dsch
->
	`gÁ
();

164 
¡d
::
li¡
<
WimshMshDsch
::
GÁIE
>::
™”©Ü
 
™
;

165  
™
 = 
gÁ
.
	`begš
(è; iˆ!ğgÁ.
	`’d
() ; ++it ) {

169 iàĞ
™
->
äomReque¡”_
 =ğ
çl£
 && it->
nodeId_
 =ğ
mac_
->
	`nodeId
() ) {

175  
f
 = 0 ;

176 
f
 < 
WimshMshDsch
::
	`³rs2äames
 (
™
->
³rsi¡’û_
) ; f++ ) {

177 
F
 = ( 
™
->
äame_
 + 
f
 ) % 
HORIZON
;

180  
s
 = 0 ; s < 
™
->
¿nge_
 ; s++ ) {

181 
S
 = 
s
 + 
™
->
¡¬t_
;

183 
g¿Ás_
[
F
][
S
] = 
Œue
;

184 
d¡_
[
F
][
S
] = 
dsch
->
	`¤c
();

189 
	}
}

192 
	gWimshBwMªag”Dummy
::
	$scheduË
 (
WimshMshDsch
* 
dsch
)

194 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::scheduË"èè
	`årštf
 (
¡d”r
,

195 "%.9àWBWM::scheduË [%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

198 
¡d
::
veùÜ
<
AÎoÿtiÚDesc
>::
™”©Ü
 
™
;

199  
™
 = 
®loc_
.
	`begš
(è; iˆ!ğ®loc_.
	`’d
() ; ++it ) {

200 
WimshMshDsch
::
GÁIE
 
gÁ
;

201 
gÁ
.
nodeId_
 = 
™
->
node_
;

202 
gÁ
.
äame_
 =

203 
mac_
->
	`äame
()

204 + (è
	`û
 (

205 (
	`çbs
 ( 
mac_
->
	`h
 (
™
->
node_
è- mac_->
	`phyMib
()->
	`cÚŒŞDu¿tiÚ
() ))

206 / 
mac_
->
	`phyMib
()->
	`äameDu¿tiÚ
()

208 
gÁ
.
¡¬t_
 = 
™
->start_;

209 
gÁ
.
¿nge_
 = 
™
->range_;

210 
gÁ
.
äomReque¡”_
 = 
çl£
;

211 
gÁ
.
³rsi¡’û_
 = 
WimshMshDsch
::
FRAME1
;

212 
gÁ
.
chªÃl_
 = 0;

214 
dsch
->
	`add
 (
gÁ
);

216 
	}
}

	@wimsh_bwmanager.h

20 #iâdeà
__NS2_WIMSH_BW_MANAGER_H


21 
	#__NS2_WIMSH_BW_MANAGER_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<t_tim”s.h
>

26 
	~<b™£t
>

27 
	~<veùÜ
>

29 
	~<m©h.h
>

31 
şass
 
	gWimshMac
;

32 
şass
 
	gWimshMshDsch
;

41 şas 
	cWimshBwMªag”
 {

42 
	m´Ùeùed
:

44 ’um { 
HORIZON
 = 128 };

47 ’um { 
	gMAX_SLOTS
 = 256 };

50 
WimshMac
* 
	gmac_
;

53 
	gTTim”
<
	gWimshBwMªag”
> 
	gtim”_
;

76 
	g¡d
::
veùÜ
< 
¡d
::
b™£t
<
MAX_SLOTS
> > 
g¿Ás_
;

78 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<
WimaxNodeId
> > 
d¡_
;

80 
	g¡d
::
veùÜ
< 
¡d
::veùÜ<> > 
chªÃl_
;

83 
	gÏ¡SlÙ_
;

85 
	gpublic
:

87 
WimshBwMªag”
 (
WimshMac
* 
m
);

89 
	gvœtu®
 ~
	$WimshBwMªag”
 (è{ 
	}
}

92 
vœtu®
 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
) = 0;

98 
vœtu®
 
scheduË
 (
WimshMshDsch
* 
dsch
) = 0;

101 
vœtu®
 
hªdË
 ();

104 
vœtu®
 
š™Ÿlize
 () = 0;

107 
vœtu®
 
backlog
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
´io
,

108 
WimaxNodeId
 
Ãxthİ
, 
by‹s
 ) = 0;

111 
vœtu®
 
backlog
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
 ) = 0;

114 
vœtu®
 
»ûived
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
´io
,

115 
WimaxNodeId
 
sourû
, 
by‹s
) = 0;

118 
vœtu®
 
£Á
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
) = 0;

121 
vœtu®
 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
) = 0;

123 
	g´Ùeùed
:

129 
vœtu®
 
šv®id©e
 (
F
);

132 
	g‹m¶©e
<
ty³Çme
 
	gT
,y³Çm
	gV
>

133 
£tSlÙs
 ( 
T
& 
m­
,

134 
f¡¬t
, 
äªge
,

135 
m¡¬t
, 
m¿nge
, cÚ¡ 
V
& 
v®ue
);

138 
	g‹m¶©e
<
ty³Çme
 
	gT
,y³Çm
	gV
>

140 
	gWimshBwMªag”
::
	$£tSlÙs
 (

141 
T
& 
m­
,

142 
f¡¬t
, 
äªge
,

143 
m¡¬t
, 
m¿nge
, cÚ¡ 
V
& 
v®ue
)

146  
f
 = 0 ; f < 
äªge
 ; f++ ) {

147 
F
 = ( 
f¡¬t
 + 
f
 ) % 
HORIZON
;

150  
s
 = 0 ; s < 
m¿nge
 ; s++ ) {

151 
S
 = 
m¡¬t
 + 
s
;

154 
m­
[
F
][
S
] = 
v®ue
;

157 
	}
}

166 şas 
	cWimshBwMªag”Dummy
 : 
public
 
WimshBwMªag”
 {

168 
	sAÎoÿtiÚDesc
 {

170 
WimaxNodeId
 
node_
;

172 
	m¡¬t_
;

174 
	m¿nge_
;

176 
AÎoÿtiÚDesc
 (
WimaxNodeId
 
node
,

177 
¡¬t
,

178 
¿nge
) {

179 
	mnode_
 = 
node
; 
	m¡¬t_
 = 
¡¬t
; 
	m¿nge_
 = 
¿nge
; }

183 
	g¡d
::
veùÜ
<
AÎoÿtiÚDesc
> 
®loc_
;

185 
	gpublic
:

187 
WimshBwMªag”Dummy
 (
WimshMac
* 
m
);

189 ~
	$WimshBwMªag”Dummy
 (è{ 
	}
}

192 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
);

198 
scheduË
 (
WimshMshDsch
* 
dsch
);

201 
	$š™Ÿlize
 (è{ 
	}
}

204 
	$backlog
 (
WimaxNodeId
, WimaxNodeId, ,

205 
WimaxNodeId
, è{ 
	}
}

207 
	$backlog
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
 ) { 
	}
}

209 
	$»ûived
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, ,

210 
WimaxNodeId
 
sourû
, 
by‹s
è{ 
	}
}

212 
	$£Á
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
è{ 
	}
}

215 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

217 
	g´Ùeùed
:

219 
	$šv®id©e
 (
F
è{ 
WimshBwMªag”
::
	`šv®id©e
(F); 
	}
}

221 
	g´iv©e
:

223 
	$£tRªge
 (
WimaxNodeId
 
node
, 
¡¬t
, 
¿nge
) {

224 
®loc_
.
	`push_back
 (
	`AÎoÿtiÚDesc
 (
node
, 
¡¬t
, 
¿nge
)); 
	}
}

	@wimsh_bwmanager_frr.cc

20 
	~<wimsh_bwmªag”_är.h
>

22 
	~<wimsh_mac.h
>

23 
	~<wimsh_tİŞogy.h
>

24 
	~<wimsh_·ck‘.h
>

26 
	~<¿ndom.h
>

27 
	~<¡©.h
>

29 
	gWimshBwMªag”FaœRR
::
	$WimshBwMªag”FaœRR
 (
WimshMac
* 
m
) :

30 
	`WimshBwMªag”
 (
m
), 
	$wm_
 (
m
)

33 
busy_
.
	`»size
 (
HORIZON
);

34 
uncÚfœmedSlÙs_
.
	`»size
 (
HORIZON
);

36  
i
 = 0 ; i < 
HORIZON
 ; i++ ) {

38 
busy_
[
i
].
	`»£t
();

39 
uncÚfœmedSlÙs_
[
i
].
	`»£t
();

42 
»g¿ÁOff£t_
 = 1;

43 
»g¿ÁDu¿tiÚ_
 = 1;

44 
avlAdv”ti£_
 = 
Œue
;

45 
»g¿ÁEÇbËd_
 = 
Œue
;

46 
çœG¿Á_
 = 
Œue
;

47 
çœReque¡_
 = 
Œue
;

48 
çœReg¿Á_
 = 
Œue
;

49 
defic™Ov”æow_
 = 
çl£
;

50 
g¿ÁF™RªdomChªÃl_
 = 
çl£
;

51 
§meReg¿ÁHÜizÚ_
 = 
çl£
;

52 
maxDefic™_
 = 0;

53 
maxBacklog_
 = 0;

54 
roundDu¿tiÚ_
 = 0;

55 
ddTimeout_
 = 0;

56 
ddTim”_
 = 0;

57 
mšG¿Á_
 = 1;

58 
	}
}

61 
	gWimshBwMªag”FaœRR
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

63 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "availabilities") == 0 ) {

64 iàĞ
	`¡rcmp
 (
¬gv
[1], "on") == 0 ) {

65 
avlAdv”ti£_
 = 
Œue
;

66 } iàĞ
	`¡rcmp
 (
¬gv
[1], "off") == 0 ) {

67 
avlAdv”ti£_
 = 
çl£
;

69 
	`årštf
 (
¡d”r
, "invalid‡vailabilities '%s' command. "

70 "Choo£ƒ™h” 'Ú' o¸'off'", 
¬gv
[1]);

71  
TCL_ERROR
;

73  
TCL_OK
;

74 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "regrant") == 0 ) {

75 iàĞ
	`¡rcmp
 (
¬gv
[1], "on") == 0 ) {

76 
»g¿ÁEÇbËd_
 = 
Œue
;

77 } iàĞ
	`¡rcmp
 (
¬gv
[1], "off") == 0 ) {

78 
»g¿ÁEÇbËd_
 = 
çl£
;

80 
	`årštf
 (
¡d”r
, "invalid„egrant '%s' command. "

81 "Choo£ƒ™h” 'Ú' o¸'off'", 
¬gv
[1]);

82  
TCL_ERROR
;

84  
TCL_OK
;

85 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "regrant-same-horizon") == 0 ) {

86 iàĞ
	`¡rcmp
 (
¬gv
[1], "on") == 0 ) {

87 
§meReg¿ÁHÜizÚ_
 = 
Œue
;

88 } iàĞ
	`¡rcmp
 (
¬gv
[1], "off") == 0 ) {

89 
§meReg¿ÁHÜizÚ_
 = 
çl£
;

91 
	`årštf
 (
¡d”r
, "invalid„egrant-same-horizon '%s' command. "

92 "Choo£ƒ™h” 'Ú' o¸'off'", 
¬gv
[1]);

93  
TCL_ERROR
;

95  
TCL_OK
;

96 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "regrant-offset") == 0 ) {

97 
»g¿ÁOff£t_
 = (è
	`©oi
 (
¬gv
[1]);

98  
TCL_OK
;

99 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "regrant-duration") == 0 ) {

100 
»g¿ÁDu¿tiÚ_
 = (è
	`©oi
 (
¬gv
[1]);

101  
TCL_OK
;

102 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "dd-timeout") == 0 ) {

103 iàĞ
	`©oi
 (
¬gv
[1]) < 0 ) {

104 
	`årštf
 (
¡d”r
, "Invalid deadlock detectionimeout '%d'. "

106 
	`©oi
 (
¬gv
[1]));

107  
TCL_ERROR
;

109 
ddTimeout_
 = 
	`©oi
 (
¬gv
[1]);

110  
TCL_OK
;

111 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "round-duration") == 0 ) {

112 iàĞ
	`©oi
 (
¬gv
[1]) <= 0 ) {

113 
	`årštf
 (
¡d”r
, "Invalid„ound duration '%d'. "

115 
	`©oi
 (
¬gv
[1]));

116  
TCL_ERROR
;

118 
roundDu¿tiÚ_
 = (è
	`©oi
 (
¬gv
[1]);

119  
TCL_OK
;

120 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "max-deficit") == 0 ) {

121 iàĞ
	`©oi
 (
¬gv
[1]) < 0 ) {

122 
	`årštf
 (
¡d”r
, "Invalid maximum deficit‡mount '%d'. "

124 
	`©oi
 (
¬gv
[1]));

125  
TCL_ERROR
;

128 
maxDefic™_
 = (è
	`©oi
 (
¬gv
[1]);

129  
TCL_OK
;

130 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "min-grant") == 0 ) {

131 iàĞ
	`©oi
 (
¬gv
[1]) < 1 ) {

132 
	`årštf
 (
¡d”r
, "Invalid minimum grant size '%d'. Choose "

134 
	`©oi
 (
¬gv
[1]));

135  
TCL_ERROR
;

138 
mšG¿Á_
 = (è
	`©oi
 (
¬gv
[1]);

139  
TCL_OK
;

140 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "max-backlog") == 0 ) {

141 iàĞ
	`©oi
 (
¬gv
[1]) < 0 ) {

142 
	`årštf
 (
¡d”r
, "Invalid maximum backlog‡mount '%d'. "

144 
	`©oi
 (
¬gv
[1]));

145  
TCL_ERROR
;

148 
maxBacklog_
 = (è
	`©oi
 (
¬gv
[1]);

149  
TCL_OK
;

150 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "fairness") == 0 ) {

151 iàĞ
	`¡rcmp
 (
¬gv
[1], "grant") == 0 ) {

152 
çœG¿Á_
 = 
Œue
;

153 } iàĞ
	`¡rcmp
 (
¬gv
[1], "regrant") == 0 ) {

154 
çœReg¿Á_
 = 
Œue
;

155 } iàĞ
	`¡rcmp
 (
¬gv
[1], "request") == 0 ) {

156 
çœReque¡_
 = 
Œue
;

157 } iàĞ
	`¡rcmp
 (
¬gv
[1], "no") == 0 ) {

158 
çœReque¡_
 = 
çl£
;

159 
çœReg¿Á_
 = 
çl£
;

160 
çœG¿Á_
 = 
çl£
;

162 
	`årštf
 (
¡d”r
, "unknown fairness specifier '%s'. "

163 "Choo£ 'g¿Á', '»g¿Á' o¸'no'\n", 
¬gv
[1]);

164  
TCL_ERROR
;

166  
TCL_OK
;

167 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[0], "grant-fit") == 0 ) {

168 iàĞ
	`¡rcmp
 (
¬gv
[1], "channel" ) == 0 ) {

169 iàĞ
	`¡rcmp
 (
¬gv
[2], "random") == 0 ) {

170 
g¿ÁF™RªdomChªÃl_
 = 
Œue
;

171 } iàĞ
	`¡rcmp
 (
¬gv
[2], "first") == 0 ) {

172 
g¿ÁF™RªdomChªÃl_
 = 
çl£
;

175 
	`årštf
 (
¡d”r
, "unknown grant-fit specifier '%s %s'\n",

176 
¬gv
[1],‡rgv[2]);

177  
TCL_ERROR
;

179  
TCL_OK
;

180 } iàĞ
	`¡rcmp
 (
¬gv
[0], "wm") == 0 ) {

181  
wm_
.
	`commªd
 (
¬gc
 - 1, 
¬gv
 + 1);

184  
TCL_ERROR
;

185 
	}
}

188 
	gWimshBwMªag”FaœRR
::
	$š™Ÿlize
 ()

190 cÚ¡ 
ÃighbÜs
 = 
mac_
->
	`Âeighs
();

193 
Ãigh_
.
	`»size
 (
ÃighbÜs
);

196 
Ãigh_tx_uÇvl_
.
	`»size
 (
ÃighbÜs
);

197  
ngh
 = 0 ;‚gh < 
ÃighbÜs
 ;‚gh++ ) {

198 
Ãigh_tx_uÇvl_
[
ngh
].
	`»size
 (
mac_
->
	`nchªÃls
());

199  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

200 
Ãigh_tx_uÇvl_
[
ngh
][
ch
].
	`»size
 (
HORIZON
);

201  
f
 = 0 ; f < 
HORIZON
 ; f++ )

202 
Ãigh_tx_uÇvl_
[
ngh
][
ch
][
f
].
	`»£t
();

206 
£lf_rx_uÇvl_
.
	`»size
 (
mac_
->
	`nchªÃls
());

207 
£lf_tx_uÇvl_
.
	`»size
 (
mac_
->
	`nchªÃls
());

208  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

209 
£lf_rx_uÇvl_
[
ch
].
	`»size
 (
HORIZON
);

210 
£lf_tx_uÇvl_
[
ch
].
	`»size
 (
HORIZON
);

211  
f
 = 0 ; f < 
HORIZON
 ; f++ ) {

212 
£lf_rx_uÇvl_
[
ch
][
f
].
	`»£t
();

213 
£lf_tx_uÇvl_
[
ch
][
f
].
	`»£t
();

218 
wm_
.
	`š™Ÿlize
 ();

219 
	}
}

222 
	gWimshBwMªag”FaœRR
::
	$»cvMshDsch
 (
WimshMshDsch
* 
dsch
)

224 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::»cvMshDsch"èè
	`årštf
 (
¡d”r
,

225 "%.9àWBWM::»cvMshDsch[%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

227 
	`rcvG¿Ás
(
dsch
);

228 
	`rcvAvaab™›s
(
dsch
);

229 
	`rcvReque¡s
(
dsch
);

230 
	}
}

233 
	gWimshBwMªag”FaœRR
::
	$rcvG¿Ás
 (
WimshMshDsch
* 
dsch
)

236 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
dsch
->
	`¤c
());

241 
Ãigh_
[
ndx
].
rcvCnf_
 = 
Œue
;

244 
¡d
::
li¡
<
WimshMshDsch
::
GÁIE
>& 
gÁ
 = 
dsch
->
	`gÁ
();

246 
¡d
::
li¡
<
WimshMshDsch
::
GÁIE
>::
™”©Ü
 
™
;

247  
™
 = 
gÁ
.
	`begš
(è; iˆ!ğgÁ.
	`’d
() ; ++it ) {

257 iàĞ
™
->
äomReque¡”_
 =ğ
çl£
 && it->
nodeId_
 =ğ
mac_
->
	`nodeId
() ) {

261 
™
->
nodeId_
 = 
dsch
->
	`¤c
();

262 
™
->
äomReque¡”_
 = 
Œue
;

265 
uncÚfœmed_
.
	`push_back
 (*
™
);

269 
äªge
 = 
WimshMshDsch
::
	`³rs2äames
 (
™
->
³rsi¡’û_
);

271 
	`£tSlÙs
 (
uncÚfœmedSlÙs_
, 
™
->
äame_
, 
äªge
,

272 
™
->
¡¬t_
, it->
¿nge_
, 
Œue
);

275 
Ãigh_
[
ndx
].
gÁ_out_
 +=

276 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
™
->
¿nge_
, 
Œue
);

277 
St
::
	`put
 ( "wimsh_gÁ_out", 
mac_
->
	`šdex
(),

278 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
™
->
¿nge_
, 
Œue
) );

282 
Ãigh_
[
ndx
].
gÁ_out_
 =

283 Ğ
Ãigh_
[
ndx
].
gÁ_out_
 <‚eigh_[ndx].
»q_out_
 ) ?

284 
Ãigh_
[
ndx
].
gÁ_out_
 :‚eigh_[ndx].
»q_out_
;

293 iàĞ
™
->
äomReque¡”_
 =ğ
çl£
 && it->
nodeId_
 !ğ
mac_
->
	`nodeId
() ) {

299 
WimshMshDsch
::
AvlIE
 
avl
;

300 
avl
.
äame_
 = 
™
->frame_;

301 
avl
.
¡¬t_
 = 
™
->start_;

302 
avl
.
¿nge_
 = 
™
->range_;

303 
avl
.
dœeùiÚ_
 = 
WimshMshDsch
::
UNAVAILABLE
;

304 
avl
.
³rsi¡’û_
 = 
™
->persistence_;

305 
avl
.
chªÃl_
 = 
™
->channel_;

308 
avaab™›s_
.
	`push_back
 (
avl
);

318 
äªge
 = 
WimshMshDsch
::
	`³rs2äames
 (
™
->
³rsi¡’û_
);

321  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

322 
	`£tSlÙs
 (
Ãigh_tx_uÇvl_
[
ndx
][
ch
], 
™
->
äame_
, 
äªge
,

323 
™
->
¡¬t_
, it->
¿nge_
, 
Œue
);

332 iàĞ
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
 (
™
->
nodeId_
, mac_->
	`nodeId
()) ) {

334 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
™
->
nodeId_
);

337  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

338 
	`£tSlÙs
 (
Ãigh_tx_uÇvl_
[
ndx
][
ch
], 
™
->
äame_
, 
äªge
,

339 
™
->
¡¬t_
, it->
¿nge_
, 
Œue
);

350 
¡d
::
veùÜ
<
WimaxNodeId
> 
gÁNeigh
;

351 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
 (
dsch
->
	`¤c
(), 
gÁNeigh
);

352  
ngh
 = 0 ;‚gh < 
gÁNeigh
.
	`size
() ;‚gh++ ) {

356 iàĞ
gÁNeigh
[
ngh
] =ğ
™
->
nodeId_
 ||

357 ! 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
 (
gÁNeigh
[
ngh
], mac_->
	`nodeId
()) )

361 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
gÁNeigh
[
ngh
]);

362 
	`£tSlÙs
 (
Ãigh_tx_uÇvl_
[
ndx
][
™
->
chªÃl_
],

363 
™
->
äame_
, 
äªge
, it->
¡¬t_
, it->
¿nge_
, 
Œue
);

370 
	`£tSlÙs
 (
£lf_tx_uÇvl_
[
™
->
chªÃl_
],

371 
™
->
äame_
, 
äªge
, it->
¡¬t_
, it->
¿nge_
, 
Œue
);

383 iàĞ
™
->
äomReque¡”_
 =ğ
Œue
 &&

384 ! 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
 (
™
->
nodeId_
, mac_->
	`nodeId
()) ) {

387 
f¡¬t
;

388 
äªge
;

389 
	`»®P”si¡’û
 (
™
->
äame_
, it->
³rsi¡’û_
, 
f¡¬t
, 
äªge
);

392  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

393 
	`£tSlÙs
 (
Ãigh_tx_uÇvl_
[
ndx
][
ch
], 
f¡¬t
, 
äªge
,

394 
™
->
¡¬t_
, it->
¿nge_
, 
Œue
);

398 
	`£tSlÙs
 (
£lf_rx_uÇvl_
[
™
->
chªÃl_
], 
f¡¬t
, 
äªge
,

399 
™
->
¡¬t_
, it->
¿nge_
, 
Œue
);

405 iàĞ
™
->
äomReque¡”_
 =ğ
Œue
 && it->
nodeId_
 =ğ
mac_
->
	`nodeId
() ) {

408 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
dsch
->
	`¤c
());

413 
äªge
 = 
WimshMshDsch
::
	`³rs2äames
 (
™
->
³rsi¡’û_
);

416 
	`£tSlÙs
 (
chªÃl_
, 
™
->
äame_
, 
äªge
,

417 
™
->
¡¬t_
, it->
¿nge_
, it->
chªÃl_
);

420 
Ãigh_
[
ndx
].
úf_š_
 +=

421 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
™
->
¿nge_
, 
Œue
);

422 
St
::
	`put
 ( "wimsh_úf_š", 
mac_
->
	`šdex
(),

423 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
™
->
¿nge_
, 
Œue
) );

427 
	}
}

430 
	gWimshBwMªag”FaœRR
::
	$rcvAvaab™›s
 (
WimshMshDsch
* 
dsch
)

433 
¡d
::
li¡
<
WimshMshDsch
::
AvlIE
>& 
avl
 = 
dsch
->
	`avl
();

436 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
dsch
->
	`¤c
());

438 
¡d
::
li¡
<
WimshMshDsch
::
AvlIE
>::
™”©Ü
 
™
;

439  
™
 = 
avl
.
	`begš
(è; iˆ!ğavl.
	`’d
() ; ++it ) {

442 iàĞ
™
->
dœeùiÚ_
 =ğ
WimshMshDsch
::
TX_ONLY
 ) ;

445 
f¡¬t
;

446 
äªge
;

447 
	`»®P”si¡’û
 (
™
->
äame_
, it->
³rsi¡’û_
, 
f¡¬t
, 
äªge
);

450 
	`£tSlÙs
 (
Ãigh_tx_uÇvl_
[
ndx
][
™
->
chªÃl_
],

451 
f¡¬t
, 
äªge
, 
™
->
¡¬t_
, it->
¿nge_
,

452 Ğ
™
->
dœeùiÚ_
 =ğ
WimshMshDsch
::
AVAILABLE
 ) ? 
çl£
 : 
Œue
);

454 
	}
}

457 
	gWimshBwMªag”FaœRR
::
	$rcvReque¡s
 (
WimshMshDsch
* 
dsch
)

460 
¡d
::
li¡
<
WimshMshDsch
::
ReqIE
>& 
»q
 = 
dsch
->
	`»q
();

463 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
dsch
->
	`¤c
());

465 
¡d
::
li¡
<
WimshMshDsch
::
ReqIE
>::
™”©Ü
 
™
;

466  
™
 = 
»q
.
	`begš
(è; iˆ!ğ»q.
	`’d
() ; ++it ) {

469 iàĞ
™
->
nodeId_
 !ğ
mac_
->
	`nodeId
() ) ;

472 
wm_
.
	`æow
 (
ndx
, 
wimax
::
IN
);

475 
»que¡ed
 =

476 
WimshMshDsch
::
	`³rs2äames
 (
™
->
³rsi¡’û_
)

477 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
™
->
Ëv–_
, 
çl£
);

482 
Ãigh_
[
ndx
].
»q_š_
 +ğ
»que¡ed
;

483 
St
::
	`put
 ("wimsh_»q_š", 
mac_
->
	`šdex
(), 
»que¡ed
);

486 iàĞ
Ãigh_
[
ndx
].
»q_š_
 >‚eigh_[ndx].
gÁ_š_
 &&

487 ! 
aùiveLi¡_
.
	`fšd
 (
wimax
::
	`LškId
(
ndx
, wimax::
IN
)) )

488 
aùiveLi¡_
.
	`š£¹
 (
wimax
::
	`LškId
(
ndx
, wimax::
IN
));

490 
	}
}

493 
	gWimshBwMªag”FaœRR
::
	$scheduË
 (
WimshMshDsch
* 
dsch
)

495 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::schedule") ) {

496 
	`årštf
 (
¡d”r
, "%.9àWBWM::scheduË [%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

497 
	`´štD©aSŒuùu»s
 (
¡d”r
);

501 iàĞ
avlAdv”ti£_
 ) 
	`avaab™›s
 (
dsch
);

504 
	`cÚfœm
 (
dsch
);

507 iàĞ
»g¿ÁEÇbËd_
 ) 
	`»g¿Á
 (
dsch
);

510 
	`»que¡G¿Á
 (
dsch
);

511 
	}
}

514 
	gWimshBwMªag”FaœRR
::
	$avaab™›s
 (
WimshMshDsch
* 
dsch
)

518  ! 
avaab™›s_
.
	`em±y
() ) {

521 iàĞ
dsch
->
	`»maššg
(è< 
WimshMshDsch
::
AvlIE
::
	`size
() ) ;

522 
WimshMshDsch
::
AvlIE
 
avl
 = 
avaab™›s_
.
	`äÚt
();

523 
avaab™›s_
.
	`pİ_äÚt
();

528 iàĞ
mac_
->
	`äame
() <=

529 
avl
.
äame_
 + 
WimshMshDsch
::
	`³rs2äames
 (avl.
³rsi¡’û_
) ) {

530 
dsch
->
	`add
 (
avl
);

533 
	}
}

536 
	gWimshBwMªag”FaœRR
::
	$»que¡G¿Á
 (
WimshMshDsch
* 
dsch
)

539 
H¦f
 = 
	`hªdshake
 (
mac_
->
	`nodeId
());

562 
»qIeOccu·ncy
 = 0;

565 
¡d
::
veùÜ
<
boŞ
> 
	`ÃighReq
 (
mac_
->
	`Âeighs
(), 
çl£
);

568 
¡d
::
veùÜ
<> 
	`ÃighReqBy‹s
 (
mac_
->
	`Âeighs
(), 0);

572 
¡d
::
veùÜ
<> 
	`ÃighReqMax
 (
mac_
->
	`Âeighs
());

573  
i
 = 0 ; i < 
mac_
->
	`Âeighs
() ; i++ ) {

574 
ÃighReqMax
[
i
] =

575 
mac_
->
	`phyMib
()->
	`¦ÙP”F¿me
()

576 * 
mac_
->
	`phyMib
()->
	`symP”SlÙ
 ()

577 * 
WimshMshDsch
::
	`³rs2äames
 (WimshMshDsch::
FRAME128
)

578 * 
mac_
->
	`®pha
 (
i
);

583 
¡d
::
veùÜ
<
g¿ÁF™Desc
> 
	`g¿ÁF™Stus
 (
mac_
->
	`Âeighs
());

604 
š–igibË
 = 0;

605 
boŞ
 
š–igibËV®id
 = 
çl£
;

608 iàĞ
defic™Ov”æow_
 ) ++
ddTim”_
;

610  ! 
aùiveLi¡_
.
	`em±y
() ) {

613 cÚ¡ 
ndx
 = 
aùiveLi¡_
.
	`cu¼’t
().
ndx_
;

614 cÚ¡ 
d¡
 = 
mac_
->
	`ndx2Ãigh
 (
ndx
);

615 cÚ¡ 
wimax
::
LškDœeùiÚ
 
dœ
 = 
aùiveLi¡_
.
	`cu¼’t
().
dœ_
;

618 iàĞ
š–igibËV®id
 && 
š–igibË
 =ğ
ndx
 ) ;

624 iàĞ
dœ
 =ğ
wimax
::
IN
 ) {

627 iàĞ
dsch
->
	`»maššg
(è- 
»qIeOccu·ncy
 < 
WimshMshDsch
::
GÁIE
::
	`size
() )

631 
Hd¡
 = 
	`hªdshake
 (
d¡
);

634 & 
defic™
 = 
Ãigh_
[
ndx
].
def_š_
;

635 & 
g¿Áed
 = 
Ãigh_
[
ndx
].
gÁ_š_
;

636 & 
»que¡ed
 = 
Ãigh_
[
ndx
].
»q_š_
;

639 iàĞ! 
defic™Ov”æow_
 ) 
defic™
 +ğ
	`quªtum
 (
ndx
, 
wimax
::
IN
);

640 
defic™Ov”æow_
 = 
çl£
;

643 
defic™
 =

644 Ğ! 
çœG¿Á_
 && 
maxDefic™_
 > 0 && 
defic™
 > maxDeficit_ )

645 ? 
maxDefic™_
 : 
defic™
;

648 
³ndšg
 = 
»que¡ed
 - 
g¿Áed
;

651 
defic™
 = ( defic™ > 
³ndšg
 ) ?…ending : deficit;

659  
dsch
->
	`»maššg
(è- 
»qIeOccu·ncy


660 >ğ
WimshMshDsch
::
GÁIE
::
	`size
() &&

661 
defic™
 > 0 ) {

664 
WimshMshDsch
::
GÁIE
 
gÁ
;

667 
gÁ
 = 
	`g¿ÁF™
 (
ndx
,

668 
defic™
,

669 
mac_
->
	`äame
(è+ 
Hd¡
,

670 
mac_
->
	`äame
(è+ 2 * 
Hd¡
 + 
H¦f
,

671 
g¿ÁF™Stus
[
ndx
]);

675 iàĞ
gÁ
.
¿nge_
 == 0 ) ;

678 
St
::
	`put
 ("wimsh_gÁ_size", 
mac_
->
	`šdex
(), 
gÁ
.
¿nge_
);

681 
dsch
->
	`add
 (
gÁ
);

684 
äªge
 = 
WimshMshDsch
::
	`³rs2äames
 (
gÁ
.
³rsi¡’û_
);

687 
bgÁ
 =

688 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
gÁ
.
¿nge_
, 
Œue
);

695 
defic™
 = ( defic™ > 
bgÁ
 ) ? ( deficit - bgnt ) : 0;

698 
g¿Áed
 +ğ
bgÁ
;

699 
St
::
	`put
 ("wimsh_gÁ_š", 
mac_
->
	`šdex
(), 
bgÁ
);

702 
	`£tSlÙs
 (
busy_
, 
gÁ
.
äame_
, 
äªge
,

703 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, 
Œue
);

709 iàĞ
çœG¿Á_
 && ( 
defic™
 > 
maxDefic™_
 ) ) {

710 
defic™Ov”æow_
 = 
Œue
;

716 iàĞ! 
š–igibËV®id
 && 
defic™
 > 0 ) {

718 
š–igibËV®id
 = 
Œue
;

719 
š–igibË
 = 
ndx
;

724 iàĞ
g¿Áed
 >ğ
»que¡ed
 ) {

725 
defic™
 = 0;

726 
aùiveLi¡_
.
	`”a£
();

730 
aùiveLi¡_
.
	`move
 ();

740 & 
defic™
 = 
Ãigh_
[
ndx
].
def_out_
;

741 & 
backlog
 = 
Ãigh_
[
ndx
].
backlog_
;

742 & 
cÚfœmed
 = 
Ãigh_
[
ndx
].
úf_out_
;

743 & 
»que¡ed
 = 
Ãigh_
[
ndx
].
»q_out_
;

744 & 
g¿Áed
 = 
Ãigh_
[
ndx
].
gÁ_out_
;

753 
³ndšg
 =

754 Ğ
backlog
 > 
»que¡ed
 ) ? ( backlog -„equested ) : 0;

757 
ung¿Áed
 =

758 Ğ
»que¡ed
 > 
g¿Áed
 ) ? („equested - granted ) : 0;

761 iàĞ
dsch
->
	`»maššg
(è- 
»qIeOccu·ncy
 < 
WimshMshDsch
::
ReqIE
::
	`size
() )

765 iàĞ! 
defic™Ov”æow_
 ) 
defic™
 +ğ
	`quªtum
 (
ndx
, 
wimax
::
OUT
);

766 
defic™Ov”æow_
 = 
çl£
;

769 
defic™
 =

770 Ğ! 
çœReque¡_
 && 
maxDefic™_
 > 0 && 
defic™
 > maxDeficit_ )

771 ? 
maxDefic™_
 : 
defic™
;

775 
defic™
 = ( defic™ > 
³ndšg
 ) ?…ending : deficit;

779 iàĞ
maxBacklog_
 > 0 && 
ung¿Áed
 > maxBacklog_ ) {

784 iàĞ
ddTimeout_
 > 0 && 
ddTim”_
 >= ddTimeout_ ) {

787 
St
::
	`put
 ("wimsh_dd_timeout", 
mac_
->
	`šdex
(), 1.0);

790 
ddTim”_
 = 0;

791 
defic™Ov”æow_
 = 
çl£
;

795 
g¿Áed
 = 0;

796 
defic™
 = 0;

797 
cÚfœmed
 = 0;

798 
»que¡ed
 = 0;

804 iàĞ
çœReque¡_
 && 
defic™
 > 
maxDefic™_
 ) {

805 
defic™Ov”æow_
 = 
Œue
;

810 iàĞ! 
š–igibËV®id
 ) {

811 
š–igibËV®id
 = 
Œue
;

812 
š–igibË
 = 
ndx
;

816 
aùiveLi¡_
.
	`move
();

821 iàĞ
ddTimeout_
 > 0 ) 
ddTim”_
 = 0;

825 iàĞ
ÃighReq
[
ndx
] =ğ
çl£
 )

826 
»qIeOccu·ncy
 +ğ
WimshMshDsch
::
ReqIE
::
	`size
();

829 
ÃighReq
[
ndx
] = 
Œue
;

832 
ÃighReqBy‹s
[
ndx
] +ğ
defic™
;

838  
ÃighReqBy‹s
[
ndx
] > 
ÃighReqMax
[ndx] ) {

843 
WimshMshDsch
::
ReqIE
 
›
;

844 
›
.
nodeId_
 = 
mac_
->
	`ndx2Ãigh
 (
ndx
);

845 
›
.
Ëv–_
 = 
WimshMshDsch
::
FRAME128
;

848 
ÃighReqBy‹s
[
ndx
] -ğ
ÃighReqMax
[ndx];

851 
dsch
->
	`add
 (
›
);

855 
»que¡ed
 +ğ
defic™
;

856 
St
::
	`put
 ("wimsh_»q_out", 
mac_
->
	`šdex
(), 
defic™
);

862 
defic™
 = 0;

866 iàĞ
³ndšg
 == 0 ) {

869 
aùiveLi¡_
.
	`”a£
();

873 
aùiveLi¡_
.
	`move
();

882  
ndx
 = 0 ;‚dx < 
mac_
->
	`Âeighs
() ;‚dx++ ) {

883 iàĞ
ÃighReqBy‹s
[
ndx
] == 0 ) ;

886 
WimshMshDsch
::
ReqIE
 
›
;

887 
›
.
nodeId_
 = 
mac_
->
	`ndx2Ãigh
 (
ndx
);

894 
WimshMshDsch
::
	`¦Ùs2Ëv–
 (

895 
mac_
->
	`phyMib
()->
	`¦ÙP”F¿me
(),

896 
mac_
->
	`by‹s2¦Ùs
 (
ndx
, 
ÃighReqBy‹s
[ndx], 
çl£
),

897 
›
.
Ëv–_
, ie.
³rsi¡’û_
);

900 
dsch
->
	`add
 (
›
);

902 
	}
}

905 
	gWimshBwMªag”FaœRR
::
	$»g¿Á
 (
WimshMshDsch
* 
dsch
)

908 
H¦f
 = 
	`hªdshake
 (
mac_
->
	`nodeId
());

918 
¡d
::
veùÜ
<> 
uncÚfBy‹s
;

919 
uncÚfBy‹s
.
	`»size
 (
mac_
->
	`Âeighs
());

921  
i
 = 0 ; i < 
mac_
->
	`Âeighs
() ; i++ ) {

929 
uncÚfBy‹s
[
i
] =

930 Ğ
Ãigh_
[
i
].
rcvCnf_
 &&‚eigh_[i].
gÁ_š_
 >ğÃigh_[i].
úf_š_
 )

931 ? 
Ãigh_
[
i
].
gÁ_š_
 -‚eigh_[i].
úf_š_
 : 0;

933 iàĞ
uncÚfBy‹s
[
i
] > 0 && ! 
»gÁAùiveLi¡_
.
	`fšd
 (i) )

934 
»gÁAùiveLi¡_
.
	`š£¹
 (
i
);

937 
Ãigh_
[
i
].
rcvCnf_
 = 
çl£
;

942 
¡d
::
veùÜ
<
g¿ÁF™Desc
> 
	`g¿ÁF™Stus
 (
mac_
->
	`Âeighs
());

951  
dsch
->
	`»maššg
(è>ğ
WimshMshDsch
::
GÁIE
::
	`size
() &&

952 ! 
»gÁAùiveLi¡_
.
	`em±y
() ) {

955 cÚ¡ 
ndx
 = 
»gÁAùiveLi¡_
.
	`cu¼’t
();

958 cÚ¡ 
WimaxNodeId
 
d¡
 = 
mac_
->
	`ndx2Ãigh
 (
ndx
);

961 
Hd¡
 = 
	`hªdshake
 (
d¡
);

964 
WimshMshDsch
::
GÁIE
 
gÁ
;

967 
hÜizÚLow
 = 
mac_
->
	`äame
();

968 
hÜizÚHigh
;

969 iàĞ
§meReg¿ÁHÜizÚ_
 ) {

970 
hÜizÚLow
 +ğ
Hd¡
;

971 
hÜizÚHigh
 = 
hÜizÚLow
 + 
Hd¡
 + 
H¦f
;

973 
hÜizÚLow
 +ğ2 * 
Hd¡
 + 
H¦f
 + 
»g¿ÁOff£t_
;

974 
hÜizÚHigh
 = 
hÜizÚLow
 + ( 
Hd¡
 + 
H¦f
 ) * 
»g¿ÁDu¿tiÚ_
;

978 
gÁ
 = 
	`g¿ÁF™
 (
ndx
,

979 
uncÚfBy‹s
[
ndx
],

980 
hÜizÚLow
,

981 
hÜizÚHigh
,

982 
g¿ÁF™Stus
[
ndx
]);

986 iàĞ
gÁ
.
¿nge_
 == 0 ) {

989 iàĞ
çœReg¿Á_
 ) ;

992 
»gÁAùiveLi¡_
.
	`”a£
 ();

997 
äªge
 = 
WimshMshDsch
::
	`³rs2äames
 (
gÁ
.
³rsi¡’û_
);

1000 
dsch
->
	`add
 (
gÁ
);

1003 
uncÚfBy‹s
[
ndx
] -ğ
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (ndx, 
gÁ
.
¿nge_
, 
Œue
);

1004 
St
::
	`put
 ( "wimsh_»gÁ_š", 
mac_
->
	`šdex
(),

1005 
äªge
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
gÁ
.
¿nge_
, 
Œue
) );

1008 iàĞ
uncÚfBy‹s
[
ndx
] == 0 ) {

1009 
»gÁAùiveLi¡_
.
	`”a£
();

1014 
	`£tSlÙs
 (
busy_
, 
gÁ
.
äame_
, 
äªge
,

1015 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, 
Œue
);

1018 
»gÁAùiveLi¡_
.
	`move
();

1020 
	}
}

1023 
	gWimshBwMªag”FaœRR
::
	$cÚfœm
 (
WimshMshDsch
* 
dsch
)

1027  ! 
uncÚfœmed_
.
	`em±y
() ) {

1031 iàĞ
dsch
->
	`»maššg
(è< 
WimshMshDsch
::
GÁIE
::
	`size
() ) ;

1034 
WimshMshDsch
::
GÁIE
 
gÁ
 = 
uncÚfœmed_
.
	`äÚt
();

1035 
uncÚfœmed_
.
	`pİ_äÚt
();

1043 
f¡¬t
;

1044 
äªge
;

1047 
	`»®P”si¡’û
 (
gÁ
.
äame_
, gÁ.
³rsi¡’û_
, 
f¡¬t
, 
äªge
);

1050 
m¡¬t
 = 
gÁ
.
¡¬t_
;

1051 
m¿nge
 = 
gÁ
.
¿nge_
;

1054 
cÚfœmed
 = 0;

1057 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
gÁ
.
nodeId_
);

1060  
dsch
->
	`»maššg
(è>ğ
WimshMshDsch
::
GÁIE
::
	`size
() ) {

1063 
	`cÚfF™
 (
f¡¬t
, 
äªge
, 
m¡¬t
, 
m¿nge
, 
gÁ
);

1066 iàĞ
gÁ
.
¿nge_
 == 0 ) ;

1069 
St
::
	`put
 ("wimsh_úf_size", 
mac_
->
	`šdex
(), 
gÁ
.
¿nge_
);

1072 
dsch
->
	`add
 (
gÁ
);

1075 
fs
;

1076 
ä
;

1077 
	`»®P”si¡’û
 (
gÁ
.
äame_
, gÁ.
³rsi¡’û_
, 
fs
, 
ä
);

1080 
cÚfœmed
 +ğ
ä
 * 
mac_
->
	`¦Ùs2by‹s
 (
ndx
, 
gÁ
.
¿nge_
, 
Œue
);

1083 
	`£tSlÙs
 (
busy_
, 
fs
, 
ä
, 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, 
Œue
);

1084 
	`£tSlÙs
 (
g¿Ás_
, 
fs
, 
ä
, 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, 
Œue
);

1085 
	`£tSlÙs
 (
d¡_
, 
fs
, 
ä
, 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, gÁ.
nodeId_
);

1086 
	`£tSlÙs
 (
chªÃl_
, 
fs
, 
ä
, 
gÁ
.
¡¬t_
, gÁ.
¿nge_
, gnt.channel_);

1090 
Ãigh_
[
ndx
].
úf_out_
 +ğ
cÚfœmed
;

1091 
St
::
	`put
 ("wimsh_úf_out", 
mac_
->
	`šdex
(), 
cÚfœmed
);

1095 
Ãigh_
[
ndx
].
úf_out_
 =

1096 Ğ
Ãigh_
[
ndx
].
úf_out_
 <‚eigh_[ndx].
gÁ_out_
 ) ?

1097 
Ãigh_
[
ndx
].
úf_out_
 :‚eigh_[ndx].
gÁ_out_
;

1100 iàĞ
Ãigh_
[
ndx
].
»q_out_
 <‚eigh_[ndx].
úf_out_
 ) 
	`abÜt
();

1101 
Ãigh_
[
ndx
].
gÁ_out_
 -ğÃigh_[ndx].
úf_out_
;

1102 
Ãigh_
[
ndx
].
»q_out_
 -ğÃigh_[ndx].
úf_out_
;

1103 
Ãigh_
[
ndx
].
úf_out_
 = 0;

1106 
	}
}

1109 
	gWimshBwMªag”FaœRR
::
	$šv®id©e
 (
F
)

1113 cÚ¡ 
unu£d
 =

1114 
mac_
->
	`phyMib
()->
	`¦ÙP”F¿me
(è- 
busy_
[
F
].
	`couÁ
();

1115 
St
::
	`put
 ("wimsh_unu£d_a", 
mac_
->
	`šdex
(), 
unu£d
);

1116 
St
::
	`put
 ("wimsh_unu£d_d", 
mac_
->
	`šdex
(), 
unu£d
);

1118 iàĞ
WimaxDebug
::
	`Œaû
("WBWM::šv®id©e"èè
	`årštf
 (
¡d”r
,

1119 "%.9àWBWM::šv®id©[%d] unu£d %d\n", 
NOW
, 
mac_
->
	`nodeId
(), 
unu£d
);

1122  
ngh
 = 0 ;‚gh < 
mac_
->
	`Âeighs
() ;‚gh++) {

1123  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

1124 
Ãigh_tx_uÇvl_
[
ngh
][
ch
][
F
].
	`»£t
();

1127  
ch
 = 0 ; ch < 
mac_
->
	`nchªÃls
() ; ch++ ) {

1128 
£lf_rx_uÇvl_
[
ch
][
F
].
	`»£t
();

1129 
£lf_tx_uÇvl_
[
ch
][
F
].
	`»£t
();

1131 
busy_
[
F
].
	`»£t
();

1132 
uncÚfœmedSlÙs_
[
F
].
	`»£t
();

1133 
WimshBwMªag”
::
	`šv®id©e
 (
F
);

1134 
	}
}

1137 
	gWimshBwMªag”FaœRR
::
»®P”si¡’û
 (

1138 
¡¬t
, 
WimshMshDsch
::
P”si¡’û
 
³rs
,

1139 & 
»®S¹
, & 
¿nge
)

1141 
	g¿nge
 = 
WimshMshDsch
::
³rs2äames
 (
³rs
);

1145 
	g¿nge
 -ğĞ
¡¬t
 >ğ
mac_
->
äame
() ) ? 0 : ( mac_->frame() - start );

1147 iàĞ
	g¿nge
 < 0 )„ange = 0;

1150 
	g»®S¹
 = ( 
¡¬t
 >ğ
mac_
->
äame
() ) ? start : mac_->frame();

1157 
	gWimshMshDsch
::
GÁIE


1158 
WimshBwMªag”FaœRR
::
	$g¿ÁF™
 (

1159 
ndx
, 
by‹s
,

1160 
mšF¿me
, 
maxF¿me
,

1161 
g¿ÁF™Desc
& 
¡©us
)

1164 
WimshMshDsch
::
GÁIE
 
gÁ
;

1165 
gÁ
.
nodeId_
 = 
mac_
->
	`ndx2Ãigh
 (
ndx
);

1168 
N
 = 
mac_
->
	`phyMib
()->
	`¦ÙP”F¿me
();

1171 
C
 = 
mac_
->
	`nchªÃls
();

1237  
f
 = 
mšF¿me
 ; f <ğ
maxF¿me
 ; f++ ) {

1239 
F
 = 
f
 % 
HORIZON
;

1242 
ch
 = 0;

1243 iàĞ
g¿ÁF™RªdomChªÃl_
 ) 
ch
 = 
g¿ÁF™Rng
.
	`unifÜm
 (()
C
);

1246  
c
 = 0 ; c < 
C
 ; c++ ) {

1249 
¡d
::
b™£t
<
MAX_SLOTS
> 
m­
 =

1250 
uncÚfœmedSlÙs_
[
F
] | 
busy_
[F] |

1251 
£lf_rx_uÇvl_
[
ch
][
F
] | 
Ãigh_tx_uÇvl_
[
ndx
][ch][F];

1254  
s
 = 0 ; s < 
N
 ; s++ ) {

1257 iàĞ
m­
[
s
] =ğ
çl£
 ) {

1258 
gÁ
.
äame_
 = 
f
;

1259 
gÁ
.
¡¬t_
 = 
s
;

1260 
gÁ
.
³rsi¡’û_
 = 
WimshMshDsch
::
FRAME1
;

1261 
gÁ
.
äomReque¡”_
 = 
çl£
;

1262 
gÁ
.
chªÃl_
 = 
ch
;

1265 
maxSlÙs
 = 
mac_
->
	`by‹s2¦Ùs
 (
ndx
, 
by‹s
, 
Œue
);

1266  ; 
s
 < 
N
 && 
m­
[s] =ğ
çl£
 &&

1267 Ğ
s
 - 
gÁ
.
¡¬t_
 ) < 
maxSlÙs
 ; s++ ) { }

1269 
gÁ
.
¿nge_
 = 
s
 - gÁ.
¡¬t_
;

1273 
symbŞs
 =

1274 
gÁ
.
¿nge_
 * 
mac_
->
	`phyMib
()->
	`symP”SlÙ
()

1275 - 
mac_
->
	`phyMib
()->
	`symShÜtP»ambË
();

1277 iàĞ
gÁ
.
¿nge_
 !ğ
maxSlÙs
 && 
symbŞs
 < 
mšG¿Á_
 )

1280  
gÁ
;

1285 
ch
 = ( ch + 1 ) % 
C
;

1291 
gÁ
.
¿nge_
 = 0;

1292  
gÁ
;

1293 
	}
}

1300 
	gWimshBwMªag”FaœRR
::
cÚfF™
 (

1301 
f¡¬t
, 
äªge
,

1302 
m¡¬t
, 
m¿nge
,

1303 
WimshMshDsch
::
GÁIE
& 
gÁ
)

1306  
f
 = 
f¡¬t
 ; 
	gf
 < 
	gf¡¬t
 + 
	gäªge
 ; f++ ) {

1307 
	gF
 = 
f
 % 
HORIZON
;

1309 cÚ¡ 
	g¡d
::
b™£t
<
MAX_SLOTS
> 
m­
 =

1310 
busy_
[
F
] | 
£lf_tx_uÇvl_
[
gÁ
.
chªÃl_
][F];

1313  
	gs
 = 
m¡¬t
 ; s < 
	gm¡¬t
 + 
	gm¿nge
 ; s++ ) {

1316 iàĞ
	gm­
[
s
] =ğ
çl£
 ) {

1317 
gÁ
.
äame_
 = 
f
;

1318 
	ggÁ
.
	g¡¬t_
 = 
s
;

1319 
	ggÁ
.
	g³rsi¡’û_
 = 
WimshMshDsch
::
FRAME1
;

1322  ; 
	gs
 < ( 
	gm¡¬t
 + 
	gm¿nge
 ) && 
	gm­
[
s
] =ğ
çl£
 ; s++ ) { }

1324 
	ggÁ
.
	g¿nge_
 = 
s
 - 
gÁ
.
¡¬t_
;

1331 
	ggÁ
.
	g¿nge_
 = 0;

1335 
	gWimshBwMªag”FaœRR
::
	$backlog
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
,

1336 
´io
, 
WimaxNodeId
 
Ãxthİ
, 
by‹s
)

1339 
wm_
.
	`æow
 (
¤c
, 
d¡
, 
´io
, 
mac_
->
	`Ãigh2ndx
(
Ãxthİ
), 
wimax
::
OUT
);

1342 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
(
Ãxthİ
);

1345 
Ãigh_
[
ndx
].
backlog_
 +ğ
by‹s
;

1348 iàĞ! 
aùiveLi¡_
.
	`fšd
 (
wimax
::
	`LškId
(
ndx
, wimax::
OUT
)) )

1349 
aùiveLi¡_
.
	`š£¹
 (
wimax
::
	`LškId
(
ndx
, wimax::
OUT
));

1350 
	}
}

1353 
	gWimshBwMªag”FaœRR
::
	$backlog
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
)

1356 
wm_
.
	`æow
 (
mac_
->
	`Ãigh2ndx
(
Ãxthİ
), 
wimax
::
OUT
);

1359 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
(
Ãxthİ
);

1362 
Ãigh_
[
ndx
].
backlog_
 +ğ
by‹s
;

1365 iàĞ! 
aùiveLi¡_
.
	`fšd
 (
wimax
::
	`LškId
(
ndx
, wimax::
OUT
)) )

1366 
aùiveLi¡_
.
	`š£¹
 (
wimax
::
	`LškId
(
ndx
, wimax::
OUT
));

1367 
	}
}

1370 
	gWimshBwMªag”FaœRR
::
	$£Á
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
)

1373 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
(
Ãxthİ
);

1376 
Ãigh_
[
ndx
].
backlog_
 -ğ
by‹s
;

1377 
	}
}

1380 
	gWimshBwMªag”FaœRR
::
	$´štD©aSŒuùu»s
 (
FILE
* 
os
)

1382 
	`årštf
 (
os
, "\tDATA STRUCTURES\n");

1383  
i
 = 0 ; i < 
mac_
->
	`Âeighs
() ; i++ ) {

1384 
	`årštf
 (
os
, "\t%d in %d„eq %d gnt %d cnf %d def %d w %f q %d\n",

1385 
i
, 
mac_
->
	`ndx2Ãigh
(i),

1386 
Ãigh_
[
i
].
»q_š_
,‚eigh_[i].
gÁ_š_
,‚eigh_[i].
úf_š_
,

1387 
Ãigh_
[
i
].
def_š_
, 
wm_
.
	`weight
 (i, 
wimax
::
IN
),

1388 
	`quªtum
 (
i
, 
wimax
::
IN
) );

1389 
	`årštf
 (
os
, "\t%d out %d„eq %d gnt %d cnf %d def %d w %f "

1391 
i
, 
mac_
->
	`ndx2Ãigh
(i),

1392 
Ãigh_
[
i
].
»q_out_
,‚eigh_[i].
gÁ_out_
,‚eigh_[i].
úf_out_
,

1393 
Ãigh_
[
i
].
def_out_
, 
wm_
.
	`weight
 (i, 
wimax
::
OUT
),

1394 
	`quªtum
 (
i
, 
wimax
::
OUT
), 
Ãigh_
[i].
backlog_
);

1396 
	`årštf
 (
os
, "\tREQUEST/GRANTING ACTIVE-LIST\n");

1397 
WimaxDebug
::
	`´št
 (
aùiveLi¡_
, 
os
, "\t");

1398 
	`årštf
 (
os
, "\tUNCONFIRMED ACTIVE-LIST\n");

1399 
WimaxDebug
::
	`´št
 (
»gÁAùiveLi¡_
, 
os
, "\t");

1400 
	}
}

	@wimsh_bwmanager_frr.h

20 #iâdeà
__NS2_WIMSH_BW_MANAGER_FRR_H


21 
	#__NS2_WIMSH_BW_MANAGER_FRR_H


	)

23 
	~<wimsh_weight_mªag”.h
>

24 
	~<wimsh_bwmªag”.h
>

25 
	~<wimsh_·ck‘.h
>

26 
	~<wimsh_mac.h
>

28 
	~<ºg.h
>

34 şas 
	cWimshBwMªag”FaœRR
 : 
public
 
WimshBwMªag”
 {

36 
¡d
::
	tveùÜ
< 
	t¡d
::
	tb™£t
<
	tMAX_SLOTS
> > 
	tB™m­
;

38 
	m´Ùeùed
:

40 
	sg¿ÁF™Desc
 {

42 
boŞ
 
fœ¡
;

44 
	mchSum
;

46 
	mch
;

48 
g¿ÁF™Desc
 (è: 
fœ¡
 (
Œue
) { }

52 
	sNeighDesc
 {

57 
	g»q_š_
;

62 
	ggÁ_š_
;

67 
	gúf_š_
;

73 
	g»q_out_
;

78 
	ggÁ_out_
;

83 
	gúf_out_
;

86 
boŞ
 
	grcvCnf_
;

94 
	gbacklog_
;

102 
	gdef_š_
;

110 
	gdef_out_
;

113 
NeighDesc
 () {

114 
	g»q_š_
 = 0;

115 
	g»q_out_
 = 0;

116 
	ggÁ_š_
 = 0;

117 
	ggÁ_out_
 = 0;

118 
	gúf_š_
 = 0;

119 
	gúf_out_
 = 0;

120 
	grcvCnf_
 = 
çl£
;

121 
	gbacklog_
 = 0;

122 
	gdef_š_
 = 0;

123 
	gdef_out_
 = 0;

128 
	g¡d
::
veùÜ
<
NeighDesc
> 
Ãigh_
;

131 
	gCœcuÏrLi¡
<
	gwimax
::
LškId
> 
aùiveLi¡_
;

134 
	gCœcuÏrLi¡
<> 
	g»gÁAùiveLi¡_
;

154 
	g¡d
::
veùÜ
< 
¡d
::veùÜ< 
B™m­
 > > 
Ãigh_tx_uÇvl_
;

167 
	g¡d
::
veùÜ
< 
B™m­
 > 
£lf_rx_uÇvl_
;

179 
	g¡d
::
veùÜ
< 
B™m­
 > 
£lf_tx_uÇvl_
;

192 
B™m­
 
	gbusy_
;

206 
B™m­
 
	guncÚfœmedSlÙs_
;

209 
	g¡d
::
li¡
<
WimshMshDsch
::
GÁIE
> 
uncÚfœmed_
;

212 
	g¡d
::
li¡
<
WimshMshDsch
::
AvlIE
> 
avaab™›s_
;

215 
boŞ
 
	gavlAdv”ti£_
;

218 
	g»g¿ÁOff£t_
;

220 
	g»g¿ÁDu¿tiÚ_
;

222 
boŞ
 
	g§meReg¿ÁHÜizÚ_
;

225 
boŞ
 
	g»g¿ÁEÇbËd_
;

228 
boŞ
 
	gçœReg¿Á_
;

231 
boŞ
 
	gçœG¿Á_
;

234 
boŞ
 
	gçœReque¡_
;

237 
	gmaxDefic™_
;

240 
	gmaxBacklog_
;

243 
boŞ
 
	gdefic™Ov”æow_
;

246 
WimshWeightMªag”
 
	gwm_
;

255 
	groundDu¿tiÚ_
;

258 
RNG
 
	gg¿ÁF™Rng
;

261 
boŞ
 
	gg¿ÁF™RªdomChªÃl_
;

267 
	gddTimeout_
;

270 
	gddTim”_
;

273 
	gmšG¿Á_
;

275 
	gpublic
:

277 
WimshBwMªag”FaœRR
 (
WimshMac
* 
m
);

279 ~
	$WimshBwMªag”FaœRR
 (è{ 
	}
}

282 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
);

288 
scheduË
 (
WimshMshDsch
* 
dsch
);

291 
š™Ÿlize
 ();

294 
backlog
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
´io
,

295 
WimaxNodeId
 
Ãxthİ
, 
by‹s
);

298 
backlog
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
);

301 
£Á
 (
WimaxNodeId
 
Ãxthİ
, 
by‹s
);

304 
	$»ûived
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
´io
,

305 
WimaxNodeId
 
sourû
, 
by‹s
) {

306 
wm_
.
	`æow
 (
¤c
, 
d¡
, 
´io
, 
sourû
, 
wimax
::
IN
); 
	}
}

333 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

335 
	g´Ùeùed
:

337 
šv®id©e
 (
F
);

339 
	g´iv©e
:

360 
rcvG¿Ás
 (
WimshMshDsch
* 
dsch
);

366 
rcvAvaab™›s
 (
WimshMshDsch
* 
dsch
);

372 
rcvReque¡s
 (
WimshMshDsch
* 
dsch
);

390 
cÚfœm
 (
WimshMshDsch
* 
dsch
);

392 
avaab™›s
 (
WimshMshDsch
* 
dsch
);

405 
»que¡G¿Á
 (
WimshMshDsch
* 
dsch
);

421 
»g¿Á
 (
WimshMshDsch
* 
dsch
);

431 
»®P”si¡’û
 (
¡¬t
, 
WimshMshDsch
::
P”si¡’û
 
³rs
,

432 & 
»®S¹
, & 
¿nge
);

448 
	gWimshMshDsch
::
GÁIE
 
g¿ÁF™
 (
ndx
, 
by‹s
,

449 
mšF¿me
, 
maxF¿me
, 
g¿ÁF™Desc
& 
¡©us
);

456 
cÚfF™
 ( 
f¡¬t
, 
äªge
,

457 
m¡¬t
, 
m¿nge
,

458 
WimshMshDsch
::
GÁIE
& 
gÁ
);

461 
	$hªdshake
 (
WimaxNodeId
 
x
) {

462  (è
	`û
 (

463 (
	`çbs
 ( 
mac_
->
	`h
 (
x
è- mac_->
	`phyMib
()->
	`cÚŒŞDu¿tiÚ
() ))

464 / 
mac_
->
	`phyMib
()->
	`äameDu¿tiÚ
()); 
	}
}

467 
quªtum
 (
ndx
, 
wimax
::
LškDœeùiÚ
 
dœ
) {

468  (è(
û
(
wm_
.
weight
 (
ndx
, 
dœ
è* 
roundDu¿tiÚ_
)); }

471 
´štD©aSŒuùu»s
 (
FILE
* 
os
);

	@wimsh_channel.cc

20 
	~<wimsh_chªÃl.h
>

21 
	~<wimsh_tİŞogy.h
>

22 
	~<wimsh_phy.h
>

23 
	~<wimsh_·ck‘.h
>

25 
	~<¡©.h
>

27 şas 
	cWimshChªÃlCÏss
 : 
public
 
TşCÏss
 {

28 
public
:

29 
	$WimshChªÃlCÏss
(è: 
	`TşCÏss
("WimshChannel") {}

30 
TşObjeù
* 
	$ü—‹
(, const *const*) {

31  (
Ãw
 
WimshChªÃl
);

32 
	}
}

33 } 
	gşass_wimsh_chªÃl
;

38 şas 
	cWimshChªÃl1CÏss
 : 
public
 
TşCÏss
 {

39 
public
:

40 
	$WimshChªÃl1CÏss
(è: 
	`TşCÏss
("WimshChannel1") {}

41 
TşObjeù
* 
	$ü—‹
(, const *const*) {

42  (
Ãw
 
WimshChªÃl1
);

43 
	}
}

44 } 
	gşass_wimsh_chªÃl1
;

46 
	gWimshChªÃl1
::
	$WimshChªÃl1
(è{ 
	}
}

50 
WimshChªÃl
::
	$WimshChªÃl
 (è: 
	$tim”_
 (
this
)

52 
tİŞogy_
 = 0;

53 
”rÜD©a_
 = 0;

54 
”rÜCŒl_
 = 0;

55 
ºgE¼ÜD©a_
 = 0;

56 
ºgE¼ÜCŒl_
 = 0;

57 
uid_
 = 0;

58 
	}
}

62 
	gWimshChªÃl1
::
	$commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

64 if(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1],"uid") == 0) {

65 
uid_
 = (è
	`©oi
(
¬gv
[2]);

66  
TCL_OK
;

67 } if(
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[1],"getuid") == 0) {

68 
	`årštf
(
¡d”r
,"uid i %d\n",
uid_
);

69  
TCL_OK
;

71  
TCL_ERROR
;

72 
	}
}

77 
	gWimshChªÃl
::
	$commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

79 iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "topology") == 0 ) {

80 
tİŞogy_
 = (
WimshTİŞogySim¶e
*è
TşObjeù
::
	`lookup
(
¬gv
[2]);

81  
TCL_OK
;

82 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "propagation") == 0 ) {

83 
´İag©iÚ_
 = 1.0e-6 * 
	`©of
 (
¬gv
[2]);

84  
TCL_OK
;

85 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "id") == 0 ) {

86 
uid_
 = (è
	`©oi
 (
¬gv
[2]);

87  
TCL_OK
;

88 } iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
 (
¬gv
[1], "error") == 0 ) {

89 iàĞ
	`¡rcmp
(
¬gv
[2], "data") == 0 ) {

90 
”rÜD©a_
 = 
	`©of
 (
¬gv
[3]);

91 
ºgE¼ÜD©a_
 = 
Ãw
 
RNG
;

92 iàĞ
”rÜD©a_
 < 0 ||ƒrrorData_ > 1.0 ) {

93 
	`årštf
 (
¡d”r
, "invalidƒrror„ate '%f' for data bursts. "

94 "Choo£‡‚umb” iÀ[0, 1]\n", 
”rÜD©a_
);

95  
TCL_ERROR
;

97 } iàĞ
	`¡rcmp
(
¬gv
[2], "control") == 0 ) {

98 
”rÜCŒl_
 = 
	`©of
 (
¬gv
[3]);

99 
ºgE¼ÜCŒl_
 = 
Ãw
 
RNG
;

100 iàĞ
”rÜCŒl_
 < 0 ||ƒrrorCtrl_ > 1.0 ) {

101 
	`årštf
 (
¡d”r
, "invalidƒrror„ate '%f' for control bursts. "

102 "Choo£‡‚umb” iÀ[0, 1]\n", 
”rÜCŒl_
);

103  
TCL_ERROR
;

106 
	`årštf
 (
¡d”r
, "invalidƒrrorype '%s'. "

107 "Choo£ƒ™h” 'd©a' o¸'cÚŒŞ'\n", 
¬gv
[2]);

108  
TCL_ERROR
;

111  
TCL_OK
;

113  
TCL_ERROR
;

114 
	}
}

117 
	gWimshChªÃl
::
	$»cvBur¡
 (
WimshBur¡
* 
bur¡
)

119 iàĞ
WimaxDebug
::
	`Œaû
("WCHN::»cvBur¡"èè
	`årštf
 (
¡d”r
,

121 
NOW
, 
uid_
, 
bur¡
->
	`sourû
(),

122 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ) ? "dsch" :

123 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ) ? "ncfg" :

124 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) ? "nent" :

125 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 ) ? "d©a" :"unkn", bur¡->
	`txtime
());

129 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ||

130 
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ||

131 
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) &&

132 
ºgE¼ÜCŒl_
 &&

133 
ºgE¼ÜCŒl_
->
	`unifÜm
(è< 
”rÜCŒl_
 ) ||

134 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 &&

135 
ºgE¼ÜD©a_
 &&

136 
ºgE¼ÜD©a_
->
	`unifÜm
(è< 
”rÜD©a_
 ) )

137 
bur¡
->
	`”rÜ
(èğ
Œue
;

139 iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 ) {

140 
St
::
	`put
 ("wimsh_chn_d©a_t", 0, 
bur¡
->
	`size
());

141 
St
::
	`put
 ("wimsh_chn_d©a_t", 
uid_
, 
bur¡
->
	`size
());

144 
St
::
	`put
 ("wimsh_chn_ù¾_t", 
uid_
, 
bur¡
->
	`size
());

147 
tim”_
.
	`add
 (
´İag©iÚ_
, 
bur¡
);

148 
	}
}

151 
	gWimshChªÃl
::
	$hªdË
 (
WimshBur¡
* 
bur¡
)

153 iàĞ
WimaxDebug
::
	`Œaû
("WCHN::hªdË"èè
	`årštf
 (
¡d”r
,

155 
NOW
, 
uid_
, 
bur¡
->
	`sourû
(),

156 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ) ? "dsch" :

157 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ) ? "ncfg" :

158 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) ? "nent" :

159 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 ) ? "data" : "unkn",

160 
bur¡
->
	`txtime
(),

161 
bur¡
->
	`”rÜ
());

163 
¡d
::
m­
<
WimshPhy
*, 
wimax
::
ChªÃlStus
>::
™”©Ü
 
™
 = 
phym­_
.
	`begš
();

166  ; 
™
 !ğ
phym­_
.
	`’d
() ; ++it ) {

167 iàĞ
™
->
£cÚd
 =ğ
wimax
::
RX
 ) it->
fœ¡
->
	`»cvBur¡
 (
bur¡
);

171 
d–‘e
 
bur¡
;

172 
	}
}

	@wimsh_channel.h

20 #iâdeà
__NS2_WIMSH_CHANNEL_H


21 
	#__NS2_WIMSH_CHANNEL_H


	)

23 
	~<m­
>

24 
	~<deque
>

26 
	~<wimax_commÚ.h
>

27 
	~<t_tim”s.h
>

29 
	~<scheduËr.h
>

30 
	~<ºg.h
>

32 
şass
 
	gWimshPhy
;

33 
şass
 
	gWimshBur¡
;

34 
şass
 
	gWimshTİŞogySim¶e
;

39 şas 
	cWimshChªÃl1
 : 
public
 
TşObjeù
 {

40 
public
:

41 
WimshChªÃl1
();

42 
	mvœtu®
 ~
	$WimshChªÃl1
() { }

43 
	$uid
(è{  
uid_
; 
	}
}

44 
	g´iv©e
:

45 
uid_
;

46 
	g´Ùeùed
:

47 
vœtu®
 
commªd
(
¬gc
,cÚ¡ *cÚ¡* 
¬gv
);

58 şas 
	cWimshChªÃl
 : 
public
 
TşObjeù
 {

59 
public
:

61 
¡d
::
m­
<
WimshPhy
*, 
	mwimax
::
ChªÃlStus
> 
phym­_
;

63 
	m´iv©e
:

65 
WimshTİŞogySim¶e
* 
tİŞogy_
;

68 
	mTMuÉiTim”
<
	mWimshChªÃl
, 
	mWimshBur¡
*> 
	mtim”_
;

71 
	m´İag©iÚ_
;

74 
	m”rÜD©a_
;

77 
	m”rÜCŒl_
;

80 
RNG
* 
	mºgE¼ÜD©a_
;

83 
RNG
* 
	mºgE¼ÜCŒl_
;

86 
	muid_
;

88 
	mpublic
:

90 
WimshChªÃl
 ();

92 
	mvœtu®
 ~
	$WimshChªÃl
 () { }

95 
	`£tMode
 (
WimshPhy
* 
phy
, 
wimax
::
ChªÃlStus
 
s
è{ 
phym­_
[phy] = s; 
	}
}

97 
	gwimax
::
ChªÃlStus
 
	$g‘Mode
 (
WimshPhy
* 
phy
è{  
phym­_
[phy]; 
	}
}

99 
»cvBur¡
 (
WimshBur¡
* 
bur¡
);

101 
hªdË
 (
WimshBur¡
* 
bur¡
);

104 
	$uid
 (è{  
uid_
; 
	}
}

106 
	g´Ùeùed
:

108 
vœtu®
 
commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

110 
	g´iv©e
:

111 
WimshChªÃl
 (const WimshChannel&);

112 
	gİ”©Ü
ğ(cÚ¡ 
WimshChªÃl
&);

	@wimsh_coordinator.cc

20 
	~<wimsh_coÜdš©Ü.h
>

21 
	~<t_tim”s.h
>

22 
	~<wimsh_·ck‘.h
>

23 
	~<wimsh_tİŞogy.h
>

24 
	~<wimsh_mac.h
>

26 
	~<m©h.h
>

34 
	gWimshCoÜdš©Ü
::
	$WimshCoÜdš©Ü
 (
WimshMac
* 
m
è: 
	`mac_
(m), 
	$tim”_
 (
this
)

36 
ÃxtDschSlÙ_
 = 0;

37 
ÃxtDschF¿me_
 = 
NEVER
;

38 
ÃxtNcfgSlÙ_
 = 0;

39 
ÃxtNcfgF¿me_
 = 
NEVER
;

40 
ÃxtN’tSlÙ_
 = 0;

41 
ÃxtN’tF¿me_
 = 
NEVER
;

42 
	}
}

46 
	gWimshCoÜdš©Ü
::
	$hªdË
 ()

49 
WimshPhyMib
* 
phyMib
 = 
mac_
->
	`phyMib
();

52 cÚ¡ 
C
 = 
phyMib
->
	`cÚŒŞSlÙs
();

55 cÚ¡ 
cur¦Ù
 = (è
	`round
 (

56 Ğ
NOW
 - 
mac_
->
	`äame
(è* 
phyMib
->
	`äameDu¿tiÚ
() ) /

57 
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
() );

59 iàĞ
WimaxDebug
::
	`Œaû
 ("WCRD::hªdË"èè
	`årštf
 (
¡d”r
,

63 
NOW
, 
mac_
->
	`nodeId
(),

64 
cur¦Ù
, 
mac_
->
	`äame
(), 
ÃxtDschSlÙ_
, 
ÃxtDschF¿me_
,

65 
ÃxtNcfgSlÙ_
, 
ÃxtNcfgF¿me_
, 
ÃxtN’tSlÙ_
, 
ÃxtN’tF¿me_
);

76 iàĞ
cur¦Ù
 =ğ
ÃxtDschSlÙ_
 && 
mac_
->
	`äame
(è=ğ
ÃxtDschF¿me_
 ) {

79 
	`–eùiÚDsch
 ();

83 
tim”_
.
	`¡¬t
 (
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
());

86 
WimshMshDsch
* 
dsch
 = 
Ãw
 WimshMshDsch;

89 
	`flS–f
 (
dsch
);

90 
	`flNeighbÜs
 (
dsch
);

93 
mac_
->
	`İpÜtun™y
 (
dsch
);

96 } iàĞ
cur¦Ù
 =ğ
ÃxtNcfgSlÙ_
 && 
mac_
->
	`äame
(è=ğ
ÃxtNcfgF¿me_
 ) {

99 
	`–eùiÚNcfg
 ();

103 
tim”_
.
	`¡¬t
 (
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
());

106 
WimshMshNcfg
* 
ncfg
 = 
Ãw
 WimshMshNcfg;

109 
	`flS–f
 (
ncfg
);

110 
	`flNeighbÜs
 (
ncfg
);

113 
mac_
->
	`İpÜtun™y
 (
ncfg
);

116 } iàĞ
cur¦Ù
 =ğ
ÃxtN’tSlÙ_
 && 
mac_
->
	`äame
(è=ğ
ÃxtN’tF¿me_
 ) {

119 
	`–eùiÚN’t
 ();

123 
tim”_
.
	`¡¬t
 (
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
());

126 
WimshMshN’t
* 
ÃÁ
 = 
Ãw
 WimshMshNent;

129 
mac_
->
	`İpÜtun™y
 (
ÃÁ
);

132 } iàĞ
cur¦Ù
 =ğ
C
 ) {

134 
tim”_
.
	`¡¬t
 (

135 
phyMib
->
	`äameDu¿tiÚ
()

136 - 
C
 * 
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
());

139 
mac_
->
	`£tCÚŒŞChªÃl
 (
wimax
::
RX
);

150 
¦Ù
 = -1;

151 iàĞ
ÃxtDschF¿me_
 =ğ
mac_
->
	`äame
() ) {

152 
¦Ù
 = 
ÃxtDschSlÙ_
;

153 } iàĞ
ÃxtN’tF¿me_
 =ğ
mac_
->
	`äame
() ) {

154 
¦Ù
 = 
ÃxtN’tSlÙ_
;

155 } iàĞ
ÃxtNcfgF¿me_
 =ğ
mac_
->
	`äame
() ) {

156 
¦Ù
 = 
ÃxtNcfgSlÙ_
;

160 iàĞ
¦Ù
 >ğ0 ) slÙ -ğ
cur¦Ù
;

161 
¦Ù
 = 
C
 - 
cur¦Ù
;

164 
tim”_
.
	`¡¬t
 ( 
¦Ù
 * 
phyMib
->
	`cÚŒŞSlÙDu¿tiÚ
() );

167 
mac_
->
	`£tCÚŒŞChªÃl
 (
wimax
::
RX
);

169 
	}
}

177 
	gWimshCoÜdš©ÜDummy
::
	$WimshCoÜdš©ÜDummy
 (
WimshMac
* 
m
, 
WimshPhyMib
* 
p
) :

178 
	$WimshCoÜdš©Ü
 (
m
)

180 
phyMib_
 = 
p
;

181 
¦Ù_
 = 0;

182 
äame_
 = 1;

183 
³riod_
 = 1;

184 
³riodNumb”_
 = 0;

185 
fœ¡F¿me_
 = 0;

186 
ty³_
 = 
FIXED
;

187 
	}
}

190 
	gWimshCoÜdš©ÜDummy
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

192 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "mode") == 0 ) {

193 iàĞ
	`¡rcmp
 (
¬gv
[1], "fixed") == 0 ) {

194 
ty³_
 = 
FIXED
;

195 } iàĞ
	`¡rcmp
 (
¬gv
[1], "moving") == 0 ) {

196 
ty³_
 = 
MOVING
;

198 
	`årštf
 (
¡d”r
, "invalid dummy coordinatorype '%s'. "

199 "Choo£ 'fixed' o¸'movšg'.\n", 
¬gv
[1]);

200  
TCL_ERROR
;

202 
	`¡¬t
 ();

203  
TCL_OK
;

204 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "slot") == 0 ) {

205 
¦Ù_
 = (è
	`©oi
 (
¬gv
[1]);

206  
TCL_OK
;

207 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "frame") == 0 ) {

208 
äame_
 = (è
	`©oi
 (
¬gv
[1]);

209  
TCL_OK
;

210 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "first") == 0 ) {

211 
fœ¡F¿me_
 = (è
	`©oi
 (
¬gv
[1]);

212  
TCL_OK
;

213 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "period") == 0 ) {

214 
³riod_
 = (è
	`©oi
 (
¬gv
[1]);

215  
TCL_OK
;

217  
TCL_ERROR
;

218 
	}
}

221 
	gWimshCoÜdš©ÜDummy
::
	$¡¬t
 ()

224 iàĞ
ty³_
 =ğ
FIXED
 ) {

225 
ÃxtDschSlÙ_
 = 
¦Ù_
;

226 
ÃxtDschF¿me_
 = 
fœ¡F¿me_
;

228 
ÃxtDschSlÙ_
 = 
¦Ù_
 % 
phyMib_
->
	`cÚŒŞSlÙs
();

229 
ÃxtDschF¿me_
 = 
¦Ù_
 / 
phyMib_
->
	`cÚŒŞSlÙs
();

232 
tim”_
.
	`¡¬t
 (

233 
ÃxtDschSlÙ_
 * 
phyMib_
->
	`cÚŒŞSlÙDu¿tiÚ
()

234 + 
ÃxtDschF¿me_
 * 
phyMib_
->
	`äameDu¿tiÚ
() );

235 
	}
}

238 
	gWimshCoÜdš©ÜDummy
::
	$flS–f
 (
WimshMshDsch
* 
dsch
)

241 
dsch
->
	`¤c
(èğ
mac_
->
	`nodeId
();

242 
dsch
->
	`hdr
().
	`üc
(èğ
Œue
;

248 
dsch
->
	`my£lf
().
nodeId_
 = 
mac_
->
	`nodeId
();

249 
dsch
->
	`my£lf
().
ÃxtXmtMx_
 = 0;

250 
dsch
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
 = 0;

251 
	}
}

254 
	gWimshCoÜdš©ÜDummy
::
	$flNeighbÜs
 (
WimshMshDsch
* 
dsch
)

257 
¡d
::
veùÜ
<
WimaxNodeId
> 
Ãigh
;

258 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
 (mac_->
	`nodeId
(), 
Ãigh
);

260 
¡d
::
veùÜ
<
WimaxNodeId
>::
™”©Ü
 
™
;

261  
™
 = 
Ãigh
.
	`begš
(è; iˆ!ğÃigh.
	`’d
() ; ++it ) {

264 iàĞ
dsch
->
	`»maššg
(è< 
WimshMshDsch
::
NghIE
::
	`size
() ) ;

266 
WimshMshDsch
::
NghIE
 
›
;

269 
›
.
nodeId_
 = *
™
;

270 
›
.
ÃxtXmtMx_
 = 0;

271 
›
.
xmtHŞdoffExpÚ’t_
 = 0;

274 
dsch
->
	`add
 (
›
);

276 
	}
}

279 
	gWimshCoÜdš©ÜDummy
::
	$–eùiÚ
 ()

282 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
();

285 iàĞ
ty³_
 =ğ
FIXED
 ) {

286 
ÃxtDschSlÙ_
 = 
¦Ù_
;

287 
ÃxtDschF¿me_
 = 
mac_
->
	`äame
 (è+ 
äame_
;

291 ++
³riodNumb”_
;

294 
¦Ù_
 = ( slÙ_ + 1 ) % 
³riod_
;

297 
abs
 = 
³riodNumb”_
 * 
³riod_
 + 
¦Ù_
;

300 
ÃxtDschSlÙ_
 = 
abs
 % 
C
;

301 
ÃxtDschF¿me_
 = 
abs
 / 
C
;

303 
	}
}

	@wimsh_coordinator.h

20 #iâdeà
__NS2_WIMSH_COORDINATOR_H


21 
	#__NS2_WIMSH_COORDINATOR_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<t_tim”s.h
>

25 
	~<wimax_defs.h
>

27 
şass
 
	gWimshMac
;

28 
şass
 
	gWimshMshDsch
;

29 
şass
 
	gWimshMshNcfg
;

30 
şass
 
	gWimshMshN’t
;

31 
şass
 
	gWimshPhyMib
;

43 şas 
	cWimshCoÜdš©Ü
 {

45 ’um { 
	mNEVER
 = 0xFFFFFFFF };

46 
	g´Ùeùed
:

48 
WimshMac
* 
mac_
;

51 
	gTTim”
<
	gWimshCoÜdš©Ü
> 
	gtim”_
;

54 
	gÃxtDschSlÙ_
;

56 
	gÃxtDschF¿me_
;

59 
	gÃxtNcfgSlÙ_
;

61 
	gÃxtNcfgF¿me_
;

67 
	gÃxtN’tSlÙ_
;

69 
	gÃxtN’tF¿me_
;

71 
	gpublic
:

73 
WimshCoÜdš©Ü
 (
WimshMac
* 
m
);

75 
	gvœtu®
 ~
	$WimshCoÜdš©Ü
 (è{ 
	}
}

78 
vœtu®
 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
, 
txtime
 = 0) = 0;

79 
vœtu®
 
»cvMshNcfg
 (
WimshMshNcfg
* 
ncfg
, 
txtime
 = 0) { }

89 
vœtu®
 
hªdË
 ();

92 
vœtu®
 
š™Ÿlize
() = 0;

95 
vœtu®
 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
) = 0;

97 
	g´Ùeùed
:

99 
vœtu®
 
–eùiÚDsch
 () = 0;

101 
vœtu®
 
–eùiÚNcfg
 () = 0;

103 
vœtu®
 
–eùiÚN’t
 () = 0;

106 
vœtu®
 
flS–f
 (
WimshMshDsch
* 
dsch
) = 0;

108 
vœtu®
 
flNeighbÜs
 (
WimshMshDsch
* 
dsch
) = 0;

111 
vœtu®
 
flS–f
 (
WimshMshNcfg
* 
ncfg
) = 0;

113 
vœtu®
 
flNeighbÜs
 (
WimshMshNcfg
* 
ncfg
) = 0;

134 şas 
	cWimshCoÜdš©ÜDummy
 : 
public
 
WimshCoÜdš©Ü
 {

136 ’um { 
FIXED
 = 0, 
	mMOVING
 } 
	gty³_
;

139 
	g¦Ù_
;

141 
	gäame_
;

143 
	gfœ¡F¿me_
;

146 
	g³riod_
;

148 
	g³riodNumb”_
;

151 
WimshPhyMib
* 
	gphyMib_
;

152 
	gpublic
:

154 
WimshCoÜdš©ÜDummy
 (
WimshMac
* 
m
, 
WimshPhyMib
* 
p
);

157 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
, 
txtime
 = 0) { }

159 
»cvMshNcfg
 (
WimshMshNcfg
* 
ncfg
, 
txtime
 = 0) { }

162 
	$š™Ÿlize
(è{ 
	}
};

170 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

172 
	g´Ùeùed
:

174 
–eùiÚ
 ();

177 
	$–eùiÚDsch
 (è{
	}
};

179 
	$–eùiÚNcfg
 (è{
	}
};

181 
	$–eùiÚN’t
 (è{
	}
};

184 
flS–f
 (
WimshMshDsch
* 
dsch
);

187 
flNeighbÜs
 (
WimshMshDsch
* 
dsch
);

190 
	$flS–f
 (
WimshMshNcfg
* 
ncfg
è{
	}
};

192 
	$flNeighbÜs
 (
WimshMshNcfg
* 
ncfg
è{
	}
};

194 
	g´iv©e
:

196 
¡¬t
 ();

	@wimsh_coordinator_std.cc

20 
	~<wimsh_coÜdš©Ü_¡d.h
>

21 
	~<t_tim”s.h
>

22 
	~<wimsh_·ck‘.h
>

23 
	~<wimsh_tİŞogy.h
>

24 
	~<wimsh_mac.h
>

25 
	~<¡©.h
>

27 
	~<m©h.h
>

35 
	gWimshCoÜdš©ÜSnd¬d
::
	$WimshCoÜdš©ÜSnd¬d
(
WimshMac
* 
m
, 
WimshPhyMib
* 
p
):

36 
	$WimshCoÜdš©Ü
 (
m
)

38 
phyMib_
 = 
p
;

39 
ty³_
 = 
XMTUNAWARE
;

40 
maxClique_
 = 
çl£
;

41 
maxAdv”ti£dNeighbÜs_
 = -1;

42 
	}
}

45 
	gWimshCoÜdš©ÜSnd¬d
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

47 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "mode") == 0 ) {

48 iàĞ
	`¡rcmp
 (
¬gv
[1], "xmtaware") == 0 ) {

49 
ty³_
 = 
XMTAWARE
;

50 } iàĞ
	`¡rcmp
 (
¬gv
[1], "xmtunaware") == 0 ) {

51 
ty³_
 = 
XMTUNAWARE
;

53 
	`årštf
 (
¡d”r
, "invalid standard coordinatorype '%s'. "

54 "Choo£ 'xmw¬e' o¸'xmtuÇw¬e'.\n", 
¬gv
[1]);

55  
TCL_ERROR
;

57 
	`¡¬t
 ();

58  
TCL_OK
;

59 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "nextxmttime") == 0 ) {

60 
myDsch_
.
ÃxtXmtTime_
 = (è
	`©oi
 (
¬gv
[1]);

61 
myNcfg_
.
ÃxtXmtTime_
 = (è
	`©oi
 (
¬gv
[1]);

62  
TCL_OK
;

63 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "max-advertised") == 0 ) {

64 
maxAdv”ti£dNeighbÜs_
 = (è
	`©oi
 (
¬gv
[1]);

65  
TCL_OK
;

66 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "holdoffexp-dsch") == 0 ) {

67 
myDsch_
.
hŞdOffExp_
 = (è
	`©oi
 (
¬gv
[1]);

68  
TCL_OK
;

69 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "holdoffexp-ncfg") == 0 ) {

70 
myNcfg_
.
hŞdOffExp_
 = (è
	`©oi
 (
¬gv
[1]);

71  
TCL_OK
;

73  
TCL_ERROR
;

74 
	}
}

77 
	gWimshCoÜdš©ÜSnd¬d
::
	$š™Ÿlize
 ()

79 
myDsch_
.
ÃxtXmtMx_
 = 0;

80 
myNcfg_
.
ÃxtXmtMx_
 = 0;

81 
¡d
::
veùÜ
<
WimaxNodeId
> 
Ãigh
;

84 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
Ğmac_->
	`nodeId
(), 
Ãigh
, 1 );

86  
i
 = 0; i < 
Ãigh
.
	`size
(); i++ ){

87 
nghLi¡Dsch_
.
	`push_back
Ğ
	`NeighInfo
(0, 0, 
Ãigh
.
	`©
(
i
), 1) );

88 
nghLi¡Ncfg_
.
	`push_back
Ğ
	`NeighInfo
(0, 0, 
Ãigh
.
	`©
(
i
), 1) );

90 
Ãigh
.
	`ş—r
();

93 
mac_
->
	`tİŞogy
()->
	`ÃighbÜs
Ğmac_->
	`nodeId
(), 
Ãigh
, 2 );

95  
i
 = 0; i < 
Ãigh
.
	`size
(); i++ ){

96 
nghLi¡Dsch_
.
	`push_back
Ğ
	`NeighInfo
(0, 0, 
Ãigh
.
	`©
(
i
), 2) );

97 
nghLi¡Ncfg_
.
	`push_back
Ğ
	`NeighInfo
(0, 0, 
Ãigh
.
	`©
(
i
), 2) );

113 
¡d
::
li¡
<
NeighInfo
>::
™”©Ü
 
™
;

114  
™
 = 
nghLi¡Dsch_
.
	`begš
(); iˆ!ğnghLi¡Dsch_.
	`’d
(); ++it ){

115 
nghM­Dsch_
[ 
™
->
nodeID_
 ] = &(*it);

117  
™
 = 
nghLi¡Ncfg_
.
	`begš
(); iˆ!ğnghLi¡Ncfg_.
	`’d
(); ++it ){

118 
nghM­Ncfg_
[ 
™
->
nodeID_
 ] = &(*it);

120 
	}
}

123 
	gWimshCoÜdš©ÜSnd¬d
::
	$¡¬t
 ()

126 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
();

127 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

129 
ÃxtDschSlÙ_
 = 
myDsch_
.
ÃxtXmtTime_
 % 
C
;

130 
ÃxtDschF¿me_
 = 
myDsch_
.
ÃxtXmtTime_
 / 
C
;

131 
ÃxtDschF¿me_
 +ğ1 +‚extDschF¿me_ / 
T
;

133 
ÃxtNcfgSlÙ_
 = 1 + 
myNcfg_
.
ÃxtXmtTime_
 % ( 
C
 - 1 );

134 
ÃxtNcfgF¿me_
 = 
myNcfg_
.
ÃxtXmtTime_
 / ( 
C
 - 1 );

135 
ÃxtNcfgF¿me_
 +ğ
T
 *‚extNcfgFrame_;

137 
ÃxtN’tSlÙ_
 = 0;

138 
ÃxtN’tF¿me_
 = 0;

140 
tim”_
.
	`¡¬t
 (0);

141 
	}
}

145 
	gWimshCoÜdš©ÜSnd¬d
::
	$flS–f
 (
WimshMshDsch
* 
dsch
)

148 
dsch
->
	`¤c
(èğ
mac_
->
	`nodeId
();

149 
dsch
->
	`hdr
().
	`üc
(èğ
Œue
;

155 
dsch
->
	`my£lf
().
nodeId_
 = 
mac_
->
	`nodeId
();

157 
dsch
->
	`my£lf
().
ÃxtXmtTimeSec_
 = 
myDsch_
.nextXmtTimeSec_;

158 
dsch
->
	`my£lf
().
ÃxtXmtTime_
 = 
myDsch_
.nextXmtTime_;

159 
dsch
->
	`my£lf
().
ÃxtXmtMx_
 = 
myDsch_
.nextXmtMx_;

160 
dsch
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
 = 
myDsch_
.
hŞdOffExp_
;

161 
	}
}

164 
	gWimshCoÜdš©ÜSnd¬d
::
	$flNeighbÜs
 (
WimshMshDsch
* 
dsch
)

166 iàĞ
ty³_
 =ğ
XMTUNAWARE
 ) ;

168 
¡d
::
li¡
<
NeighInfo
>::
™”©Ü
 
™
;

169 
adv”ti£dNeighbÜs
 = 0;

170  
™
 = 
nghLi¡Dsch_
.
	`begš
(); iˆ!ğnghLi¡Dsch_.
	`’d
(); ++it ){

175 iàĞĞ
maxAdv”ti£dNeighbÜs_
 >= 0 &&

176 ()
adv”ti£dNeighbÜs
 >ğ
maxAdv”ti£dNeighbÜs_
 ) ||

177 
dsch
->
	`»maššg
(è< 
WimshMshDsch
::
NghIE
::
	`size
() ) ;

179 
WimshMshDsch
::
NghIE
 
›
;

182 iàĞ
™
->
ÃxtXmtTime_
 > 0 ) {

184 
›
.
ÃxtXmtTime_
 = 
™
->nextXmtTime_;

185 
›
.
ÃxtXmtMx_
 = 
™
->nextXmtMx_;

186 
›
.
xmtHŞdoffExpÚ’t_
 = 
™
->
hŞdOffExp_
;

187 
›
.
nodeId_
 = 
™
->
nodeID_
;

190 iàĞ
™
->
nhİ_
 == 1 ) {

191 
dsch
->
	`add
 (
›
);

192 ++
adv”ti£dNeighbÜs
;

196 
	}
}

199 
	gWimshCoÜdš©ÜSnd¬d
::
	$flS–f
 (
WimshMshNcfg
* 
ncfg
)

202 
ncfg
->
	`¤c
(èğ
mac_
->
	`nodeId
();

203 
ncfg
->
	`hdr
().
	`üc
(èğ
Œue
;

209 
ncfg
->
	`my£lf
().
nodeId_
 = 
mac_
->
	`nodeId
();

211 
ncfg
->
	`my£lf
().
ÃxtXmtTime_
 = 
myNcfg_
.nextXmtTime_;

212 
ncfg
->
	`my£lf
().
ÃxtXmtMx_
 = 
myNcfg_
.nextXmtMx_;

213 
ncfg
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
 = 
myNcfg_
.
hŞdOffExp_
;

214 
	}
}

217 
	gWimshCoÜdš©ÜSnd¬d
::
	$flNeighbÜs
 (
WimshMshNcfg
* 
ncfg
)

219 iàĞ
ty³_
 =ğ
XMTUNAWARE
 ) ;

220 
	`abÜt
();

221 
	}
}

224 
	gWimshCoÜdš©ÜSnd¬d
::
	$»cvMshDsch
 (
WimshMshDsch
 *
dsch
, 
txtime
)

227 iàĞ
WimaxDebug
::
	`Œaû
("WCRD::»cvMshDsch"èè
	`årštf
 (
¡d”r
,

228 "%.9àWMAC::»cvMshDsch[%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

231 cÚ¡ 
cu¼’tSlÙ
 = 
	`cu¼’tCŒlSlÙDsch
(
txtime
);

233 
¡d
::
m­
< 
WimaxNodeId
, 
NeighInfo
* >::
™”©Ü
 
ÃighbÜ_™
;

235 
ÃighbÜ_™
 = 
nghM­Dsch_
.
	`fšd
Ğ
dsch
->
	`my£lf
().
nodeId_
 );

239 iàĞ
ty³_
 =ğ
XMTAWARE
 ){

240 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtTime_
 = 
dsch
->
	`my£lf
().nextXmtTime_;

245 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtTime_
 =

246 1 + 
dsch
->
	`my£lf
().
ÃxtXmtMx_
 *

247 Ğ1 << 
dsch
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
 );

249 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtMx_
 = 
dsch
->
	`my£lf
().nextXmtMx_;

250 
ÃighbÜ_™
->
£cÚd
->
hŞdOffExp_
 = 
dsch
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
;

251 
ÃighbÜ_™
->
£cÚd
->
timeSmp_
 = 
cu¼’tSlÙ
;

253 iàĞ
ty³_
 =ğ
XMTAWARE
 ){

255 
¡d
::
li¡
< 
WimshMshDsch
::
NghIE
 > 
nghLi¡
 = 
dsch
->
	`ngh
();

256 
¡d
::
li¡
< 
WimshMshDsch
::
NghIE
 >::
™”©Ü
 
™
;

258  
™
 = 
nghLi¡
.
	`begš
(); iˆ!ğnghLi¡.
	`’d
(); ++it ){

260 
ÃighbÜ_™
 = 
nghM­Dsch_
.
	`fšd
Ğ
™
->
nodeId_
 );

262 ifĞ
ÃighbÜ_™
 !ğ
nghM­Dsch_
.
	`’d
() &&

263 
ÃighbÜ_™
->
£cÚd
->
nhİ_
 == 2 ) {

265 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtTime_
 = 
™
->nextXmtTime_;

266 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtMx_
 = 
™
->nextXmtMx_;

267 
ÃighbÜ_™
->
£cÚd
->
hŞdOffExp_
 = 
™
->
xmtHŞdoffExpÚ’t_
;

268 
ÃighbÜ_™
->
£cÚd
->
timeSmp_
 = 
cu¼’tSlÙ
;

273 
	}
}

276 
	gWimshCoÜdš©ÜSnd¬d
::
	$»cvMshNcfg
 (
WimshMshNcfg
 *
ncfg
, 
txtime
)

280 iàĞ
WimaxDebug
::
	`Œaû
("WCRD::»cvMshNcfg"èè
	`årštf
 (
¡d”r
,

281 "%.9àWMAC::»cvMshNcfg[%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

284 cÚ¡ 
cu¼’tSlÙ
 = 
	`cu¼’tCŒlSlÙNcfg
(
txtime
);

286 
¡d
::
m­
< 
WimaxNodeId
, 
NeighInfo
* >::
™”©Ü
 
ÃighbÜ_™
;

288 
ÃighbÜ_™
 = 
nghM­Ncfg_
.
	`fšd
Ğ
ncfg
->
	`my£lf
().
nodeId_
 );

292 iàĞ
ty³_
 =ğ
XMTAWARE
 ){

294 
	`abÜt
();

299 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtTime_
 =

300 1 + 
ncfg
->
	`my£lf
().
ÃxtXmtMx_
 *

301 Ğ1 << 
ncfg
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
 );

303 
ÃighbÜ_™
->
£cÚd
->
ÃxtXmtMx_
 = 
ncfg
->
	`my£lf
().nextXmtMx_;

304 
ÃighbÜ_™
->
£cÚd
->
hŞdOffExp_
 = 
ncfg
->
	`my£lf
().
xmtHŞdoffExpÚ’t_
;

305 
ÃighbÜ_™
->
£cÚd
->
timeSmp_
 = 
cu¼’tSlÙ
;

306 
	}
}

309 
	gWimshCoÜdš©ÜSnd¬d
::
	$–eùiÚDsch
 ()

312 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
 ();

313 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

316 
	`com³t™iÚ
 (
nghLi¡Dsch_
, 
myDsch_
, 
wimax
::
MSHDSCH
);

319 
¦Ù
 = 
	`cu¼’tCŒlSlÙDsch
();

323 
¦Ù
 +ğ
myDsch_
.
ÃxtXmtTime_
;

326 iàĞ
maxClique_
 ) 
St
::
	`put
 ("wimsh_election_util", 0, 1);

327 
St
::
	`put
 ("wimsh_dsch_–eùiÚ_¿ndom", 
mac_
->
	`šdex
(),

328 Ğ
myDsch_
.
ÃxtXmtTime_
 - 
	`compu‹HŞdoffTime
(myDsch_.
hŞdOffExp_
) ) );

329 
St
::
	`put
 ("wimsh_dsch_–eùiÚ_¦Ùs", 
mac_
->
	`šdex
(), 
myDsch_
.
ÃxtXmtTime_
);

330 
St
::
	`put
 ("wimsh_dsch_–eùiÚ_¦Ùs_d", 
mac_
->
	`šdex
(), 
myDsch_
.
ÃxtXmtTime_
);

332 
¦Ù
 +ğĞ1 + ( slÙ / 
C
 ) / 
T
 ) * C;

335 
ÃxtDschSlÙ_
 = 
¦Ù
 % 
C
;

336 
ÃxtDschF¿me_
 = 
¦Ù
 / 
C
;

340 
myDsch_
.
ÃxtXmtTimeSec_
 =

341 
phyMib_
->
	`cÚŒŞSlÙDu¿tiÚ
(è* 
ÃxtDschSlÙ_


342 + 
phyMib_
->
	`äameDu¿tiÚ
(è* 
ÃxtDschF¿me_


343 - 
NOW
;

344 
	}
}

347 
	gWimshCoÜdš©ÜSnd¬d
::
	$–eùiÚNcfg
 ()

350 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
 ();

351 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

354 
	`com³t™iÚ
 (
nghLi¡Ncfg_
, 
myNcfg_
, 
wimax
::
MSHNCFG
);

357 
¦Ù
 = 
	`cu¼’tCŒlSlÙNcfg
();

361 
¦Ù
 +ğ
myNcfg_
.
ÃxtXmtTime_
;

364 
St
::
	`put
 ("wimsh_ncfg_–eùiÚ_¿ndom", 
mac_
->
	`šdex
(),

365 Ğ
myNcfg_
.
ÃxtXmtTime_
 - 
	`compu‹HŞdoffTime
(myNcfg_.
hŞdOffExp_
) ) );

366 
St
::
	`put
 ("wimsh_ncfg_–eùiÚ_¦Ùs", 
mac_
->
	`šdex
(), 
myNcfg_
.
ÃxtXmtTime_
);

368 
¦Ù
 +ğĞ1 + 
T
 * 
C
 ) * ( slot / ( C - 1 ) );

371 
ÃxtNcfgSlÙ_
 = 1 + 
¦Ù
 % ( 
C
 - 1 );

372 
ÃxtNcfgF¿me_
 = 
¦Ù
 / 
C
;

374 
	}
}

377 
	gWimshCoÜdš©ÜSnd¬d
::
	$–eùiÚN’t
 ()

379 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

380 
ÃxtN’tF¿me_
 +ğ
T
 + 1;

381 
	}
}

384 
	gWimshCoÜdš©ÜSnd¬d
::
com³t™iÚ
 (

385 
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
,

386 
MyInfo
& 
my
, 
wimax
::
Bur¡Ty³
 
ty³
)

389 
cu¼’tSlÙ
 = 0;

390 iàĞ
	gty³
 =ğ
wimax
::
MSHDSCH
 ) 
cu¼’tSlÙ
 = 
cu¼’tCŒlSlÙDsch
();

391 iàĞ
	gty³
 =ğ
wimax
::
MSHNCFG
 ) 
cu¼’tSlÙ
 = 
cu¼’tCŒlSlÙNcfg
();

392 
abÜt
();

394 
	g¡d
::
li¡
<
NeighInfo
>::
™”©Ü
 
™
;

395  
	g™
 = 
nghLi¡
.
begš
(); iˆ!ğnghLi¡.
’d
(); ++it ){

396 
	g–­£d
 = 
cu¼’tSlÙ
 - 
™
->
timeSmp_
;

397 
	g™
->
	gtimeSmp_
 = 
cu¼’tSlÙ
;

399 
	g™
->
	gÃxtXmtTime_
 = ( 
™
->
ÃxtXmtTime_
 > 
–­£d
 ) ?

400 
™
->
ÃxtXmtTime_
 - 
–­£d
 : 0;

403 
	g™
->
	g—¾SubXmtTime_
 = 
™
->
ÃxtXmtTime_


404 + 
compu‹HŞdoffTime
Ğ
™
->
hŞdOffExp_
 );

407 
	gnghLi¡
.
sÜt
 ();

410 
	gTempXmtTime
 = 
compu‹HŞdoffTime
(
my
.
hŞdOffExp_
);

412 
boŞ
 
	gsucûss
 = 
çl£
;

413 !
	gsucûss
){

415 
	gSt
::
put
 ("wimsh_dsch_com³tšg", 
mac_
->
šdex
(),

416 (è
com³tšgNodes
Ğ
TempXmtTime
, 
nghLi¡
 ));

418 iàĞ
meshEËùiÚ
 (
TempXmtTime
, 
mac_
->
nodeId
(), 
nghLi¡
, 
ty³
è=ğ
çl£
 )

419 ++
TempXmtTime
;

421 
	gsucûss
 = 
Œue
;

422 
	gmy
.
	gÃxtXmtTime_
 = 
TempXmtTime
;

423 
	gmy
.
	gÃxtXmtMx_
 = 
compu‹XmtTimeMx
Ğ
my
.
hŞdOffExp_
, my.
ÃxtXmtTime_
 );

428 
boŞ


429 
	gWimshCoÜdš©ÜSnd¬d
::
meshEËùiÚ
 (
TempXmtTime
,

430 
nodeID
,

431 
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
,

432 
wimax
::
Bur¡Ty³
 
ty³
)

435 
cu¼’tSlÙ
 = 0;

436 iàĞ
	gty³
 =ğ
wimax
::
MSHDSCH
 ) 
cu¼’tSlÙ
 = 
cu¼’tCŒlSlÙDsch
();

437 iàĞ
	gty³
 =ğ
wimax
::
MSHNCFG
 ) 
cu¼’tSlÙ
 = 
cu¼’tCŒlSlÙNcfg
();

438 
abÜt
();

441 
	gnbr_sm—r_v®
, 
	gsm—r_v®1
, 
	gsm—r_v®2
;

442 
	gsm—r_v®1
 = 
šlše_sm—r
Ğ
nodeID
 ^ ( 
TempXmtTime
 + 
cu¼’tSlÙ
 ) );

443 
	gsm—r_v®2
 = 
šlše_sm—r
Ğ
nodeID
 + ( 
TempXmtTime
 + 
cu¼’tSlÙ
 ) );

445 
	g¡d
::
li¡
<
NeighInfo
>::
™”©Ü
 
™
;

446  
	g™
 = 
nghLi¡
.
begš
(); iˆ!ğnghLi¡.
’d
(); ++it ){

447 ifĞ
	g™
->
	gcom³tšg_
 ){

448 
	gnbr_sm—r_v®
 = 
šlše_sm—r
Ğ
™
->
nodeID_
 ^

449 Ğ
TempXmtTime
 + 
cu¼’tSlÙ
 ) );

451 ifĞ
	gnbr_sm—r_v®
 > 
	gsm—r_v®1
 ){

452  
	gçl£
;

453 } ifĞ
	gnbr_sm—r_v®
 =ğ
sm—r_v®1
 ) {

454 
nbr_sm—r_v®
 = 
šlše_sm—r
Ğ
™
->
nodeID_
 +

455 Ğ
TempXmtTime
 + 
cu¼’tSlÙ
 ) );

457 ifĞ
	gnbr_sm—r_v®
 > 
	gsm—r_v®2
 ) {

458  
	gçl£
;

460 } ifĞ
	gnbr_sm—r_v®
 =ğ
sm—r_v®2
 ) {

461 ifĞĞĞĞ
TempXmtTime
 + 
cu¼’tSlÙ
 )%2 == 0 ) &&

462 Ğ
™
->
nodeID_
 > 
nodeID
 ) ) ||

463 ĞĞĞ
TempXmtTime
 + 
cu¼’tSlÙ
 )%2 == 1 ) &&

464 Ğ
™
->
nodeID_
 < 
nodeID
 ) ) ) {

465  
çl£
;

470  
	gŒue
;

475 
	gWimshCoÜdš©ÜSnd¬d
::
com³tšgNodes
 (
TempXmtTime
,

476 
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
)

478 
com³tšgNodes
 = 0;

479 
	g¡d
::
li¡
<
NeighInfo
>::
™”©Ü
 
™
;

480  
	g™
 = 
nghLi¡
.
begš
(); iˆ!ğnghLi¡.
’d
(); ++it ){

481 
	g™
->
	gcom³tšg_
 = 
çl£
;

482 
	ghŞdexp
 = 
™
->
hŞdOffExp_
;

485 ifĞ
	g™
->
	gÃxtXmtTime_
 == 0 ){

486 
™
->
com³tšg_
 = 
Œue
;

487 ++
	gcom³tšgNodes
;

490 Ğ
	gty³_
 =ğ
XMTAWARE
 && 
™
->
ÃxtXmtTime_
 =ğ
TempXmtTime
 ) ||

491 Ğ
ty³_
 =ğ
XMTUNAWARE
 &&

492 Ğ
TempXmtTime
 >ğ
™
->
ÃxtXmtTime_
 &&

494 
TempXmtTime
 <ğ
™
->
ÃxtXmtTime_
 + ( 1 << 
hŞdexp
 ) ) ) ||

495 Ğ
™
->
—¾SubXmtTime_
 <ğ
TempXmtTime
 )

497 
™
->
com³tšg_
 = 
Œue
;

498 ++
	gcom³tšgNodes
;

502  
	gcom³tšgNodes
;

509 
	gWimshCoÜdš©ÜSnd¬d
::
	$compu‹HŞdoffTime
(
hŞdOffExp
)

511  1 << ( 
hŞdOffExp
 + 4 );

512 
	}
}

516 
	gWimshCoÜdš©ÜSnd¬d
::
compu‹XmtTimeMx


517 Ğ
hŞdOffExp
, 
	gNextXmtTime
 )

521 
	ghŞd
 = 1 << 
hŞdOffExp
;

522 
boŞ
 
	gfound
 = 
çl£
;

523 
	gx
 = 0;

524  !
	gfound
 ) {

525 ifĞĞ
	gNextXmtTime
 > 
x
 * 
	ghŞd
 ) &&

526 Ğ
	gNextXmtTime
 <ğ(
x
+1è* 
hŞd
 ) ) 
found
 = 
Œue
;

527 
	gx
++;

529  
	gx
;

534 
boŞ


535 
	gWimshCoÜdš©ÜSnd¬d
::
–igibË


536 Ğ
xmtmx
, 
	gTempXmtTime
, 
	ghŞdexp
 )

538  ( ( 
	gxmtmx
 < 
	gTempXmtTime
 ) &&

539 Ğ
	gTempXmtTime
 <ğĞĞ
xmtmx
 + 1 ) * ( 1 << 
hŞdexp
 ) ) ) );

543 
	gWimshCoÜdš©ÜSnd¬d
::
	$šlše_sm—r
(
v®
)

545 
v®
 += ( val << 12 );

546 
v®
 ^= ( val >> 22 );

547 
v®
 += ( val << 4 );

548 
v®
 ^= ( val >> 9 );

549 
v®
 += ( val << 10 );

550 
v®
 ^= ( val >> 2 );

551 
v®
 += ( val << 7 );

552 
v®
 ^= ( val >> 12 );

553  
v®
;

554 
	}
}

557 
	gWimshCoÜdš©ÜSnd¬d
::
	$cu¼’tCŒlSlÙ
 (
txtime
)

560 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
();

563 cÚ¡ 
cur¦ÙF¿me
 = (è
	`round
 (

564 Ğ
NOW
 - 
mac_
->
	`äame
(è* 
phyMib_
->
	`äameDu¿tiÚ
(è- 
txtime
 ) /

565 
phyMib_
->
	`cÚŒŞSlÙDu¿tiÚ
() );

568  ( 
C
 * 
mac_
->
	`äame
(è+ 
cur¦ÙF¿me
 );

569 
	}
}

572 
	gWimshCoÜdš©ÜSnd¬d
::
	$cu¼’tCŒlSlÙDsch
 (
txtime
)

574 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
();

575 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

577 
¦Ù
 = 
	`cu¼’tCŒlSlÙ
();

578 
äame
 = 
¦Ù
 / 
C
;

579 
¦Ù
 -ğ
C
 * ( 1 + ( 
äame
 - 1 ) / ( 
T
 + 1 ) );

580  
¦Ù
;

581 
	}
}

584 
	gWimshCoÜdš©ÜSnd¬d
::
	$cu¼’tCŒlSlÙNcfg
 (
txtime
)

586 cÚ¡ 
C
 = 
phyMib_
->
	`cÚŒŞSlÙs
();

587 cÚ¡ 
T
 = 
phyMib_
->
	`cfgIÁ”v®
 ();

589 
¦Ù
 = 
	`cu¼’tCŒlSlÙ
(
txtime
);

590 
äame
 = 
¦Ù
 / 
C
;

591 
¦Ù
 -ğĞ1 + 
T
 * 
C
 ) * ( 
äame
 / ( T + 1 ) );

592  
¦Ù
;

593 
	}
}

	@wimsh_coordinator_std.h

20 #iâdeà
__NS2_WIMAX_COORDINATOR_STD_H


21 
	#__NS2_WIMAX_COORDINATOR_STD_H


	)

23 
	~<li¡
>

25 
	~<wimsh_coÜdš©Ü.h
>

49 şas 
	cWimshCoÜdš©ÜSnd¬d
 : 
public
 
WimshCoÜdš©Ü
 {

51 ’um { 
XMTAWARE
 = 0, 
	mXMTUNAWARE
 } 
	gty³_
;

54 
WimshPhyMib
* 
	gphyMib_
;

57 
	sMyInfo
 {

59 
	gÃxtXmtMx_
;

61 
	ghŞdOffExp_
;

63 
	gÃxtXmtTime_
;

65 
	gÃxtXmtTimeSec_
;

68 
MyInfo
 () {

69 
	gÃxtXmtMx_
 = 0;

70 
	ghŞdOffExp_
 = 0;

71 
	gÃxtXmtTime_
 = 0;

72 
	gÃxtXmtTimeSec_
 = 0;

81 
	gmaxAdv”ti£dNeighbÜs_
;

84 
	sNeighInfo
{

86 
	gÃxtXmtTime_
;

88 
	gÃxtXmtMx_
;

90 
	ghŞdOffExp_
;

92 
	g—¾SubXmtTime_
;

94 
WimaxNodeId
 
	gnodeID_
;

96 
	gnhİ_
;

98 
boŞ
 
	gcom³tšg_
;

100 
	gtimeSmp_
;

103 
NeighInfo
(
ÃxtXmtTime
, 
ÃxtXmtMx
,

104 
WimaxNodeId
 
nodeID
, 
nhİ
){

105 
	gÃxtXmtTime_
 = 
ÃxtXmtTime
; 
	gÃxtXmtMx_
 = 
ÃxtXmtMx
;

106 
	gnodeID_
 = 
nodeID
; 
	gnhİ_
 = 
nhİ
; 
	g—¾SubXmtTime_
 = 0;

107 
	gcom³tšg_
 = 
Œue
; 
	gtimeSmp_
 = 0;

111 
boŞ
 
	gİ”©Ü
 < (cÚ¡ 
NeighInfo
 
	gright
) {

112  
	gÃxtXmtTime_
 < 
	gright
.nextXmtTime_; }

121 
	g¡d
::
li¡
<
NeighInfo
> 
nghLi¡Dsch_
;

123 
	g¡d
::
m­
<
WimaxNodeId
, 
	gNeighInfo
*> 
	gnghM­Dsch_
;

126 
	g¡d
::
li¡
<
NeighInfo
> 
nghLi¡Ncfg_
;

128 
	g¡d
::
m­
<
WimaxNodeId
, 
	gNeighInfo
*> 
	gnghM­Ncfg_
;

131 
MyInfo
 
	gmyDsch_
;

133 
MyInfo
 
	gmyNcfg_
;

136 
boŞ
 
	gmaxClique_
;

138 
	gpublic
:

140 
WimshCoÜdš©ÜSnd¬d
 (
WimshMac
* 
m
, 
WimshPhyMib
* 
p
);

143 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
, 
txtime
 = 0);

145 
»cvMshNcfg
 (
WimshMshNcfg
* 
ncfg
, 
txtime
 = 0);

148 
š™Ÿlize
();

156 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

158 
	g´Ùeùed
:

160 
–eùiÚDsch
 ();

162 
–eùiÚNcfg
 ();

164 
–eùiÚN’t
 ();

167 
flS–f
 (
WimshMshDsch
* 
dsch
);

170 
flNeighbÜs
 (
WimshMshDsch
* 
dsch
);

173 
flS–f
 (
WimshMshNcfg
* 
ncfg
);

176 
flNeighbÜs
 (
WimshMshNcfg
* 
ncfg
);

178 
	g´iv©e
:

180 
¡¬t
 ();

189 
com³t™iÚ
 (
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
,
MyInfo
& 
my
,

190 
wimax
::
Bur¡Ty³
 
ty³
);

198 
com³tšgNodes
 (
TempXmtTime
,

199 
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
);

205 
boŞ
 
meshEËùiÚ
 (
TempXmtTime
,

206 
nodeID
,

207 
¡d
::
li¡
<
NeighInfo
>& 
nghLi¡
,

208 
wimax
::
Bur¡Ty³
 
ty³
);

211 
compu‹HŞdoffTime
(
hŞdOffExp
);

218 
compu‹XmtTimeMx
(
hŞdOffExp
, 
NextXmtTime
);

221 
boŞ
 
–igibË
 (
xmtmx
, 
TempXmtTime
, 
hŞdexp
);

223 
šlše_sm—r
(
v®
);

225 
cu¼’tCŒlSlÙ
(
txtime
 = 0);

227 
cu¼’tCŒlSlÙDsch
(
txtime
 = 0);

229 
cu¼’tCŒlSlÙNcfg
(
txtime
 = 0);

	@wimsh_forwarding.cc

20 
	~<wimsh_fÜw¬dšg.h
>

21 
	~<wimsh_tİŞogy.h
>

22 
	~<wimsh_mac.h
>

24 
	~<·ck‘.h
>

25 
	~<.h
>

33 
WimaxNodeId


34 
	gWimshFÜw¬dšgSpf
::
	$ÃxtHİ
 (
WimaxSdu
* 
sdu
)

36  
tİŞogy_
->
	`ÃxtHİ
 (

37 
mac_
->
	`nodeId
(), 
	`HDR_IP
(
sdu
->
	`
())->
	`daddr
());

38 
	}
}

	@wimsh_forwarding.h

20 #iâdeà
__NS2_WIMSH_FORWARDING_H


21 
	#__NS2_WIMSH_FORWARDING_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<wimsh_·ck‘.h
>

26 
şass
 
	gWimaxSdu
;

27 
şass
 
	gWimshMac
;

28 
şass
 
	gWimshTİŞogy
;

37 şas 
	cWimshFÜw¬dšg
 {

38 
	m´Ùeùed
:

40 
WimshMac
* 
mac_
;

42 
WimshTİŞogy
* 
	mtİŞogy_
;

44 
	mpublic
:

46 
	$WimshFÜw¬dšg
 (
WimshMac
* 
m
, 
WimshTİŞogy
* 
t
) :

47 
	`mac_
 (
m
), 
	$tİŞogy_
 (
t
) { }

49 
vœtu®
 ~
	$WimshFÜw¬dšg
 (è{ 
	}
}

52 
vœtu®
 
WimaxNodeId
 
ÃxtHİ
 (
WimaxSdu
* 
sdu
) = 0;

55 
vœtu®
 
commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
) = 0;

58 
vœtu®
 
š™Ÿlize
 () = 0;

61 
vœtu®
 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
) = 0;

64 
vœtu®
 
´ofe
 () = 0;

74 şas 
	cWimshFÜw¬dšgSpf
 : 
public
 
WimshFÜw¬dšg
 {

76 
public
:

78 
	$WimshFÜw¬dšgSpf
Ğ
WimshMac
* 
m
, 
WimshTİŞogy
* 
t
 ) :

79 
	$WimshFÜw¬dšg
 (
m
, 
t
) { }

81 ~
	$WimshFÜw¬dšgSpf
 (è{ 
	}
};

83 
WimaxNodeId
 
ÃxtHİ
 (
WimaxSdu
* 
sdu
);

85 
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
è{  
TCL_OK
; 
	}
}

87 
	$š™Ÿlize
 (è{ 
	}
}

89 
	$»cvMshDsch
 (
WimshMshDsch
* 
dsch
è{ 
	}
}

91 
	$´ofe
(è{ 
	}
}

	@wimsh_header.h

20 #iâdeà
__NS2_WIMSH_HEADER_H


21 
	#__NS2_WIMSH_HEADER_H


	)

24 
	sWimaxMeshCid
 {

25 
	m´iv©e
:

43 
WimaxNodeId
 
d¡_
;

45 
	mty³_
;

47 
	m»lŸb™y_
;

49 
	m´iÜ™y_
;

51 
	mdrİ_
;

53 
	mpublic
:

55 ’um { 
MANAGEMENT
 = 0x0, 
	mDATA
 = 0x1 };

58 ’um { 
	mNO_ARQ
 = 0x0, 
	mARQ
 = 0x1 };

61 ’um { 
	mMAX_PRIO
 = 8 };

64 ’um { 
	mMAX_PREC
 = 4 };

67 
WimaxMeshCid
 () {

68 
	md¡_
 = 0;

69 
	mty³_
 = 
MANAGEMENT
;

70 
	m»lŸb™y_
 = 
NO_ARQ
;

71 
	m´iÜ™y_
 = 0;

72 
	mdrİ_
 = 0;

76 
	mWimaxNodeId
& 
d¡
 (è{  
	md¡_
; }

78 & 
ty³
 (è{  
	mty³_
; }

80 & 
»lŸb™y
 (è{  
	m»lŸb™y_
; }

82 & 
´iÜ™y
 (è{  
	m´iÜ™y_
; }

84 & 
drİ
 (è{  
	mdrİ_
; }

	@wimsh_mac.cc

20 
	~<wimsh_mac.h
>

21 
	~<wimax_defs.h
>

22 
	~<wimsh_·ck‘.h
>

23 
	~<wimsh_phy.h
>

24 
	~<wimsh_chªÃl.h
>

25 
	~<wimax_bufãrs.h
>

26 
	~<wimsh_bufãrs.h
>

27 
	~<wimsh_tİŞogy.h
>

28 
	~<wimsh_fÜw¬dšg.h
>

29 
	~<wimsh_bwmªag”.h
>

30 
	~<wimsh_bwmªag”_är.h
>

31 
	~<wimsh_coÜdš©Ü.h
>

32 
	~<wimsh_coÜdš©Ü_¡d.h
>

33 
	~<wimsh_scheduËr.h
>

34 
	~<wimsh_scheduËr_är.h
>

36 
	~<Î.h
>

37 
	~<·ck‘.h
>

38 
	~<.h
>

39 
	~<¡©.h
>

41 
	~<io¡»am
>

49 şas 
	cWimshMacMibCÏss
 : 
public
 
TşCÏss
 {

50 
public
:

51 
	$WimshMacMibCÏss
(è: 
	`TşCÏss
("WimshMacMib") {}

52 
TşObjeù
* 
	$ü—‹
(, const *const*) {

53  (
Ãw
 
WimshMacMib
);

54 
	}
}

55 } 
	gşass_wimsh_mac_mib
;

58 
	gWimshMacMib
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

60 iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1], "phymib") == 0 ) {

61 
phyMib_
 = (
WimshPhyMib
*è
TşObjeù
::
	`lookup
(
¬gv
[2]);

62 
tim”_
.
	`¡¬t
 (
phyMib_
->
	`äameDu¿tiÚ
() - .000001);

63  
TCL_OK
;

64 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1], "allocation") == 0 ) {

65 iàĞ
	`¡rcmp
 (
¬gv
[2], "basic") == 0 ) {

66 
WimshMshDsch
::
	`®loÿtiÚTy³
(èğWimshMshDsch::
BASIC
;

67 } iàĞ
	`¡rcmp
 (
¬gv
[2], "contiguous") == 0 ) {

68 
WimshMshDsch
::
	`®loÿtiÚTy³
(èğWimshMshDsch::
CONTIGUOUS
;

70 
	`årštf
 (
¡d”r
, "invalid MSH-DSCH‡llocationype '%s' "

71 "PËa£ choo£ 'basic' o¸'cÚtiguous'\n", 
¬gv
[2]);

72  
TCL_ERROR
;

74  
TCL_OK
;

75 } iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
(
¬gv
[1], "crc") == 0 ) {

76 
fid
 = 
	`©oi
 (
¬gv
[2]);

77 iàĞ
fid
 < 0 ) {

78 
	`årštf
 (
¡d”r
, "šv®id flow ID '%d'\n", 
fid
);

79  
TCL_ERROR
;

81 iàĞ
	`¡rcmp
 (
¬gv
[3], "crc") == 0 ) {

82 
æow2üc_
[
fid
] = 
Œue
;

83 } iàĞ
	`¡rcmp
 (
¬gv
[2], "nocrc") == 0 ) {

84 
æow2üc_
[
fid
] = 
çl£
;

86 
	`årštf
 (
¡d”r
, "invalid command '%s' on flow ID %d. "

87 "PËa£ choo£ 'üc' o¸'noüc'\n", 
¬gv
[3], 
fid
);

88  
TCL_ERROR
;

90  
TCL_OK
;

91 } iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
(
¬gv
[1], "priority") == 0 ) {

92 
fid
 = 
	`©oi
 (
¬gv
[2]);

93 
´io
 = 
	`©oi
 (
¬gv
[3]);

94 iàĞ
	`©oi
 (
¬gv
[2]) < 0 ) {

95 
	`årštf
 (
¡d”r
, "šv®id flow ID '%d'\n", 
	`©oi
 (
¬gv
[2]));

96  
TCL_ERROR
;

98 iàĞ
´io
 <ğ
WimaxMeshCid
::
MAX_PRIO
 ) {

99 
æow2´io_
[
fid
] = 
´io
;

101 
	`årštf
 (
¡d”r
, "invalid…riority value'%d' on flow ID %d. "

102 "PËa£ choo£‡‚umb” b‘w“À0‡nd '%d''\n", 
´io
, 
fid
,

103 
WimaxMeshCid
::
MAX_PRIO
);

104  
TCL_ERROR
;

106  
TCL_OK
;

107 } iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
(
¬gv
[1], "precedence") == 0 ) {

108 
fid
 = 
	`©oi
 (
¬gv
[2]);

109 
´ec
 = 
	`©oi
 (
¬gv
[3]);

110 iàĞ
	`©oi
 (
¬gv
[2]) < 0 ) {

111 
	`årštf
 (
¡d”r
, "šv®id flow ID '%d'\n", 
	`©oi
 (
¬gv
[2]));

112  
TCL_ERROR
;

114 iàĞ
´ec
 <ğ
WimaxMeshCid
::
MAX_PREC
 ) {

115 
æow2drİ_
[
fid
] = 
´ec
;

117 
	`årštf
 (
¡d”r
, "invalid…recedence value'%d' on flow ID %d. "

118 "PËa£ choo£‡‚umb” b‘w“À0‡nd '%d''\n", 
´ec
, 
fid
,

119 
WimaxMeshCid
::
MAX_PREC
);

120  
TCL_ERROR
;

122  
TCL_OK
;

123 } if(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[1],"avlChannel") == 0) {

124 
WimshChªÃl
* 
chª
;

125 
chª
 = (
WimshChªÃl
 *è
TşObjeù
::
	`lookup
(
¬gv
[2]);

126 
avlChªÃls
.
	`push_back
(
chª
);

127  
TCL_OK
;

128 } if(
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[1],"dump") == 0) {

129 
FILE
 *
f
 = 
	`fİ’
("channel","w+");

130 
	`dump
(
f
);

131  
TCL_OK
;

134  
TCL_ERROR
;

135 
	}
}

140 
	gWimshMacMib
::
	$dump
(
FILE
 *
os
)

142 
i
 = 0; i < 
avlChªÃls
.
	`size
(); i++) {

143 
	`årštf
(
os
,"thchªÃÈi %d\n",
avlChªÃls
[
i
]->
	`uid
());

145 
	}
}

148 
	gWimshMacMib
::
	$hªdË
 ()

150 ++
äame_
;

152 iàĞ
WimaxDebug
::
	`Œaû
("WMMB::ÃxtF¿me"èè
	`årštf
 (
¡d”r
,

153 "%.9àWMMB::ÃxtF¿m %d\n", 
NOW
, 
äame_
);

154 
tim”_
.
	`¡¬t
 (
phyMib_
->
	`äameDu¿tiÚ
());

155 
	}
}

157 
	gwimax
::
Bur¡Profe


158 
WimshMacMib
::
	$g‘Bur¡Profe
 ( 
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
 )

161 
¡d
::
li¡
< 
Lšk
 >::
™”©Ü
 
™
;

162  
™
 = 
lškLi¡_
.
	`begš
(); iˆ!ğlškLi¡_.
	`’d
(); ++it ){

163 iàĞĞ
™
->
¤c_
 =ğ
¤c
 ) && ( it->
d¡_
 =ğ
d¡
 ) ) ;

165  
™
->
´ofe_
;

166 
	}
}

169 
	gWimshMacMib
::
upd©eBur¡Profe
(
WimaxNodeId
 
¤c
,

170 
WimaxNodeId
 
d¡
, 
wimax
::
Bur¡Profe
 
p
)

172 
¡d
::
li¡
< 
Lšk
 >::
™”©Ü
 
™
;

173  
	g™
 = 
lškLi¡_
.
begš
(); iˆ!ğlškLi¡_.
’d
(); ++it ){

174 iàĞĞ
	g™
->
	g¤c_
 =ğ
¤c
 ) && ( 
™
->
d¡_
 =ğ
d¡
 ) )

175 
™
->
´ofe_
 = 
p
;

178 
	glškLi¡_
.
push_back
 ( 
Lšk
Ğ
¤c
, 
d¡
, 
p
 ) );

187 şas 
	cWimshMacCÏss
 : 
public
 
TşCÏss
 {

188 
public
:

189 
	$WimshMacCÏss
(è: 
	`TşCÏss
("WimshMac") {}

190 
TşObjeù
* 
	$ü—‹
(, const *const*) {

191  (
Ãw
 
WimshMac
);

192 
	}
}

193 } 
	gşass_wimsh_mac
;

195 
	gWimshMac
::
	$WimshMac
 ()

197 
nodeId_
 = 0;

198 
phyMib_
 = 0;

199 
macMib_
 = 0;

200 
Î_
 = 0;

201 
tİŞogy_
 = 0;

202 
š™Ÿlized_
 = 
çl£
;

203 
bwmªag”_
 = 0;

204 
fÜw¬dšg_
 = 0;

205 
coÜdš©Ü_
 = 0;

206 
hS–f_
 = 0;

207 
hLa¡_
 = 0;

208 
šdex_
 = 0;

209 
¥ÚsÜS‹_
 = 
SS_IDLE
;

210 
lškE¡S‹_
 = 
LE_IDLE
;

211 
lškE¡Id_
 = 0;

212 
¥ÚsÜS¹_
 = 0;

213 
lškE¡S¹_
 = 0;

214 
lškE¡Cu¼’t_
 = 0;

215 
sÿnS¹_
 = 0;

216 
sÿnMode_
 = 
çl£
;

217 
hE¼ÜTagged_
 = 
çl£
;

218 
mshDschAvgE¼Ü_
 = -1.0;

219 
mshDschAvgGood_
 = -1.0;

220 
	}
}

223 
	gWimshMac
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

225 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "initialize") == 0 ) {

226 
	`š™Ÿlize
 ();

227  
TCL_OK
;

228 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "scan") == 0 ) {

229 
sÿnMode_
 = 
Œue
;

230 
sÿnS¹_
 = 
NOW
;

231  
TCL_OK
;

232 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "h-error-tagged") == 0 ) {

233 
hE¼ÜTagged_
 = 
Œue
;

234  
TCL_OK
;

235 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "link-establishment") == 0 ) {

236 
lškE¡Cu¼’t_
 = 0;

237 
lškE¡S‹_
 = 
LE_SEND_CHALLENGE
;

238 
lškE¡S¹_
 = 
NOW
;

239  
TCL_OK
;

240 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "open-sponsor") == 0 ) {

241 
¥ÚsÜId_
 = (
WimaxNodeId
è
	`©oi
 (
¬gv
[2]);

242 
¥ÚsÜS‹_
 = 
SS_SEND_REQ
;

243 
¥ÚsÜS¹_
 = 
NOW
;

244  
TCL_OK
;

245 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "phymib") == 0 ) {

246 
phyMib_
 = (
WimshPhyMib
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

247  
TCL_OK
;

248 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "macmib") == 0 ) {

249 
macMib_
 = (
WimshMacMib
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

250  
TCL_OK
;

251 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "ll") == 0 ) {

252 
Î_
 = (
LL
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

253  
TCL_OK
;

254 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "topology") == 0 ) {

255 
tİŞogy_
 = (
WimshTİŞogy
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

256  
TCL_OK
;

257 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "phy") == 0 ) {

258 
phy_
.
	`push_back
 ((
WimshPhy
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]));

259  
TCL_OK
;

260 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "channel") == 0 ) {

261 
chªÃl_
.
	`push_back
 ((
WimshChªÃl
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]));

262  
TCL_OK
;

263 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "nodeid") == 0 ) {

264 
nodeId_
 = (
WimaxNodeId
è
	`©oi
 (
¬gv
[2]);

265  
TCL_OK
;

266 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "index") == 0 ) {

267 
šdex_
 = (
WimaxNodeId
è
	`©oi
 (
¬gv
[2]);

268  
TCL_OK
;

269 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "msh-dsch-avg-bad") == 0 ) {

270 
mshDschAvgE¼Ü_
 = 
	`©of
 (
¬gv
[2]);

271 iàĞ
mshDschAvgE¼Ü_
 > 0 && mshDschAvgError_ < 1.0 ) {

272 
	`årštf
 (
¡d”r
, "Bad value '%f' forhe‡verage‚umber of "

274 "PËa£ s–eù‡‚umb” >ğ1.\n", 
mshDschAvgE¼Ü_
);

275  
TCL_ERROR
;

277  
TCL_OK
;

278 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "msh-dsch-avg-good") == 0 ) {

279 
mshDschAvgGood_
 = 
	`©of
 (
¬gv
[2]);

280 iàĞ
mshDschAvgGood_
 > 0 && mshDschAvgGood_ < 1.0 ) {

281 
	`årštf
 (
¡d”r
, "Bad value '%f' forhe‡verage‚umber of "

283 "PËa£ s–eù‡‚umb” >ğ1.\n", 
mshDschAvgGood_
);

284  
TCL_ERROR
;

286  
TCL_OK
;

287 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "scheduler") == 0 ) {

288 iàĞ
	`¡rcmp
 (
¬gv
[2], "fifo") == 0 ) {

289 
scheduËr_
 = 
Ãw
 
	`WimshScheduËrFifo
 (
this
);

290 } iàĞ
	`¡rcmp
 (
¬gv
[2], "fair-rr") == 0 ) {

291 
scheduËr_
 = 
Ãw
 
	`WimshScheduËrFaœRR
 (
this
);

293 
	`årštf
 (
¡d”r
, "·ck‘ scheduË¸'%s'‚Ù suµÜ‹d", 
¬gv
[2]);

294  
TCL_ERROR
;

296  
TCL_OK
;

297 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "forwarding") == 0 ) {

298 iàĞ
	`¡rcmp
 (
¬gv
[2], "spf") == 0 ) {

299 
fÜw¬dšg_
 = 
Ãw
 
	`WimshFÜw¬dšgSpf
 (
this
, 
tİŞogy_
);

300 } iàĞ
	`¡rcmp
 (
¬gv
[2], "dump") == 0 ) {

301 
	`as£¹
 ( 
š™Ÿlized_
 );

302  
fÜw¬dšg_
->
	`commªd
 ( 
¬gc
 - 2, 
¬gv
 + 2);

304 
	`årštf
 (
¡d”r
, "fÜw¬dšg moduË '%s'‚Ù suµÜ‹d", 
¬gv
[2]);

305  
TCL_ERROR
;

307  
TCL_OK
;

308 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "bwmanager") == 0 ) {

309 iàĞ
	`¡rcmp
 (
¬gv
[2], "dummy") == 0 ) {

310 
bwmªag”_
 = 
Ãw
 
	`WimshBwMªag”Dummy
 (
this
);

313 } iàĞ
	`¡rcmp
 (
¬gv
[2], "fair-rr") == 0 ) {

314 
bwmªag”_
 = 
Ãw
 
	`WimshBwMªag”FaœRR
 (
this
);

316 
	`årštf
 (
¡d”r
, "bªdwidth mªag” '%s'‚Ù suµÜ‹d", 
¬gv
[2]);

317  
TCL_ERROR
;

319  
TCL_OK
;

320 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "coordinator") == 0 ) {

321 iàĞ
	`¡rcmp
 (
¬gv
[2], "dummy") == 0 ) {

322 
coÜdš©Ü_
 = 
Ãw
 
	`WimshCoÜdš©ÜDummy
 (
this
, 
phyMib_
);

323 } iàĞ
	`¡rcmp
 (
¬gv
[2], "standard") == 0 ) {

324 
coÜdš©Ü_
 = 
Ãw
 
	`WimshCoÜdš©ÜSnd¬d
 (
this
, 
phyMib_
);

326 
	`årštf
 (
¡d”r
, "coÜdš©Ü '%s'‚Ù suµÜ‹d", 
¬gv
[2]);

327  
TCL_ERROR
;

329  
TCL_OK
;

330 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "dump") == 0 ) {

331 iàĞ
	`¡rcmp
 (
¬gv
[2], "profile") == 0 ) {

332 
¡d
::
m­
<
WimaxNodeId
, >::
™”©Ü
 
™
 = 
Ãigh2ndx_
.
	`begš
();

333  ; 
™
 !ğ
Ãigh2ndx_
.
	`’d
() ; it++ ) {

334 
	`årštf
 (
¡d”r
, "%.9f %d -> %d…rofile %s‡lpha %d\n",

335 
NOW
, 
nodeId_
, 
™
->
fœ¡
,

336 
WimaxDebug
::
	`fÜm©
(
´ofe_
[
™
->
£cÚd
]), 
®pha_
[it->second]);

339  
TCL_ERROR
;

341  
TCL_OK
;

342 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "estcurr") == 0 ) {

343 
hE¡Cu¼_
 = 
	`©of
 (
¬gv
[2]);

344 iàĞ
hE¡Cu¼_
 < 0 || hEstCurr_ > 1.0 ) {

345 
	`årštf
 (
¡d”r
, "invalid weight '%f' forhe current sample of "

346 "the¡im©iÚ oàH. Choo£‡ v®uš [0, 1]\n", 
hE¡Cu¼_
);

347  
TCL_ERROR
;

349  
TCL_OK
;

350 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "estpast") == 0 ) {

351 
hE¡Pa¡_
 = 
	`©of
 (
¬gv
[2]);

352 iàĞ
hE¡Pa¡_
 < 0 || hEstPast_ > 1.0 ) {

353 
	`årštf
 (
¡d”r
, "invalid weight '%f' forhe…ast sample of "

354 "the¡im©iÚ oàH. Choo£‡ v®uš [0, 1]\n", 
hE¡Pa¡_
);

355  
TCL_ERROR
;

357  
TCL_OK
;

358 } iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
 (
¬gv
[1], "profile") == 0 ) {

359 
	`as£¹
 ( 
š™Ÿlized_
 );

362 
wimax
::
Bur¡Profe
 
bp
 = (wimax::Bur¡Profeè
	`©oi
 (
¬gv
[2]);

364 iàĞ
bp
 >ğ
wimax
::
N_BURST_PROFILES
 ) {

365 
	`årštf
 (
¡d”r
, "burst…rofile %d is‚ot valid. "

367 
bp
, 
wimax
::
N_BURST_PROFILES
 - 1);

368  
TCL_ERROR
;

373 iàĞ
	`¡rcmp
 (
¬gv
[3], "all") == 0 ) {

376 
¡d
::
veùÜ
<
WimaxNodeId
> 
ÃighbÜs
;

377 
¡d
::
veùÜ
<
WimaxNodeId
>::
™”©Ü
 
™
;

378 
tİŞogy_
->
	`ÃighbÜs
 (
nodeId_
, 
ÃighbÜs
);

382  
™
 = 
ÃighbÜs
.
	`begš
(è; iˆ!ğÃighbÜs.
	`’d
() ; ++it ) {

383 
ndx
 = 
Ãigh2ndx_
[*
™
];

384 
´ofe_
[
ndx
] = 
bp
;

385 
®pha_
[
ndx
] = 
WimshPhyMib
::
®pha
[
bp
];

386 
macMib_
->
	`upd©eBur¡Profe
 ( 
	`nodeId
(), *
™
, 
bp
 );

392 
WimaxNodeId
 
Ãigh
 = (WimaxNodeIdè
	`©oi
 (
¬gv
[3]);

394 iàĞ
Ãigh2ndx_
.
	`couÁ
 (
Ãigh
) != 1 ) {

395 
	`årštf
 (
¡d”r
, "node %d is‚ot‡‚eighbor of‚ode %d\n",

396 
nodeId_
, 
Ãigh
);

397  
TCL_ERROR
;

401 
ndx
 = 
Ãigh2ndx_
[
Ãigh
];

404 
´ofe_
[
ndx
] = 
bp
;

405 
®pha_
[
ndx
] = 
WimshPhyMib
::
®pha
[
bp
];

406 
macMib_
->
	`upd©eBur¡Profe
 ( 
	`nodeId
(), 
Ãigh
, 
bp
 );

409  
TCL_OK
;

412 } iàĞ
¬gc
 > 2 && 
	`¡rcmp
 (
¬gv
[1], "bwmanager") == 0 ) {

413 
	`as£¹
 ( 
š™Ÿlized_
 );

414  
bwmªag”_
->
	`commªd
 ( 
¬gc
 - 2, 
¬gv
 + 2);

417 } iàĞ
¬gc
 > 2 && 
	`¡rcmp
 (
¬gv
[1], "forwarding") == 0 ) {

418 
	`as£¹
 ( 
š™Ÿlized_
 );

419  
fÜw¬dšg_
->
	`commªd
 ( 
¬gc
 - 2, 
¬gv
 + 2);

422 } iàĞ
¬gc
 > 2 && 
	`¡rcmp
 (
¬gv
[1], "coordinator") == 0 ) {

423 
	`as£¹
 ( 
š™Ÿlized_
 );

424  
coÜdš©Ü_
->
	`commªd
 ( 
¬gc
 - 2, 
¬gv
 + 2);

427 } iàĞ
¬gc
 > 2 && 
	`¡rcmp
 (
¬gv
[1], "scheduler") == 0 ) {

428 
	`as£¹
 ( 
š™Ÿlized_
 );

429  
scheduËr_
->
	`commªd
 (
¬gc
 - 2, 
¬gv
 + 2);

432  
TCL_ERROR
;

433 
	}
}

436 
	gWimshMac
::
	$š™Ÿlize
 ()

439 
	`as£¹
 ( ! 
š™Ÿlized_
 );

442 
¡d
::
veùÜ
<
WimaxNodeId
> 
ÃighbÜs
;

443 
tİŞogy_
->
	`ÃighbÜs
 (
nodeId_
, 
ÃighbÜs
);

446 
Âeighs_
 = 
ÃighbÜs
.
	`size
();

449 
®pha_
.
	`»size
 (
Âeighs_
);

450 
´ofe_
.
	`»size
 (
Âeighs_
);

451 
äagbuf_
.
	`»size
 (
Âeighs_
);

452 
»asbuf_
.
	`»size
 (
Âeighs_
);

453 
hNeigh_
.
	`»size
 (
Âeighs_
);

454 
hNeighLa¡_
.
	`»size
 (
Âeighs_
);

455 
ndx2Ãigh_
.
	`»size
 (
Âeighs_
);

456 
mshDschLškQu®™y_
.
	`»size
 (
Âeighs_
);

467  
i
 = 0 ; i < 
Âeighs_
 ; i++ ) {

468 
Ãigh2ndx_
[
ÃighbÜs
[
i
]] = i;

469 
ndx2Ãigh_
[
i
] = 
ÃighbÜs
[i];

470 
´ofe_
[
i
] = 
wimax
::
QPSK_1_2
;

471 
®pha_
[
i
] = 
WimshPhyMib
::
®pha
[
wimax
::
QPSK_1_2
];

472 
äagbuf_
[
i
] = 
Ãw
 
WimshF¿gm’tiÚBufãr
;

473 
»asbuf_
[
i
] = 
Ãw
 
WimaxR—s£mblyBufãr
;

474 
hNeigh_
[
i
] = 0;

475 
hNeighLa¡_
[
i
] = 0;

476 
mshDschLškQu®™y_
[
i
].
äames_
 =

477 
	`geom‘ric
 (
mshDschRngGood_
, 1/
mshDschAvgGood_
);

479 
macMib_
->
	`upd©eBur¡Profe
 ( 
	`nodeId
(), 
ÃighbÜs
[
i
],

480 
wimax
::
QPSK_1_2
 );

485 
scheduËr_
->
	`š™Ÿlize
();

486 
bwmªag”_
->
	`š™Ÿlize
();

487 
coÜdš©Ü_
->
	`š™Ÿlize
();

488 
fÜw¬dšg_
->
	`š™Ÿlize
();

491 
	`£tCÚŒŞChªÃl
 (
wimax
::
RX
);

494 
š™Ÿlized_
 = 
Œue
;

495 
	}
}

500 
	gWimshMac
::
	$»cvPack‘
 (
Pack‘
* 
pkt
)

502 
	`as£¹
 ( 
š™Ÿlized
 ) ;

504 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::»cvPack‘"èè
	`årštf
 (
¡d”r
,

506 
NOW
, 
nodeId_
, 
WimaxDebug
::
	`fÜm©
 (
pkt
));

509 
WimaxSdu
* 
sdu
 = 
Ãw
 WimaxSdu;

510 
sdu
->
	`
(èğ
pkt
;

513 
	`»cvSdu
 (
sdu
);

514 
	}
}

517 
	gWimshMac
::
	$»cvSdu
 (
WimaxSdu
* 
sdu
)

519 
	`as£¹
 ( 
š™Ÿlized
 ) ;

521 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::»cvSdu"èè
	`årštf
 (
¡d”r
,

523 
NOW
, 
nodeId_
, 
WimaxDebug
::
	`fÜm©
(
sdu
));

527 iàĞ(
WimaxNodeId
è
	`HDR_IP
(
sdu
->
	`
())->
	`daddr
(è=ğ
nodeId_
 ) {

528 
	`HDR_CMN
(
sdu
->
	`
())->
	`dœeùiÚ
 (èğ
hdr_cmn
::
UP
;

529 
Î_
->
	`»cv
 (
sdu
->
	`
(), 0);

530 
d–‘e
 
sdu
;

538 
Pack‘
* 

 = 
sdu
->
	`
();

541 
fid
 = 
	`HDR_IP
(

)->
	`æowid
();

544 
sdu
->
	`addHİ
 (
nodeId_
);

547 
sdu
->
	`time¡amp
(èğ
NOW
;

550 
WimaxPdu
* 
pdu
 = 
Ãw
 WimaxPdu;

551 
pdu
->
	`sdu
(èğ
sdu
;

554 
pdu
->
	`nodeId
(èğ
nodeId_
;

556 
pdu
->
	`hdr
().
	`üc
(èğ
macMib_
->
	`æow2üc
 (
fid
);

558 
pdu
->
	`hdr
().
	`mesh
(èğ
Œue
;

559 
pdu
->
	`hdr
().
	`meshCid
().
	`ty³
(èğ
WimaxMeshCid
::
DATA
;

561 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
(èğ
macMib_
->
	`æow2´io
 (
fid
);

562 
pdu
->
	`hdr
().
	`meshCid
().
	`drİ
(èğ
macMib_
->
	`æow2drİ
 (
fid
);

563 
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
(èğ
fÜw¬dšg_
->
	`ÃxtHİ
 (
sdu
);

564 
pdu
->
	`size
 (
sdu
->size());

567 
scheduËr_
->
	`addPdu
 (
pdu
);

569 
	}
}

572 
	gWimshMac
::
	$»cvMshDsch
 (
WimshMshDsch
* 
dsch
, 
txtime
)

574 
	`as£¹
 ( 
š™Ÿlized
 ) ;

576 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::»cvMshDsch"èè
	`årštf
 (
¡d”r
,

577 "%.9àWMAC::»cvMshDsch[%d]\n", 
NOW
, 
nodeId_
);

580 
WimaxNodeId
 
¢ode
 = 
dsch
->
	`my£lf
().
nodeId_
;

581 
ndx
 = 
Ãigh2ndx_
[
¢ode
];

582 
St
::
	`put
 ("wimsh_dsch_š‹r_äame_rcv", 
šdex_
,

583 
	`round
 ( ( 
NOW
 - 
hNeighLa¡_
[
ndx
] ) / 
phyMib_
->
	`äameDu¿tiÚ
() ) );

584 
St
::
	`put
 ("wimsh_dsch_š‹r_time_rcv", 
šdex_
, 
NOW
 - 
hNeighLa¡_
[
ndx
]);

585 
St
::
	`put
 ("wimsh_dsch_š‹r_time_rcv_d", 
šdex_
, 
NOW
 - 
hNeighLa¡_
[
ndx
]);

586 
	`upd©eH
 (
hNeigh_
[
ndx
], 
hNeighLa¡_
[ndx]);

590 iàĞ
hE¼ÜTagged_
 ) {

591 
diff
 = 
	`çbs
 ( 
dsch
->
	`my£lf
().
ÃxtXmtTimeSec_
 - 
hNeigh_
[
ndx
] );

600 
St
::
	`put
 ("wimsh_dsch_h_”rÜ", 
šdex_
, 
diff
);

604 
coÜdš©Ü_
->
	`»cvMshDsch
 (
dsch
, 
txtime
);

605 
bwmªag”_
->
	`»cvMshDsch
 (
dsch
);

606 
fÜw¬dšg_
->
	`»cvMshDsch
 (
dsch
);

607 
	}
}

610 
	gWimshMac
::
	$»cvMshNcfg
 (
WimshMshNcfg
* 
ncfg
, 
txtime
)

612 
	`as£¹
 ( 
š™Ÿlized
 ) ;

614 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::»cvMshNcfg"èè
	`årštf
 (
¡d”r
,

615 "%.9àWMAC::»cvMshNcfg[%d]\n", 
NOW
, 
nodeId_
);

617 
coÜdš©Ü_
->
	`»cvMshNcfg
 (
ncfg
, 
txtime
);

619 iàĞ
sÿnMode_
 ) {

622 iàĞ
sÿnS‘_
.
	`couÁ
 (
ncfg
->
	`¤c
()) == 1 ) {

623 
St
::
	`put
 ("wimsh_sÿn_Ï‹ncy", 
šdex_
, 
NOW
 - 
sÿnS¹_
);

624 ** 
¬gv
 = 
Ãw
 *[1];

625 
¬gv
[0] = "print";

626 
St
::
	`commªd
 (1, 
¬gv
);

627 
	`ex™
 (0);

629 
sÿnS‘_
.
	`š£¹
 (
ncfg
->
	`¤c
());

635 iàĞ
ncfg
->
	`ty³
(è=ğ
WimshMshNcfg
::
CHALLENGE
 &&

636 
ncfg
->
	`hdr
().
	`meshCid
().
	`d¡
(è=ğ
nodeId_
 ) {

639 
lškE¡S‹_
 = 
LE_SEND_RESPONSE
;

640 
lškE¡Id_
 = 
ncfg
->
	`¤c
();

641 } iàĞ
ncfg
->
	`ty³
(è=ğ
WimshMshNcfg
::
RESPONSE
 &&

642 
ncfg
->
	`hdr
().
	`meshCid
().
	`d¡
(è=ğ
nodeId_
 ) {

645 
lškE¡S‹_
 = 
LE_SEND_ACK
;

647 
	}
}

650 
	gWimshMac
::
	$»cvMshN’t
 (
WimshMshN’t
* 
ÃÁ
, 
txtime
)

652 
	`as£¹
 ( 
š™Ÿlized
 ) ;

654 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::»cvMshN’t"èè
	`årštf
 (
¡d”r
,

655 "%.9àWMAC::»cvMshN’t[%d]\n", 
NOW
, 
nodeId_
);

659 iàĞ
ÃÁ
->
	`hdr
().
	`meshCid
().
	`d¡
(è=ğ
nodeId_
 ) {

662 
¥ÚsÜS‹_
 = 
SS_SEND_OPEN
;

663 
¥ÚsÜId_
 = 
ÃÁ
->
	`¤c
();

665 
	}
}

668 
	gWimshMac
::
	$İpÜtun™y
 (
WimshMshDsch
* 
dsch
)

670 
	`as£¹
 ( 
š™Ÿlized
 ) ;

672 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::İpÜtun™y"èè
	`årštf
 (
¡d”r
,

673 "%.9àWMAC::İpÜtun™y[%d] MSH-DSCH\n", 
NOW
, 
nodeId_
);

676 
bwmªag”_
->
	`scheduË
 (
dsch
);

679 
WimshBur¡
* 
bur¡
 = 
Ãw
 WimshBurst;

680 
bur¡
->
	`addMshDsch
 (
dsch
);

682 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::opportunity") )

683 
WimaxDebug
::
	`´št
 (
dsch
, 
¡d”r
);

685 
St
::
	`put
 ("wimsh_dsch_š‹r_äame_¢d", 
šdex_
,

686 
	`round
 ( ( 
NOW
 - 
hLa¡_
 ) / 
phyMib_
->
	`äameDu¿tiÚ
() ) );

687 
St
::
	`put
 ("wimsh_dsch_š‹r_time_¢d", 
šdex_
, 
NOW
 - 
hLa¡_
);

688 
St
::
	`put
 ("wimsh_dsch_š‹r_time_¢d_d", 
šdex_
, 
NOW
 - 
hLa¡_
);

689 
St
::
	`put
 ("wimsh_dsch_size_a", 
šdex_
, 
dsch
->
	`size
());

690 
St
::
	`put
 ("wimsh_dsch_size_d", 
šdex_
, 
dsch
->
	`size
());

693 
	`upd©eH
 (
hS–f_
, 
hLa¡_
);

696 
	`£tCÚŒŞChªÃl
 (
wimax
::
TX
);

699 
phy_
[0]->
	`£ndBur¡
 (
bur¡
);

700 
	}
}

703 
	gWimshMac
::
	$İpÜtun™y
 (
WimshMshNcfg
* 
ncfg
)

705 
	`as£¹
 ( 
š™Ÿlized
 ) ;

707 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::İpÜtun™y"èè
	`årštf
 (
¡d”r
,

708 "%.9àWMAC::İpÜtun™y[%d] MSH-NCFG\n", 
NOW
, 
nodeId_
);

710 
St
::
	`put
 ("wimsh_ncfg_š‹r_äame", 
šdex_
,

711 
	`round
 ( ( 
NOW
 - 
hLa¡Ncfg_
 ) / 
phyMib_
->
	`äameDu¿tiÚ
() ) );

712 
St
::
	`put
 ("wimsh_ncfg_š‹r_time", 
šdex_
, 
NOW
 - 
hLa¡Ncfg_
);

713 
hLa¡Ncfg_
 = 
NOW
;

716 
WimshBur¡
* 
bur¡
 = 
Ãw
 WimshBurst;

717 
bur¡
->
	`addMshNcfg
 (
ncfg
);

719 
ncfg
->
	`¤c
(èğ
nodeId_
;

722 iàĞ
¥ÚsÜS‹_
 =ğ
SS_SEND_OPEN
 ) {

723 
ncfg
->
	`ty³
(èğ
WimshMshNcfg
::
NET_ENTRY_OPEN
;

724 
ncfg
->
	`hdr
().
	`meshCid
().
	`d¡
(èğ
¥ÚsÜId_
;

725 
¥ÚsÜS‹_
 = 
SS_IDLE
;

729 
¡d
::
veùÜ
<
WimaxNodeId
> 
ÃighbÜs
;

730 
tİŞogy_
->
	`ÃighbÜs
 (
nodeId_
, 
ÃighbÜs
);

732 iàĞ
lškE¡S‹_
 =ğ
LE_SEND_CHALLENGE
 ) {

733 
ncfg
->
	`hdr
().
	`meshCid
().
	`d¡
(èğ
ÃighbÜs
[
lškE¡Cu¼’t_
];

734 
ncfg
->
	`ty³
(èğ
WimshMshNcfg
::
CHALLENGE
;

735 
lškE¡S‹_
 = 
LE_WAIT_RESPONSE
;

739 } iàĞ
lškE¡S‹_
 =ğ
LE_SEND_ACK
 ) {

742 
lškE¡Cu¼’t_
++;

743 
lškE¡S‹_
 = 
LE_SEND_CHALLENGE
;

745 iàĞ
lškE¡Cu¼’t_
 >ğ
ÃighbÜs
.
	`size
() ) {

746 
St
::
	`put
 ("wimsh_lške¡_Ï‹ncy", 
šdex_
, 
NOW
 - 
lškE¡S¹_
);

747 ** 
¬gv
 = 
Ãw
 *[1];

748 
¬gv
[0] = "print";

749 
St
::
	`commªd
 (1, 
¬gv
);

750 
	`ex™
 (0);

753 } iàĞ
lškE¡S‹_
 =ğ
LE_SEND_RESPONSE
 ) {

756 
ncfg
->
	`hdr
().
	`meshCid
().
	`d¡
(èğ
lškE¡Id_
;

757 
ncfg
->
	`ty³
(èğ
WimshMshNcfg
::
RESPONSE
;

758 
lškE¡S‹_
 = 
LE_IDLE
;

762 
	`£tCÚŒŞChªÃl
 (
wimax
::
TX
);

765 
phy_
[0]->
	`£ndBur¡
 (
bur¡
);

766 
	}
}

769 
	gWimshMac
::
	$İpÜtun™y
 (
WimshMshN’t
* 
ÃÁ
)

771 
	`as£¹
 ( 
š™Ÿlized
 ) ;

773 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::İpÜtun™y"èè
	`årštf
 (
¡d”r
,

774 "%.9àWMAC::İpÜtun™y[%d] MSH-NENT\n", 
NOW
, 
nodeId_
);

776 
St
::
	`put
 ("wimsh_ÃÁ_š‹r_äame", 
šdex_
,

777 
	`round
 ( ( 
NOW
 - 
hLa¡N’t_
 ) / 
phyMib_
->
	`äameDu¿tiÚ
() ) );

778 
St
::
	`put
 ("wimsh_ÃÁ_š‹r_time", 
šdex_
, 
NOW
 - 
hLa¡N’t_
);

779 
hLa¡N’t_
 = 
NOW
;

781 iàĞ
¥ÚsÜS‹_
 !ğ
SS_SEND_REQ
 && spÚsÜS‹_ !ğ
SS_SEND_ACK
 ) {

782 
d–‘e
 
ÃÁ
;

786 iàĞ
¥ÚsÜS‹_
 =ğ
SS_SEND_REQ
 ) {

789 
ÃÁ
->
	`ty³
(èğ
WimshMshN’t
::
REQUEST
;

790 
¥ÚsÜS‹_
 = 
SS_SEND_ACK
;

791 } iàĞ
¥ÚsÜS‹_
 =ğ
SS_SEND_ACK
 ) {

794 
St
::
	`put
 ("wimsh_¥ÚsÜ_Ï‹ncy", 
šdex_
, 
NOW
 - 
¥ÚsÜS¹_
);

795 ** 
¬gv
 = 
Ãw
 *[1];

796 
¬gv
[0] = "print";

797 
St
::
	`commªd
 (1, 
¬gv
);

798 
	`ex™
 (0);

801 
	`abÜt
 ();

803 
ÃÁ
->
	`hdr
().
	`meshCid
().
	`d¡
(èğ
¥ÚsÜId_
;

804 
ÃÁ
->
	`¤c
(èğ
nodeId_
;

806 
WimshBur¡
* 
bur¡
 = 
Ãw
 WimshBurst;

807 
bur¡
->
	`addMshN’t
 (
ÃÁ
);

808 
bur¡
->
	`sourû
(èğ
nodeId_
;

811 
	`£tCÚŒŞChªÃl
 (
wimax
::
TX
);

814 
phy_
[0]->
	`£ndBur¡
 (
bur¡
);

815 
	}
}

818 
	gWimshMac
::
	$»cvBur¡
 (
WimshBur¡
* 
bur¡
)

820 
	`as£¹
 ( 
š™Ÿlized
 ) ;

822 iàĞ
WimaxDebug
::
	`Œaû
("WMAC::recvBurst") ) {

823 
	`årštf
 (
¡d”r
,

825 
NOW
, 
nodeId_
, 
bur¡
->
	`sourû
(), bur¡->
	`”rÜ
());

826 
WimaxDebug
::
	`´št
 (
bur¡
, 
¡d”r
);

832 iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ) {

836 iàĞ
mshDschAvgE¼Ü_
 > 0 && mshDschAvgError_ > 0 ) {

838 
LškQu®™y
& 
lšk
 = 
mshDschLškQu®™y_
[
Ãigh2ndx_
[
bur¡
->
	`sourû
()]];

842 iàĞ! 
lšk
.
good_
 ) 
bur¡
->
	`”rÜ
(èğ
Œue
;

846 iàĞ--
lšk
.
äames_
 == 0 ) {

848 iàĞ! 
lšk
.
good_
 )

849 
lšk
.
äames_
 = 
	`geom‘ric
 (
mshDschRngGood_
, 1/
mshDschAvgGood_
);

851 
lšk
.
äames_
 = 
	`geom‘ric
 (
mshDschRngE¼Ü_
, 1/
mshDschAvgE¼Ü_
);

854 
lšk
.
good_
 = !†ink.good_;

860 iàĞ! 
bur¡
->
	`”rÜ
() ) {

861 
St
::
	`put
 ("wimsh_dsch_”rÜ", 
šdex_
, 0.0);

862 
	`»cvMshDsch
 (
bur¡
->
	`mshDsch
(), bur¡->
	`txtime
());

864 
St
::
	`put
 ("wimsh_dsch_”rÜ", 
šdex_
, 1.0);

867 } iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ) {

868 iàĞ! 
bur¡
->
	`”rÜ
(èè
	`»cvMshNcfg
 (bur¡->
	`mshNcfg
(), bur¡->
	`txtime
());

870 } iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) {

871 iàĞ! 
bur¡
->
	`”rÜ
(èè
	`»cvMshN’t
 (bur¡->
	`mshN’t
(), bur¡->
	`txtime
());

879  
WimaxPdu
* 
pdu
 = 
bur¡
->
	`pdu
() ;…du != 0 ;…du = burst->pdu() ) {

885 iàĞ! 
bur¡
->
	`”rÜ
(è&& ! 
pdu
->error() &&

886 
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
(è=ğ
nodeId_
 ) {

888 
St
::
	`put
 ("wimsh_mac_t", 
šdex_
, 
pdu
->
	`size
());

889 
WimaxSdu
* 
sdu
 = 
»asbuf_
[
Ãigh2ndx_
[
pdu
->
	`nodeId
()]]->
	`addPdu
 (pdu);

891 iàĞ
sdu
 ) {

893 cÚ¡ 
fid
 = 
	`HDR_IP
(
sdu
->
	`
())->
	`æowid
();

894 cÚ¡ 
d–ay
 = 
NOW
 - 
sdu
->
	`time¡amp
();

895 
St
::
	`put
 ("wimsh_d–ay_acûss_a", 
fid
, 
d–ay
);

896 
St
::
	`put
 ("wimsh_d–ay_acûss_d", 
fid
, 
d–ay
);

897 
St
::
	`put
 ("wimsh_d–ay_hİbyhİ_a", 
šdex_
, 
d–ay
);

898 
St
::
	`put
 ("wimsh_d–ay_hİbyhİ_d", 
šdex_
, 
d–ay
);

901 
bwmªag”_
->
	`»ûived
 (

902 
	`HDR_IP
(
sdu
->
	`
())->
	`§ddr
(),

903 
	`HDR_IP
(
sdu
->
	`
())->
	`daddr
(),

904 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
(),

905 
Ãigh2ndx_
[
sdu
->
	`Ï¡Hİ
()], 
pdu
->
	`size
()

907 
	`»cvSdu
 (
sdu
);

912 
pdu
->
	`sdu
()->
	`ä“Paylßd
 ();

913 
d–‘e
 
pdu
->
	`sdu
();

916 
d–‘e
 
pdu
;

921 
d–‘e
 
bur¡
;

922 
	}
}

925 
	gWimshMac
::
	$upd©eH
 (& 
h
, & 
Ï¡
)

927 
h
 = 
hE¡Pa¡_
 * h + 
hE¡Cu¼_
 * (
NOW
 - 
Ï¡
);

928 
Ï¡
 = 
NOW
;

929 
	}
}

932 
	gWimshMac
::
£tCÚŒŞChªÃl
 (
wimax
::
ChªÃlStus
 
s
)

934 iàĞ
WimaxDebug
::
Œaû
 ("WMAC::£tCÚŒŞChªÃl" ) ) 
årštf
 (
¡d”r
,

936 
NOW
, 
nodeId_
,

937 (
s
 =ğ
wimax
::
TX
è? "TX" : ( =ğwimax::
RX
) ? "RX" : "NONE");

939 
	gphy_
[0]->
£tMode
 (
s
, 
chªÃl_
[0]);

943 
	gWimshMac
::
	$»ûive
 (
chªÃl
)

945 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::»ûive" ) ) 
	`årštf
 (
¡d”r
,

947 
NOW
, 
nodeId_
, 
chªÃl
);

949 
phy_
[0]->
	`£tMode
 ( 
wimax
::
RX
, 
chªÃl_
[
chªÃl
] );

950 
	}
}

953 
	gWimshMac
::
	$Œªsm™
 (
¿nge
, 
WimaxNodeId
 
d¡
, 
chªÃl
)

955 iàĞ
WimaxDebug
::
	`Œaû
 ("WMAC::Œªsm™" ) ) 
	`årštf
 (
¡d”r
,

957 
NOW
, 
nodeId_
, 
d¡
, 
¿nge
, 
chªÃl
);

960 cÚ¡ 
ndx
 = 
Ãigh2ndx_
[
d¡
];

964 
by‹s
 = 
	`¦Ùs2by‹s
 (
ndx
, 
¿nge
, 
Œue
);

967 
boŞ
 
room
 = 
äagbuf_
[
ndx
]->
	`ÃwBur¡
 (
´ofe_
[ndx], 
by‹s
);

970 iàĞ
room
 ) 
scheduËr_
->
	`scheduË
 (*
äagbuf_
[
ndx
], 
d¡
);

973 iàĞ
äagbuf_
[
ndx
]->
	`g‘Bur¡
()->
	`Ådus
() == 0 ) {

974 
d–‘e
 
äagbuf_
[
ndx
]->
	`g‘Bur¡
();

983 cÚ¡ 
¥¬e
 =

984 Ğ
äagbuf_
[
ndx
]->
	`g‘Bur¡
()->
	`Ådus
() > 0 )

985 ? 
by‹s
 - 
äagbuf_
[
ndx
]->
	`g‘Bur¡
()->
	`size
()

986 : 
by‹s
;

987 iàĞ
scheduËr_
->
	`ÃighbÜ
 (
ndx
è> 0 && 
¥¬e
 > 0 )

988 
bwmªag”_
->
	`backlog
 (
d¡
, 
¥¬e
);

991 
phy_
[0]->
	`£tMode
 ( 
wimax
::
TX
, 
chªÃl_
[
chªÃl
] );

999 
WimshBur¡
::
Li¡
& 
pdus
 = 
äagbuf_
[
ndx
]->
	`g‘Bur¡
()->
	`pdus
();

1000 
WimshBur¡
::
Li¡
::
cÚ¡_™”©Ü
 
™
 = 
pdus
.
	`begš
();

1003  ; 
™
 !ğ
pdus
.
	`’d
() ; ++it ) {

1005 
backlog
 = 0;

1008 
WimaxPdu
* 
pdu
 = *
™
;

1011 iàĞ
pdu
->
	`hdr
().
	`äagm’tiÚ
() ) {

1012 iàĞ
pdu
->
	`fsh
().
	`¡©e
(è=ğ
WimaxFsh
::
FIRST_FRAG
 )

1013 
backlog
 = 
WimaxFsh
::
	`size
();

1015 
backlog
 = 
pdu
->
	`hdr
().
	`size
(è+ 
WimaxPdu
::
	`meshSubhdrSize
(è+ 
WimaxFsh
::size();

1019 iàĞ
backlog
 ) {

1020 
bwmªag”_
->
	`backlog
 (

1021 (
WimaxNodeId
è
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`§ddr
(),

1022 (
WimaxNodeId
è
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`daddr
(),

1023 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
(),

1024 
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
(),

1025 
backlog
 );

1030 
WimshBur¡
* 
bur¡
 = 
äagbuf_
[
ndx
]->
	`g‘Bur¡
();

1031 iàĞ
bur¡
->
	`Ådus
() > 0 ) {

1032 
bwmªag”_
->
	`£Á
 ( 
d¡
, 
bur¡
->
	`size
() );

1033 
phy_
[0]->
	`£ndBur¡
 ( 
bur¡
 );

1035 
	}
}

	@wimsh_mac.h

20 #iâdeà
__NS2_WIMSH_MAC_H


21 
	#__NS2_WIMSH_MAC_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<t_tim”s.h
>

25 
	~<wimsh_phy.h
>

26 
	~<ºg.h
>

28 
	~<veùÜ
>

29 
	~<m­
>

30 
	~<£t
>

32 
şass
 
	gWimshPhyMib
;

33 
şass
 
	gWimshMacMib
;

34 
şass
 
	gWimshChªÃl
;

35 
şass
 
	gWimshPhy
;

36 
şass
 
	gWimshScheduËr
;

37 
şass
 
	gWimaxSdu
;

38 
şass
 
	gWimshMshDsch
;

39 
şass
 
	gWimshMshNcfg
;

40 
şass
 
	gWimshMshN’t
;

41 
şass
 
	gWimshTİŞogy
;

42 
şass
 
	gWimshF¿gm’tiÚBufãr
;

43 
şass
 
	gWimaxR—s£mblyBufãr
;

44 
şass
 
	gWimshBwMªag”
;

45 
şass
 
	gWimshFÜw¬dšg
;

46 
şass
 
	gWimshCoÜdš©Ü
;

47 
şass
 
	gWimshPhyMib
;

48 
şass
 
	gWimshBur¡
;

49 
şass
 
	gWimshMshCscf
;

50 
şass
 
	gWimshMshCsch
;

52 
şass
 
	gPack‘
;

53 
şass
 
	gLL
;

56 şas 
	cWimshMacMib
 : 
public
 
TşObjeù
 {

58 
TTim”
<
WimshMacMib
> 
tim”_
;

60 
WimshPhyMib
* 
	mphyMib_
;

62 
	mäame_
;

70 
	m¡d
::
m­
<, 
	mboŞ
> 
	mæow2üc_
;

78 
	m¡d
::
m­
<, > 
	mæow2´io_
;

86 
	m¡d
::
m­
<, > 
	mæow2drİ_
;

93 
	sLšk
 {

95 
WimaxNodeId
 
	m¤c_
;

97 
WimaxNodeId
 
	md¡_
;

99 
	mwimax
::
Bur¡Profe
 
´ofe_
;

101 
Lšk
Ğ
WimaxNodeId
 
¤c
 = 0, WimaxNodeId 
d¡
 = 0,

102 
wimax
::
Bur¡Profe
 
p
 = wimax::
QPSK_1_2
 ) {

103 
¤c_
 = 
¤c
; 
	md¡_
 = 
d¡
; 
	m´ofe_
 = 
p
;

108 
	g¡d
::
li¡
< 
Lšk
 > 
lškLi¡_
;

111 
	g¡d
::
veùÜ
<
WimshChªÃl
*> 
avlChªÃls
;

112 
	gpublic
:

114 
	$WimshMacMib
 (è: 
	`tim”_
(
this
), 
	`phyMib_
(0), 
	`äame_
 (0è{ 
	}
}

116 
	gvœtu®
 ~
	$WimshMacMib
 (è{ 
	}
}

119 
hªdË
 ();

122 
	$äame
 (è{  
äame_
; 
	}
}

125 
boŞ
 
	$æow2üc
 (
æowId
) {

126  ( 
æow2üc_
.
	`couÁ
(
æowId
è=ğ1 ) ? flow2üc_[æowId] : 
çl£
; 
	}
}

128 
	$æow2´io
 (
æowId
) {

129  ( 
æow2´io_
.
	`couÁ
(
æowId
è=ğ1 ) ? flow2´io_[æowId] : 0; 
	}
}

131 
	$æow2drİ
 (
æowId
) {

132  ( 
æow2drİ_
.
	`couÁ
(
æowId
è=ğ1 ) ? flow2drİ_[æowId] : 0; 
	}
}

134 
upd©eBur¡Profe
 ( 
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
wimax
::
Bur¡Profe
 
p
 );

136 
	gwimax
::
Bur¡Profe
 
g‘Bur¡Profe
 ( 
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
 );

139 
WimshChªÃl
* 
	$g‘Av®ibËChªÃl
(
id
è{  
avlChªÃls
[id]; 
	}
}

140 
	g´Ùeùed
:

141 
dump
(
FILE
 *);

155 
vœtu®
 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

159 şas 
	cWimshMac
 : 
public
 
TşObjeù
 {

162 
	eSpÚsÜS‹
 { 
SS_IDLE
, 
	mSS_SEND_REQ
, 
	mSS_SEND_ACK
, 
	mSS_SEND_OPEN
 };

165 
	eLškE¡S‹
 { 
	gLE_IDLE
, 
	gLE_SEND_CHALLENGE
, 
	gLE_WAIT_RESPONSE
,

166 
	gLE_SEND_RESPONSE
, 
	gLE_SEND_ACK
 };

169 
	sLškQu®™y
 {

171 
boŞ
 
	ggood_
;

173 
	gäames_
;

175 
LškQu®™y
 () {

176 
	ggood_
 = 
Œue
;

177 
	gäames_
 = 0;

182 
WimshPhyMib
* 
	gphyMib_
;

184 
WimshMacMib
* 
	gmacMib_
;

187 
LL
* 
	gÎ_
;

189 
WimshTİŞogy
* 
	gtİŞogy_
;

192 
WimshScheduËr
* 
	gscheduËr_
;

203 
	g¡d
::
m­
<
WimaxNodeId
, > 
	gÃigh2ndx_
;

205 
	g¡d
::
veùÜ
<
WimaxNodeId
> 
ndx2Ãigh_
;

216 
	g¡d
::
veùÜ
<> 
®pha_
;

224 
	g¡d
::
veùÜ
<
wimax
::
Bur¡Profe
> 
´ofe_
;

230 
	g¡d
::
veùÜ
<
WimshF¿gm’tiÚBufãr
*> 
äagbuf_
;

236 
	g¡d
::
veùÜ
<
WimaxR—s£mblyBufãr
*> 
»asbuf_
;

239 
	g¡d
::
veùÜ
<> 
hNeigh_
;

242 
	g¡d
::
veùÜ
<> 
hNeighLa¡_
;

245 
	ghS–f_
;

248 
	ghLa¡_
;

250 
	ghLa¡Ncfg_
;

252 
	ghLa¡N’t_
;

255 
	ghE¡Cu¼_
;

257 
	ghE¡Pa¡_
;

260 
SpÚsÜS‹
 
	g¥ÚsÜS‹_
;

262 
	g¥ÚsÜS¹_
;

264 
WimaxNodeId
 
	g¥ÚsÜId_
;

267 
LškE¡S‹
 
	glškE¡S‹_
;

269 
	glškE¡S¹_
;

271 
	glškE¡Cu¼’t_
;

273 
WimaxNodeId
 
	glškE¡Id_
;

276 
boŞ
 
	gsÿnMode_
;

278 
	gsÿnS¹_
;

280 
	g¡d
::
£t
<
WimaxNodeId
> 
sÿnS‘_
;

287 
	g¡d
::
veùÜ
<
WimshPhy
*> 
phy_
;

302 
	g¡d
::
veùÜ
<
WimshChªÃl
*> 
chªÃl_
;

305 
WimshBwMªag”
* 
	gbwmªag”_
;

308 
WimshFÜw¬dšg
* 
	gfÜw¬dšg_
;

311 
WimshCoÜdš©Ü
* 
	gcoÜdš©Ü_
;

314 
WimaxNodeId
 
	gnodeId_
;

317 
	gÂeighs_
;

320 
boŞ
 
	gš™Ÿlized_
;

323 
boŞ
 
	ghE¼ÜTagged_
;

326 
	gšdex_
;

329 
	gmshDschAvgE¼Ü_
;

331 
	gmshDschAvgGood_
;

333 
RNG
 
	gmshDschRngE¼Ü_
;

335 
RNG
 
	gmshDschRngGood_
;

337 
	g¡d
::
veùÜ
<
LškQu®™y
> 
mshDschLškQu®™y_
;

339 
	gpublic
:

341 
WimshMac
 ();

343 
	gvœtu®
 ~
	$WimshMac
 (è{ 
	}
}

346 
»cvPack‘
 (
Pack‘
* 
pkt
);

352 
»cvSdu
 (
WimaxSdu
* 
sdu
);

354 
»cvMshDsch
 (
WimshMshDsch
* 
dsch
, 
txtime
);

356 
»cvMshNcfg
 (
WimshMshNcfg
* 
ncfg
, 
txtime
);

358 
»cvMshN’t
 (
WimshMshN’t
* 
ÃÁ
, 
txtime
);

360 
»cvBur¡
 (
WimshBur¡
* 
bur¡
);

370 
İpÜtun™y
 (
WimshMshDsch
* 
dsch
);

372 
İpÜtun™y
 (
WimshMshNcfg
* 
ncfg
);

374 
İpÜtun™y
 (
WimshMshN’t
* 
ÃÁ
);

377 
WimaxNodeId
 
	$nodeId
 (è{  
nodeId_
; 
	}
}

390 
£tCÚŒŞChªÃl
 (
wimax
::
ChªÃlStus
 
s
);

393 
	$äame
 (è{  
macMib_
->
	`äame
(); 
	}
}

395 
WimshMacMib
* 
	$macMib
 (è{  
macMib_
; 
	}
}

397 
WimshPhyMib
* 
	$phyMib
 (è{  
phyMib_
; 
	}
}

399 
WimshTİŞogy
* 
	$tİŞogy
 (è{  
tİŞogy_
; 
	}
}

401 
WimshScheduËr
* 
	$scheduËr
 (è{  
scheduËr_
; 
	}
}

403 
WimshBwMªag”
* 
	$bwmªag”
 (è{  
bwmªag”_
; 
	}
}

411 
	$Ãigh2ndx
 (
WimaxNodeId
 
n
è{  
Ãigh2ndx_
[n]; 
	}
}

414 
WimaxNodeId
 
	$ndx2Ãigh
 (
n
è{  
ndx2Ãigh_
[n]; 
	}
}

417 
	$®pha
 (
n
è{  
®pha_
[n]; 
	}
}

436 
	$by‹s2¦Ùs
 (
n
,

437 
by‹s
,

438 
boŞ
 
´—mbË
 = 
çl£
) {

439 iàĞ
by‹s
 == 0 )  0;

440 
p
 = ( 
´—mbË
 =ğ
Œue
 ) ? 
phyMib_
->
	`symShÜtP»ambË
() : 0;

441  1 + ( 
p
 + ( 
by‹s
 - 1 ) / 
®pha_
[
n
] ) / 
phyMib_
->
	`symP”SlÙ
(); 
	}
}

450 
	$¦Ùs2by‹s
 (
n
,

451 
¦Ùs
,

452 
boŞ
 
´—mbË
 = 
çl£
 ) {

453 
p
 = ( 
´—mbË
 =ğ
Œue
 ) ? 
phyMib_
->
	`symShÜtP»ambË
() : 0;

454  
®pha_
[
n
] * ( 
¦Ùs
 * 
phyMib_
->
	`symP”SlÙ
(è- 
p
 ); 
	}
}

457 
	$h
 (
WimaxNodeId
 
x
) {

458  ( 
x
 =ğ
nodeId_
 ) ? 
hS–f_
 : 
hNeigh_
[
Ãigh2ndx_
[x]]; 
	}
}

461 
»ûive
 (
chªÃl
);

464 
Œªsm™
 (
¿nge
, 
WimaxNodeId
 
d¡
, 
chªÃl
);

467 
	$Âeighs
 (è{  
Âeighs_
; 
	}
}

470 
	$nchªÃls
 (è{  
chªÃl_
.
	`size
(); 
	}
}

473 
	$šdex
 (è{  
šdex_
; 
	}
}

475 
	g´Ùeùed
:

477 
vœtu®
 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

479 
	g´iv©e
:

481 
š™Ÿlize
 ();

484 
upd©eH
 (& 
h
, & 
Ï¡
);

487 
	$geom‘ric
 (
RNG
& 
ºg
, 
p
) {

488  ( 
p
 == 1.0 ) ? 1 :

489 (è
	`û
 ( 
	`log
 (
ºg
.
	`unifÜm
()è/†og (1 - 
p
));

490 
	}
}

496 şas 
	cBSWimshMac
 : 
public
 
WimshMac
 {

497 
public
:

498 
BSWimshMac
();

499 ~
BSWimshMac
();

501 
»cvMshCsch
(
WimshMshCsch
* 
csch
,
txtime
);

505 şas 
	cSSWimshMac
 : 
public
 
WimshMac
 {

506 
public
:

507 
SSWimshMac
();

508 ~
SSWimshMac
();

510 
»cvMshCscf
(
WimshMshCscf
* 
cscf
,
txtime
);

511 
»cvMshCsch
(
WimshMshCsch
* 
csch
,
txtime
);

	@wimsh_packet.cc

20 
	~<wimsh_·ck‘.h
>

29 
	gWimshBur¡
::
	$addMshDsch
 (
WimshMshDsch
* 
m
)

31 
mshDsch_
 = 
m
;

34 
ty³_
 = 
wimax
::
MSHDSCH
;

37 
size_
 = 
mshDsch_
->
	`size
 ();

38 
	}
}

41 
	gWimshBur¡
::
	$addMshNcfg
 (
WimshMshNcfg
* 
m
)

43 
mshNcfg_
 = 
m
;

44 
ty³_
 = 
wimax
::
MSHNCFG
;

45 
size_
 = 
mshNcfg_
->
	`size
 ();

46 
	}
}

49 
	gWimshBur¡
::
	$addMshN’t
 (
WimshMshN’t
* 
m
)

51 
mshN’t_
 = 
m
;

52 
ty³_
 = 
wimax
::
MSHNENT
;

53 
size_
 = 
mshN’t_
->
	`size
 ();

54 
	}
}

57 
	gWimshBur¡
::~
	$WimshBur¡
 ()

60 
¡d
::
li¡
<
WimaxPdu
*>::
™”©Ü
 
™
;

61  
™
 = 
pdus_
.
	`begš
(è; iˆ!ğpdus_.
	`’d
() ; ++it ) {

62 (*
™
)->
	`sdu
()->
	`ä“Paylßd
();

63 
	`d–‘e
 (*
™
)->
	`sdu
();

64 
	`d–‘e
 (*
™
);

68 iàĞ
mshDsch_
 ) 
d–‘e
 mshDsch_;

69 iàĞ
mshNcfg_
 ) 
d–‘e
 mshNcfg_;

70 iàĞ
mshN’t_
 ) 
d–‘e
 mshNent_;

71 
	}
}

73 
	gWimshBur¡
::
	$WimshBur¡
 (cÚ¡ 
WimshBur¡
& 
obj
)

76 
txtime_
 = 
obj
.txtime_;

79 
”rÜ_
 = 
obj
.error_;

82 
´ofe_
 = 
obj
.profile_;

83 
ty³_
 = 
obj
.type_;

86 
size_
 = 
obj
.size_;

89 
¤c_
 = 
obj
.src_;

93 
¡d
::
li¡
<
WimaxPdu
*>::
cÚ¡_™”©Ü
 
™
;

94  
™
 = 
obj
.
pdus_
.
	`begš
(è; iˆ!ğobj.pdus_.
	`’d
() ; ++it ) {

95 
WimaxPdu
* 
pdu
 = 
Ãw
 
	`WimaxPdu
 (*(*
™
));

96 
WimaxSdu
* 
sdu
 = 
Ãw
 
	`WimaxSdu
 (*(*
™
)->
	`sdu
());

97 
sdu
->
	`cİyPaylßd
 ((*
™
)->
	`sdu
());

98 
pdu
->
	`sdu
(èğ
sdu
;

100 
pdus_
.
	`push_back
 (
pdu
);

104 iàĞ
obj
.
mshDsch_
 ) mshDsch_ = 
Ãw
 
	`WimshMshDsch
 (*obj.mshDsch_);

105 
mshDsch_
 = 0;

107 iàĞ
obj
.
mshNcfg_
 ) mshNcfg_ = 
Ãw
 
	`WimshMshNcfg
 (*obj.mshNcfg_);

108 
mshNcfg_
 = 0;

110 iàĞ
obj
.
mshN’t_
 ) mshN’t_ = 
Ãw
 
	`WimshMshN’t
 (*obj.mshNent_);

111 
mshN’t_
 = 0;

112 
	}
}

120 
	gWimshMshDsch
::
AÎoÿtiÚTy³


121 
WimshMshDsch
::
®loÿtiÚTy³_
 = WimshMshDsch::
BASIC
;

124 
	gWimshMshDsch
::
	$¦Ùs2Ëv–
 (

125 
N
, 
mši¦Ùs
,

126 & 
Ëv–
, 
P”si¡’û
& 
³rsi¡’û
)

128 iàĞ
mši¦Ùs
 <ğ
N
 ) {

129 
Ëv–
 = 
mši¦Ùs
;

130 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME1
;

131 } iàĞ
mši¦Ùs
 <ğ2 * 
N
 ) {

132 
Ëv–
 = 1 + ( 
mši¦Ùs
 - 1 ) / 2;

133 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME2
;

134 } iàĞ
mši¦Ùs
 <ğ4 * 
N
 ) {

135 
Ëv–
 = 1 + ( 
mši¦Ùs
 - 1 ) / 4;

136 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME4
;

137 } iàĞ
mši¦Ùs
 <ğ8 * 
N
 ) {

138 
Ëv–
 = 1 + ( 
mši¦Ùs
 - 1 ) / 8;

139 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME8
;

140 } iàĞ
mši¦Ùs
 <ğ32 * 
N
 ) {

141 
Ëv–
 = 1 + ( 
mši¦Ùs
 - 1 ) / 32;

142 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME32
;

143 } iàĞ
mši¦Ùs
 <ğ128 * 
N
 ) {

144 
Ëv–
 = 1 + ( 
mši¦Ùs
 - 1 ) / 128;

145 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME128
;

147 
Ëv–
 = 
N
;

148 
³rsi¡’û
 = 
WimshMshDsch
::
FRAME128
;

150 
	}
}

153 
	gWimshMshDsch
::
	$addCÚtiguous
 (
GÁIE
& 
x
)

155 
¡d
::
li¡
<
GÁIE
>::
™”©Ü
 
™
;

158  
™
 = 
gÁ_
.
	`begš
(è; iˆ!ğgÁ_.
	`’d
() ; ++it ) {

159 iàĞ
x
.
nodeId_
 =ğ
™
->nodeId_ &&

160 
x
.
äame_
 =ğ
™
->frame_ &&

161 
x
.
³rsi¡’û_
 =ğ
™
->persistence_ &&

162 
x
.
äomReque¡”_
 =ğ
™
->fromRequester_ &&

163 
x
.
chªÃl_
 =ğ
™
->channel_ ) {

166 iàĞ
x
.
¡¬t_
 + x.
¿nge_
 =ğ
™
->start_ ) {

167 
™
->
¡¬t_
 = 
x
.start_;

168 
™
->
¿nge_
 = 
x
.range_ + it->range_;

172 } iàĞ
™
->
¡¬t_
 + it->
¿nge_
 =ğ
x
.start_ ) {

173 
™
->
¿nge_
 = 
x
.range_ + it->range_;

182 iàĞ
™
 =ğ
gÁ_
.
	`’d
() ) {

183 
hdr_
.
	`Ëngth
(è+ğ
GÁIE
::
	`size
();

184 
gÁ_
.
	`push_äÚt
(
x
);

186 
	}
}

189 
	gWimshMshDsch
::
	$addCÚtiguous
 (
AvlIE
& 
x
)

191 
¡d
::
li¡
<
AvlIE
>::
™”©Ü
 
™
;

194  
™
 = 
avl_
.
	`begš
(è; iˆ!ğavl_.
	`’d
() ; ++it ) {

195 iàĞ
x
.
äame_
 =ğ
™
->frame_ &&

196 
x
.
³rsi¡’û_
 =ğ
™
->persistence_ &&

197 
x
.
chªÃl_
 =ğ
™
->channel_ ) {

200 iàĞ
x
.
¡¬t_
 + x.
¿nge_
 =ğ
™
->start_ ) {

201 
™
->
¡¬t_
 = 
x
.start_;

202 
™
->
¿nge_
 = 
x
.range_ + it->range_;

206 } iàĞ
™
->
¡¬t_
 + it->
¿nge_
 =ğ
x
.start_ ) {

207 
™
->
¿nge_
 = 
x
.range_ + it->range_;

216 iàĞ
™
 =ğ
avl_
.
	`’d
() ) {

217 
hdr_
.
	`Ëngth
(è+ğ
AvlIE
::
	`size
();

218 
avl_
.
	`push_äÚt
(
x
);

220 
	}
}

	@wimsh_packet.h

20 #iâdeà
__NS2_WIMSH_PACKET_H


21 
	#__NS2_WIMSH_PACKET_H


	)

23 
	~<li¡
>

24 
	~<veùÜ
>

26 
	~<wimax_·ck‘.h
>

39 
	sWimshMshDsch
 {

40 
	mpublic
:

42 ’um { 
MAX_SEQ
 = 63 };

44 ’um { 
	mMAX_REQ
 = 15 };

46 ’um { 
	mMAX_AVL
 = 15 };

48 ’um { 
	mMAX_GNT
 = 63 };

50 ’um { 
	mMAX_NGH
 = 255 };

52 ’um { 
	mMAX_SIZE
 = 96 };

55 
	eP”si¡’û
 {

56 
	mCANCEL
 = 0, 
	mFRAME1
, 
	mFRAME2
, 
	mFRAME4
,

57 
	mFRAME8
, 
	mFRAME32
, 
	mFRAME128
, 
	mFOREVER
 };

60 
	eDœeùiÚ
 { 
	mUNAVAILABLE
 = 0, 
	mTX_ONLY
, 
	mRX_ONLY
, 
	mAVAILABLE
 };

63 
	sReqIE
 {

65 
WimaxNodeId
 
	mnodeId_
;

67 
	mËv–_
;

69 
P”si¡’û
 
	m³rsi¡’û_
;

72 
size
 () {  3; }

76 
	sAvlIE
 {

78 
	mäame_
;

80 
	m¡¬t_
;

82 
	m¿nge_
;

84 
DœeùiÚ
 
	mdœeùiÚ_
;

86 
P”si¡’û
 
	m³rsi¡’û_
;

88 
	mchªÃl_
;

91 
size
 () {  4; }

95 
	sGÁIE
 {

97 
WimaxNodeId
 
	mnodeId_
;

99 
	mäame_
;

101 
	m¡¬t_
;

103 
	m¿nge_
;

105 
boŞ
 
	mäomReque¡”_
;

107 
P”si¡’û
 
	m³rsi¡’û_
;

109 
	mchªÃl_
;

112 
size
 () {  5; }

116 
	sNghIE
 {

118 
WimaxNodeId
 
	mnodeId_
;

120 
	mÃxtXmtMx_
;

122 
	mxmtHŞdoffExpÚ’t_
;

124 
	mÃxtXmtTime_
;

126 
	mÃxtXmtTimeSec_
;

129 
size
 () {  3; }

133 
	eAÎoÿtiÚTy³
 { 
	mBASIC
, 
	mCONTIGUOUS
 };

135 
	m´iv©e
:

137 
WimaxMacH—d”
 
hdr_
;

139 
WimaxNodeId
 
	m¤c_
;

142 
	mn£q_
;

144 
	mÄeq_
;

146 
	mÇvl_
;

148 
	mngÁ_
;

150 
	mÂgh_
;

153 
	m¡d
::
li¡
<
AvlIE
> 
avl_
;

155 
	m¡d
::
li¡
<
ReqIE
> 
»q_
;

157 
	m¡d
::
li¡
<
GÁIE
> 
gÁ_
;

159 
	m¡d
::
li¡
<
NghIE
> 
ngh_
;

162 
NghIE
 
	mmy£lf_
;

165 
AÎoÿtiÚTy³
 
	m®loÿtiÚTy³_
;

167 
	mpublic
:

169 
WimshMshDsch
 () {

170 
hdr_
.
üc
(èğ
Œue
;

171 
	mhdr_
.
äagm’tiÚ
(èğ
çl£
;

172 
	mhdr_
.
Ëngth
() = 15;

174 
	mn£q_
 = 0;

175 
	mÄeq_
 = 0;

176 
	mÇvl_
 = 0;

177 
	mngÁ_
 = 0;

178 
	mÂgh_
 = 0;

181 
size
 (è{  
	mhdr_
.
Ëngth
(); }

183 
»maššg
 (è{  
	mMAX_SIZE
 - 
size
(); }

186 
WimaxMacH—d”
 
hdr
 (è{  
	mhdr_
; }

188 
	mWimaxNodeId
& 
¤c
 (è{  
	m¤c_
; }

191 
add
 (
AvlIE
 
x
) {

192 iàĞ
	m®loÿtiÚTy³_
 =ğ
BASIC
 ) {

193 
hdr_
.
Ëngth
(è+ğ
AvlIE
::
size
(); 
	mavl_
.
push_äÚt
(
x
);

194 } iàĞ
	m®loÿtiÚTy³_
 =ğ
CONTIGUOUS
 ) 
addCÚtiguous
 (
x
);

195  
»maššg
(); }

197 
add
 (
ReqIE
 
x
) {

198 
	mhdr_
.
Ëngth
(è+ğ
ReqIE
::
size
(); 
	m»q_
.
push_äÚt
(
x
);  
»maššg
(); }

200 
add
 (
GÁIE
 
x
) {

201 iàĞ
	m®loÿtiÚTy³_
 =ğ
BASIC
 ) {

202 
hdr_
.
Ëngth
(è+ğ
GÁIE
::
size
(); 
	mgÁ_
.
push_äÚt
(
x
);

203 } iàĞ
	m®loÿtiÚTy³_
 =ğ
CONTIGUOUS
 ) 
addCÚtiguous
 (
x
);

204  
»maššg
(); }

206 
add
 (
NghIE
 
x
) {

207 
	mhdr_
.
Ëngth
(è+ğ
NghIE
::
size
(); 
	mngh_
.
push_äÚt
(
x
);  
»maššg
(); }

210 
	mNghIE
& 
my£lf
 (è{  
	mmy£lf_
; }

212 
	m¡d
::
li¡
<
AvlIE
>& 
avl
 (è{  
avl_
; }

214 
	m¡d
::
li¡
<
ReqIE
>& 
»q
 (è{  
»q_
; }

216 
	m¡d
::
li¡
<
GÁIE
>& 
gÁ
 (è{  
gÁ_
; }

218 
	m¡d
::
li¡
<
NghIE
>& 
ngh
 (è{  
ngh_
; }

221 
¦Ùs2Ëv–
 (
N
, 
mši¦Ùs
,

222 & 
Ëv–
, 
P”si¡’û
& 
³rsi¡’û
);

225 
	mAÎoÿtiÚTy³
& 
®loÿtiÚTy³
 (è{  
	m®loÿtiÚTy³_
; }

228 
³rs2äames
 (
P”si¡’û
 
p
) {

229  ( 
	mp
 =ğ
CANCEL
 ) ? 0 :

230 Ğ
p
 =ğ
FRAME1
 ) ? 1 :

231 Ğ
p
 =ğ
FRAME2
 ) ? 2 :

232 Ğ
p
 =ğ
FRAME4
 ) ? 4 :

233 Ğ
p
 =ğ
FRAME8
 ) ? 8 :

234 Ğ
p
 =ğ
FRAME32
 ) ? 32 :

235 Ğ
p
 =ğ
FRAME128
 ) ? 128 : 
UINT_MAX
; }

237 
	m´Ùeùed
:

239 
addCÚtiguous
 (
GÁIE
& 
x
);

241 
addCÚtiguous
 (
AvlIE
& 
x
);

245 
	sWimshMshNcfg
 {

246 
	mpublic
:

248 ’um { 
MAX_NGH
 = 255 };

250 ’um { 
	mMAX_SIZE
 = 96 };

263 
	eTy³
 { 
	mNET_ENTRY_OPEN
, 
	mCHALLENGE
, 
	mRESPONSE
, 
	mACK
 };

266 
	sNghIE
 {

268 
WimaxNodeId
 
	mnodeId_
;

270 
	mÃxtXmtMx_
;

272 
	mxmtHŞdoffExpÚ’t_
;

274 
	mÃxtXmtTime_
;

277 
size
 () {  3; }

280 
	m´iv©e
:

282 
WimaxMacH—d”
 
hdr_
;

284 
WimaxNodeId
 
	m¤c_
;

287 
	mÂgh_
;

290 
	m¡d
::
li¡
<
NghIE
> 
ngh_
;

293 
NghIE
 
	mmy£lf_
;

296 
Ty³
 
	mty³_
;

298 
	mpublic
:

300 
WimshMshNcfg
 () {

301 
hdr_
.
üc
(èğ
Œue
;

302 
	mhdr_
.
äagm’tiÚ
(èğ
çl£
;

303 
	mhdr_
.
Ëngth
() = 20;

305 
	mÂgh_
 = 0;

306 
	mty³_
 = 
NET_ENTRY_OPEN
;

309 
size
 (è{  
	mhdr_
.
Ëngth
(); }

311 
»maššg
 (è{  
	mMAX_SIZE
 - 
size
(); }

314 
	mWimaxMacH—d”
& 
hdr
 (è{  
	mhdr_
; }

316 
	mWimaxNodeId
& 
¤c
 (è{  
	m¤c_
; }

318 
	mTy³
& 
ty³
 (è{  
	mty³_
; }

321 
add
 (
NghIE
 
x
) {

322 
	mhdr_
.
Ëngth
(è+ğ
NghIE
::
size
(); 
	mngh_
.
push_äÚt
(
x
);  
»maššg
(); }

325 
	mNghIE
& 
my£lf
 (è{  
	mmy£lf_
; }

327 
	m¡d
::
li¡
<
NghIE
>& 
ngh
 (è{  
ngh_
; }

331 
	sWimshMshN’t
 {

332 
	mpublic
:

341 
	eTy³
 { 
REQUEST
, 
	mACK
 };

343 ’um { 
	mMAX_SIZE
 = 96 };

345 
	m´iv©e
:

347 
WimaxMacH—d”
 
hdr_
;

349 
WimaxNodeId
 
	m¤c_
;

351 
Ty³
 
	mty³_
;

353 
	mpublic
:

355 
WimshMshN’t
 () {

356 
hdr_
.
üc
(èğ
Œue
;

357 
	mhdr_
.
äagm’tiÚ
(èğ
çl£
;

358 
	mhdr_
.
Ëngth
() = 20;

360 
	mty³_
 = 
REQUEST
;

363 
size
 (è{  
	mhdr_
.
Ëngth
(); }

365 
»maššg
 (è{  
	mMAX_SIZE
 - 
size
(); }

368 
	mWimaxMacH—d”
& 
hdr
 (è{  
	mhdr_
; }

370 
	mWimaxNodeId
& 
¤c
 (è{  
	m¤c_
; }

372 
	mTy³
& 
ty³
 (è{  
	mty³_
; }

377 
	sWimshMshCsch
 {

378 
	mäame_num
;

380 
boŞ
 
	mæag_
;

383 
	mæowSÿËExpÚ’t
;

386 
boŞ
 
	mäameSchFÏg
;

388 
	sFlowEÁry
 {

389 
	mupFlow
;

390 
	mdownFlow
;

392 
size
() {  8;}

394 
	m¡d
::
li¡
<
FlowEÁry
*> 
æowEÁr›s
;

402 
	sWimshMshCscf
 {

404 
	m¡d
::
veùÜ
<> 
chªÃls
;

407 
	mäame_num
;

409 
	sNodeInf
 {

410 
	mNodeId
;

413 
	sChdInf
 {

414 
	mchdId
;

416 
	mwimax
::
Bur¡Profe
 
up
;

417 
	mwimax
::
Bur¡Profe
 
down
;

419 
size
() {  16; }

422 
	m¡d
::
li¡
<
ChdInf
*> 
chd»n
;

424 
size
(è{ (
	mchd»n
.size(è* 
	mChdInf
::size() + 24); }

427 
	m¡d
::
li¡
<
NodeInf
*> 
nodes
;

448 
	sWimshBur¡
 {

449 
	mpublic
:

450 
¡d
::
	tli¡
<
	tWimaxPdu
*> 
	tLi¡
;

452 
	m´iv©e
:

458 
Li¡
 
pdus_
;

460 
WimshMshDsch
* 
	mmshDsch_
;

463 
WimshMshNcfg
* 
	mmshNcfg_
;

466 
WimshMshN’t
* 
	mmshN’t_
;

469 
WimshMshCsch
* 
	mmshCsch_
;

470 
WimshMshCscf
* 
	mmshCscf_
;

476 
	mtxtime_
;

478 
boŞ
 
	m”rÜ_
;

480 
	mwimax
::
Bur¡Profe
 
´ofe_
;

482 
	mwimax
::
Bur¡Ty³
 
ty³_
;

484 
	msize_
;

486 
WimaxNodeId
 
	m¤c_
;

488 
	mpublic
:

490 
WimshBur¡
 () {

491 
”rÜ_
 = 
çl£
; 
	msize_
 = 0; 
	mmshDsch_
 = 0; 
	mmshNcfg_
 = 0; 
	mmshN’t_
 = 0;

492 
	m´ofe_
 = 
wimax
::
QPSK_1_2
; 
	mty³_
 = wimax::
DATA
; }

494 ~
WimshBur¡
 ();

500 
WimshBur¡
 (cÚ¡ WimshBur¡& 
obj
);

503 
addD©a
 (
WimaxPdu
* 
pdu
, 
boŞ
 

 = 
Œue
 ) {

504 iàĞ

 ) 
pdus_
.
push_back
 (
pdu
); 
	mpdus_
.
push_äÚt
 (pdu);

505 
	msize_
 +ğ
pdu
->
size
(); }

507 
WimaxPdu
* 
pdu
 () {

508 iàĞ
	mpdus_
.
em±y
() )  0;

509 
WimaxPdu
* 
	mtmp
 = 
pdus_
.
äÚt
(); 
	mpdus_
.
pİ_äÚt
(); mp; }

512 
	mLi¡
& 
pdus
 (è{  
	mpdus_
; }

514 
Ådus
 (è{  
	mpdus_
.
size
(); }

517 
	mWimshMshDsch
*& 
mshDsch
 (è{  
	mmshDsch_
; }

519 
addMshDsch
 (
WimshMshDsch
* 
m
);

522 
	mWimshMshNcfg
*& 
mshNcfg
 (è{  
	mmshNcfg_
; }

524 
addMshNcfg
 (
WimshMshNcfg
* 
m
);

527 
	mWimshMshN’t
*& 
mshN’t
 (è{  
	mmshN’t_
; }

529 
addMshN’t
 (
WimshMshN’t
* 
m
);

531 
addMshCsch
(
WimshMshCsch
* 
m
);

532 
addMshCscf
(
WimshMshCscf
* 
m
);

536 & 
txtime
 (è{  
	mtxtime_
; }

538 
	mboŞ
& 
”rÜ
 (è{  
	m”rÜ_
; }

540 
	mwimax
::
Bur¡Profe
& 
´ofe
 (è{  
´ofe_
; }

543 
	mwimax
::
Bur¡Ty³
& 
ty³
 (è{  
ty³_
; }

545 
size
 (è{  
	msize_
; }

548 
	mWimaxNodeId
& 
sourû
 (è{  
	m¤c_
; }

549 
	m´iv©e
:

550 
İ”©Ü
ğ(cÚ¡ 
WimshBur¡
&);

	@wimsh_phy.cc

20 
	~<m©h.h
>

22 
	~<wimsh_phy.h
>

23 
	~<wimsh_·ck‘.h
>

24 
	~<wimsh_chªÃl.h
>

25 
	~<wimsh_mac.h
>

26 
	~<wimsh_tİŞogy.h
>

34 şas 
	cWimshPhyMibCÏss
 : 
public
 
TşCÏss
 {

35 
public
:

36 
	$WimshPhyMibCÏss
(è: 
	`TşCÏss
("WimshPhyMib") {}

37 
TşObjeù
* 
	$ü—‹
(, const *const*) {

38  (
Ãw
 
WimshPhyMib
);

39 
	}
}

40 } 
	gşass_wimsh_phy_mib
;

42 cÚ¡ 
	gWimshPhyMib
::
®pha
[] = {

45 
	gWimshPhyMib
::
	$WimshPhyMib
 ()

47 
äameDu¿tiÚ_
 = 0;

48 
symDu¿tiÚ_
 = 0;

49 
symP”F¿me_
 = 0;

50 
cÚŒŞSlÙs_
 = 0;

51 
	}
}

54 
	gWimshPhyMib
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

56 iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "symDuration") == 0 ) {

57 
symDu¿tiÚ_
 = 1.0e-6 * 
	`©of
 (
¬gv
[2]);

58  
TCL_OK
;

59 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "frameDuration") == 0 ) {

60 
äameDu¿tiÚ_
 = 1.0e-3 * 
	`©of
 (
¬gv
[2]);

61  
TCL_OK
;

62 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "controlSlots") == 0 ) {

63 
cÚŒŞSlÙs_
 = (è
	`©oi
 (
¬gv
[2]);

64  
TCL_OK
;

65 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "cfg-interval") == 0 ) {

66 
cfgIÁ”v®_
 = (è
	`©oi
 (
¬gv
[2]);

67  
TCL_OK
;

68 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "recompute") == 0 ) {

69 iàĞ
	`»compu‹
(è=ğ
Œue
 )  
TCL_OK
;

70 
	`årštf
 (
¡d”r
, "Invalid PHY…arameters selection\n");

71  
TCL_ERROR
;

72 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "dump") == 0 ) {

73 
	`dump
 (
¡d”r
);

74  
TCL_OK
;

76  
TCL_ERROR
;

77 
	}
}

80 
	gWimshPhyMib
::
	$dump
 (
FILE
* 
os
)

82 
	`årštf
 (
os
, "frame duration = %f ms\n"

89 1.0e3 * 
	`äameDu¿tiÚ
(),

90 1.0e6 * 
	`symDu¿tiÚ
(),

91 
	`symP”F¿me
(),

92 
	`symP”SlÙ
(),

93 
	`¦ÙP”F¿me
(),

94 
	`cÚŒŞSlÙs
(),

95 
	`cfgIÁ”v®
());

96 
	}
}

98 
boŞ


99 
	gWimshPhyMib
::
	$»compu‹
 ()

101 
symP”F¿me_
 = (è(
äameDu¿tiÚ_
 / 
symDu¿tiÚ_
);

102 iàĞ7 * 
cÚŒŞSlÙs_
 > 
symP”F¿me_
 - 1 )  
çl£
;

103 
symP”SlÙ_
 = 1 + ( 
symP”F¿me_
 - 7 * 
cÚŒŞSlÙs_
 - 1 ) / 256;

104 
¦ÙP”F¿me_
 = ( 
symP”F¿me_
 - 7 * 
cÚŒŞSlÙs_
 ) / 
symP”SlÙ_
;

105 iàĞ
¦ÙP”F¿me_
 =ğ0 )  
çl£
;

106  
Œue
;

107 
	}
}

110 
	gWimshPhyMib
::
	$ÃxtF¿me
 ()

112  
	`äameDu¿tiÚ
(è* 
	`û
 ( 
NOW
 / frameDuration() );

113 
	}
}

121 şas 
	cWimshPhyCÏss
 : 
public
 
TşCÏss
 {

122 
public
:

123 
	$WimshPhyCÏss
(è: 
	`TşCÏss
("WimshPhy") {}

124 
TşObjeù
* 
	$ü—‹
(, const *const*) {

125  (
Ãw
 
WimshPhy
);

126 
	}
}

127 } 
	gşass_wimax_phy
;

129 
	gWimshPhy
::
	$WimshPhy
 (è: 
	$rxFšishTimes_
 (
this
)

131 
chªÃl_
 = 0;

132 
phyMib_
 = 0;

133 
•sÚ_
 = 0;

134 
	}
}

137 
	gWimshPhy
::
	$commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

139 iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "channel") == 0 ) {

140 
chªÃl_
 = (
WimshChªÃl
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

141  
TCL_OK
;

142 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "phymib") == 0 ) {

143 
phyMib_
 = (
WimshPhyMib
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

144  
TCL_OK
;

145 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "mac") == 0 ) {

146 
mac_
 = (
WimshMac
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

147  
TCL_OK
;

148 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "topology") == 0 ) {

149 
tİŞogy_
 = (
WimshTİŞogySim¶e
*è
TşObjeù
::
	`lookup
 (
¬gv
[2]);

150  
TCL_OK
;

151 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "epsilon") == 0 ) {

152 
•sÚ_
 = 1.0e-6 * 
	`©of
 (
¬gv
[2]);

153 iàĞ
•sÚ_
 < 0 ) {

154 
	`årštf
 (
¡d”r
, "theƒpsilon value '%f' is‚ot valid. "

155 "Choo£‡…os™iv(sm®lèv®ue\n", 
•sÚ_
);

156  
TCL_ERROR
;

158  
TCL_OK
;

160  
TCL_ERROR
;

161 
	}
}

164 
	gWimshPhy
::
£tMode
 (
wimax
::
ChªÃlStus
 
s
, 
WimshChªÃl
* 
chªÃl
)

166 iàĞ
	gWimaxDebug
::
Œaû
("WPHY::£tMode"èè
årštf
 (
¡d”r
,

168 
NOW
, 
mac_
->
nodeId
(), 
this
, 
chªÃl
->
uid
(),

169 Ğ
s
 =ğ
wimax
::
TX
 ) ? "TX" : ( s =ğwimax::
RX
 ) ? "RX" : "NN");

177 iàĞĞ
	gchªÃl
 && chªÃÈ!ğ
chªÃl_
 ) ||

178 Ğ
chªÃl_
->
g‘Mode
 (
this
è=ğ
wimax
::
RX
 && 
s
 =ğwimax::
TX
 ) ) {

179 
¡d
::
li¡
<
Bur¡Desc
>::
™”©Ü
 
™
;

180  
	g™
 = 
rxBur¡s_
.
begš
(è; iˆ!ğrxBur¡s_.
’d
() ; it++ ) {

181 iàĞ
gt
 (
™
->
fšish_
, 
NOW
è&& 
	g™
->
	gbur¡_
 != 0 ) {

182 
™
->
bur¡_
->
”rÜ
 (èğ
Œue
;

188 iàĞ
	gchªÃl
 && 
	gchªÃl_
 && chªÃÈ!ğ
chªÃl_
 )

189 
chªÃl_
->
£tMode
 (
this
, 
wimax
::
NONE
);

192 iàĞ
	gchªÃl
 ) 
	gchªÃl_
 = 
chªÃl
;

193 
	gchªÃl_
->
£tMode
 (
this
, 
s
);

197 
	gWimshPhy
::
	$£ndBur¡
 (
WimshBur¡
* 
bur¡
)

200 
chªÃl_
->
	`£tMode
 (
this
, 
wimax
::
TX
);

203 
bur¡
->
	`txtime
() =

204 
phyMib_
->
	`symDu¿tiÚ
() *

205 Ğ1 + ( 
bur¡
->
	`size
(è- 1 ) / 
phyMib_
->
®pha
[bur¡->
	`´ofe
()] );

210 iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 ) {

211 
bur¡
->
	`txtime
(è+ğ
phyMib_
->
	`symShÜtP»ambË
(è*…hyMib_->
	`symDu¿tiÚ
 ();

212 } iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ) {

213 
bur¡
->
	`txtime
(è+ğ
phyMib_
->
	`symShÜtP»ambË
(è*…hyMib_->
	`symDu¿tiÚ
 ();

214 } iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ) {

215 
bur¡
->
	`txtime
(è+ğ
phyMib_
->
	`symShÜtP»ambË
(è*…hyMib_->
	`symDu¿tiÚ
 ();

216 } iàĞ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) {

217 
bur¡
->
	`txtime
(è+ğ
phyMib_
->
	`symShÜtP»ambË
(è*…hyMib_->
	`symDu¿tiÚ
 ();

219 
	`abÜt
();

223 
bur¡
->
	`sourû
(èğ
mac_
->
	`nodeId
();

226 
chªÃl_
->
	`»cvBur¡
 (
bur¡
);

227 
	}
}

230 
	gWimshPhy
::
	$hªdË
 (
WimshBur¡
* 
bur¡
)

233 iàĞ
bur¡
 == 0 ) ;

235 iàĞ
WimaxDebug
::
	`Œaû
("WPHY::hªdË"èè
	`årštf
 (
¡d”r
,

236 "%.9àWPHY::hªdË [%d] srø%dxtim%à\n", 
NOW
, 
mac_
->
	`nodeId
(),

237 
bur¡
->
	`sourû
(), bur¡->
	`txtime
());

242 
¡d
::
li¡
<
Bur¡Desc
>::
™”©Ü
 
cur
;

243  
cur
 = 
rxBur¡s_
.
	`begš
(è; cu¸!ğrxBur¡s_.
	`’d
() ; ++cur ) {

244 iàĞ
cur
->
bur¡_
 =ğ
bur¡
 ) ;

247 
	`as£¹
 ( 
cur
 !ğ
rxBur¡s_
.
	`’d
() );

264 
¡d
::
li¡
<
Bur¡Desc
>::
™”©Ü
 
™
;

265  
™
 = 
rxBur¡s_
.
	`begš
(è; iˆ!ğrxBur¡s_.
	`’d
() ; ++it ) {

268 iàĞ
™
 =ğ
cur
 ) ;

271 iàĞ
™
->
chªÃl_
 !ğ
cur
->channel_ )

275 iàĞ! ( 
	`gt
 (
™
->
fšish_
, 
cur
->
¡¬t_
) &&

276 
	`gt
 (
cur
->
fšish_
, 
™
->
¡¬t_
 ) ) )

280 iàĞ! 
tİŞogy_
->
	`ÃighbÜs
 (
™
->
¤c_
, 
mac_
->
	`nodeId
()) ||

281 ! 
tİŞogy_
->
	`ÃighbÜs
 (
cur
->
¤c_
, 
mac_
->
	`nodeId
()) )

285 
cur
->
bur¡_
->
	`”rÜ
(èğ
Œue
;

290 
mac_
->
	`»cvBur¡
 (
cur
->
bur¡_
);

291 
cur
->
bur¡_
 = 0;

297 
Ï‹¡S¹
 = -1;

298  
™
 = 
rxBur¡s_
.
	`begš
(è; iˆ!ğrxBur¡s_.
	`’d
() ; ++it ) {

299 iàĞ! 
	`gt
 (
NOW
, 
™
->
fšish_
) )

300 iàĞ
Ï‹¡S¹
 < 0 || 
™
->
¡¬t_
 >†atestStart)

301 
Ï‹¡S¹
 = 
™
->
¡¬t_
;

305 iàĞ
Ï‹¡S¹
 < 0 ) {

306 
rxBur¡s_
.
	`ş—r
 ();

308  
™
 = 
rxBur¡s_
.
	`begš
(è; iˆ!ğrxBur¡s_.
	`’d
() ; ) {

309 iàĞ
™
->
fšish_
 < 
Ï‹¡S¹
 ) {

310 
¡d
::
li¡
<
Bur¡Desc
>::
™”©Ü
 
drİ
 = 
™
;

311 ++
™
;

312 
rxBur¡s_
.
	`”a£
 (
drİ
);

314 ++
™
;

318 
	}
}

321 
	gWimshPhy
::
	$»cvBur¡
 (
WimshBur¡
* 
bur¡
)

323 iàĞ
WimaxDebug
::
	`Œaû
("WPHY::»cvBur¡"èè
	`årštf
 (
¡d”r
,

325 
NOW
, 
mac_
->
	`nodeId
(), 
this
, 
bur¡
->
	`sourû
(),

326 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHDSCH
 ) ? "dsch" :

327 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNCFG
 ) ? "ncfg" :

328 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
MSHNENT
 ) ? "nent" :

329 Ğ
bur¡
->
	`ty³
(è=ğ
wimax
::
DATA
 ) ? "data" :

331 
bur¡
->
	`txtime
());

334 
Bur¡Desc
 
desc
;

335 
desc
.
¤c_
 = 
bur¡
->
	`sourû
();

336 
desc
.
¡¬t_
 = 
NOW
;

337 
desc
.
fšish_
 = 
NOW
 + 
bur¡
->
	`txtime
();

338 
desc
.
chªÃl_
 = channel_;

342 iàĞ
tİŞogy_
->
	`ÃighbÜs
 (
mac_
->
	`nodeId
(), 
bur¡
->
	`sourû
()) ) {

343 
desc
.
bur¡_
 = 
Ãw
 
	`WimshBur¡
 (*
bur¡
);

344 
desc
.
d¡_
 = 
mac_
->
	`nodeId
();

351 
desc
.
bur¡_
 = 0;

352 
desc
.
d¡_
 = 
tİŞogy_
->
	`ÃxtHİ
 (
bur¡
->
	`sourû
(), 
mac_
->
	`nodeId
());

356 
rxFšishTimes_
.
	`add
 (
bur¡
->
	`txtime
(), 
desc
.
bur¡_
);

359 
rxBur¡s_
.
	`push_back
 (
desc
);

360 
	}
}

	@wimsh_phy.h

20 #iâdeà
__NS2_WIMSH_PHY_H


21 
	#__NS2_WIMSH_PHY_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<t_tim”s.h
>

26 
	~<li¡
>

28 
şass
 
	gWimshChªÃl
;

29 
şass
 
	gWimshBur¡
;

30 
şass
 
	gWimshMac
;

31 
şass
 
	gWimshTİŞogySim¶e
;

34 şas 
	cWimshPhyMib
 : 
public
 
TşObjeù
 {

35 
public
:

37 cÚ¡ 
®pha
[6];

39 
	m´iv©e
:

41 
symDu¿tiÚ_
;

43 
	mäameDu¿tiÚ_
;

45 
	msymP”F¿me_
;

47 
	mcÚŒŞSlÙs_
;

49 
	m¦ÙP”F¿me_
;

51 
	msymP”SlÙ_
;

53 
	mcfgIÁ”v®_
;

55 
	mpublic
:

57 
WimshPhyMib
 ();

59 
	mvœtu®
 ~
	$WimshPhyMib
 () { }

62 
vœtu®
 
	`commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

65 
	$äameDu¿tiÚ
 (è{  
äameDu¿tiÚ_
; 
	}
}

67 
	$symDu¿tiÚ
 (è{  
symDu¿tiÚ_
; 
	}
}

69 
	$¦ÙDu¿tiÚ
 (è{  
symP”SlÙ_
 * 
symDu¿tiÚ_
; 
	}
}

71 
	$cÚŒŞSlÙDu¿tiÚ
 (è{  7 * 
symDu¿tiÚ_
; 
	}
}

74 
ÃxtF¿me
 ();

77 
	$symP”F¿me
 (è{  
symP”F¿me_
; 
	}
}

79 
	$symP”SlÙ
 (è{  
symP”SlÙ_
; 
	}
}

81 
	$¦ÙP”F¿me
 (è{  
¦ÙP”F¿me_
; 
	}
}

83 
	$cÚŒŞSlÙs
 (è{  
cÚŒŞSlÙs_
; 
	}
}

85 
	$cfgIÁ”v®
 (è{  
cfgIÁ”v®_
; 
	}
}

88 
	$symShÜtP»ambË
 (è{  1; 
	}
}

90 
	$symLÚgP»ambË
 (è{  2; 
	}
}

93 
	$cÚŒŞDu¿tiÚ
 (è{  
	`cÚŒŞSlÙDu¿tiÚ
(è* 
	`cÚŒŞSlÙs
(); 
	}
}

100 
	$d©aDu¿tiÚ
 (è{  
äameDu¿tiÚ_
 - 
	`cÚŒŞDu¿tiÚ
(); 
	}
}

102 
	g´Ùeùed
:

104 
boŞ
 
»compu‹
 ();

107 
dump
 (
FILE
* 
os
);

111 şas 
	cWimshPhy
 : 
public
 
TşObjeù
 {

112 
´Ùeùed
:

114 
	sBur¡Desc
 {

116 
WimaxNodeId
 
¤c_
;

118 
WimaxNodeId
 
	md¡_
;

120 
	m¡¬t_
;

122 
	mfšish_
;

124 
WimshChªÃl
* 
	mchªÃl_
;

126 
WimshBur¡
* 
	mbur¡_
;

130 
	g¡d
::
li¡
<
Bur¡Desc
> 
rxBur¡s_
;

133 
	gTMuÉiTim”
<
	gWimshPhy
, 
	gWimshBur¡
*> 
	grxFšishTimes_
;

136 
WimshChªÃl
* 
	gchªÃl_
;

139 
WimshPhyMib
* 
	gphyMib_
;

142 
WimshMac
* 
	gmac_
;

145 
WimshTİŞogySim¶e
* 
	gtİŞogy_
;

152 
	g•sÚ_
;

154 
	gpublic
:

156 
WimshPhy
 ();

158 
	gvœtu®
 ~
	$WimshPhy
 (è{ 
	}
}

168 
£tMode
 (
wimax
::
ChªÃlStus
 
s
, 
WimshChªÃl
* 
chªÃl
 = 0);

174 
£ndBur¡
 (
WimshBur¡
* 
bur¡
);

179 
»cvBur¡
 (
WimshBur¡
* 
bur¡
);

192 
hªdË
 (
WimshBur¡
*);

194 
	g´Ùeùed
:

196 
vœtu®
 
commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

198 
	g´iv©e
:

203 
boŞ
 
	$gt
 (
x
, 
y
) {

204  ( 
x
 > ( 
y
 + 
•sÚ_
 ) ) ? 
Œue
 : 
çl£
; 
	}
}

206 
	g´iv©e
:

207 
WimshPhy
 (const WimshPhy&);

208 
	gİ”©Ü
ğ(cÚ¡ 
WimshPhy
&);

	@wimsh_scheduler.cc

20 
	~<wimsh_scheduËr.h
>

22 
	~<wimsh_mac.h
>

23 
	~<wimsh_·ck‘.h
>

24 
	~<wimsh_bwmªag”.h
>

26 
	~<¡©.h
>

27 
	~<.h
>

35 
	gWimshScheduËr
::
	$WimshScheduËr
 (
WimshMac
* 
m
è: 
	$mac_
 (
m
)

37 
bufSize_
 = 0;

38 
maxBufSize_
 = 0;

39 
	}
}

42 
	gWimshScheduËr
::
	$commªd
 (
¬gc
, cÚ¡ * cÚ¡* 
¬gv
)

44 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[0], "size") == 0 ) {

45 
maxBufSize_
 = 
	`©oi
 (
¬gv
[1]);

46 iàĞ
maxBufSize_
 < 0 ) {

47 
	`årštf
 (
¡d”r
, "šv®id bufã¸siz'%d'\n", 
maxBufSize_
);

48  
TCL_ERROR
;

50  
TCL_OK
;

53  
TCL_ERROR
;

54 
	}
}

62 
	gWimshScheduËrFifo
::
	$WimshScheduËrFifo
 (
WimshMac
* 
m
) :

63 
	$WimshScheduËr
 (
m
)

66 
	}
}

69 
WimshScheduËrFifo
::
	$commªd
 (
¬gc
, cÚ¡ * cÚ¡* 
¬gv
)

71  
WimshScheduËr
::
	`commªd
 (
¬gc
, 
¬gv
);

72 
	}
}

75 
	gWimshScheduËrFifo
::
	$š™Ÿlize
 ()

78 
bufãr_
.
	`»size
 (
mac_
->
	`Âeighs
());

79 
size_
.
	`»size
 (
mac_
->
	`Âeighs
());

80 
	}
}

83 
	gWimshScheduËrFifo
::
	$addPdu
 (
WimaxPdu
* 
pdu
)

85 iàĞ
WimaxDebug
::
	`Œaû
("WSCH::addPdu"èè
	`årštf
 (
¡d”r
,

87 
NOW
, 
mac_
->
	`nodeId
(), 
WimaxDebug
::
	`fÜm©
(
pdu
));

90 iàĞ
bufSize_
 + 
pdu
->
	`size
(è> 
maxBufSize_
 ) {

91 
pdu
->
	`sdu
()->
	`ä“Paylßd
();

92 
d–‘e
 
pdu
->
	`sdu
();

93 
d–‘e
 
pdu
;

95 
St
::
	`put
 ("wimsh_drİ_ov”æow", 
mac_
->
	`šdex
(), 1.0);

100 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
());

105 
size_
[
ndx
] +ğ
pdu
->
	`size
();

108 
bufSize_
 +ğ
pdu
->
	`size
();

110 
St
::
	`put
 ("wimsh_bufsize_a", 
mac_
->
	`šdex
(), 
bufSize_
 );

111 
St
::
	`put
 ("wimsh_bufsize_d", 
mac_
->
	`šdex
(), 
bufSize_
 );

114 
bufãr_
[
ndx
].
	`push
 (
pdu
);

117 
mac_
->
	`bwmªag”
()->
	`backlog
 (

118 (
WimaxNodeId
è
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`§ddr
(),

119 (
WimaxNodeId
è
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`daddr
(),

120 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
(),

121 
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
(),

122 
pdu
->
	`size
());

123 
	}
}

126 
	gWimshScheduËrFifo
::
	$scheduË
 (
WimshF¿gm’tiÚBufãr
& 
äag
, 
WimaxNodeId
 
d¡
)

128 
d¡Ndx
 = 
mac_
->
	`Ãigh2ndx
(
d¡
);

129 iàĞ
WimaxDebug
::
	`Œaû
("WSCH::scheduË"èè
	`årštf
 (
¡d”r
,

131 
NOW
, 
mac_
->
	`nodeId
(), 
d¡
, 
size_
[
d¡Ndx
], 
äag
.
	`size
());

137 
boŞ
 
¥¬e
 = 
Œue
;

139  
¥¬e
 && 
size_
[
d¡Ndx
] > 0 ) {

141 
WimaxPdu
* 
pdu
 = 
bufãr_
[
d¡Ndx
].
	`äÚt
();

142 
bufãr_
[
d¡Ndx
].
	`pİ
 ();

145 
size_
[
d¡Ndx
] -ğ
pdu
->
	`size
();

148 
bufSize_
 -ğ
pdu
->
	`size
();

149 
St
::
	`put
 ("wimsh_bufsize_a", 
mac_
->
	`šdex
(), 
bufSize_
 );

150 
St
::
	`put
 ("wimsh_bufsize_d", 
mac_
->
	`šdex
(), 
bufSize_
 );

153 
¥¬e
 = 
äag
.
	`addPdu
 (
pdu
);

156 
	}
}

	@wimsh_scheduler.h

20 #iâdeà
__NS2_WIMSH_SCHEDULER_H


21 
	#__NS2_WIMSH_SCHEDULER_H


	)

23 
	~<wimax_commÚ.h
>

24 
	~<wimsh_bufãrs.h
>

25 
	~<t_tim”s.h
>

27 
şass
 
	gWimshMac
;

43 şas 
	cWimshScheduËr
 {

44 
	m´Ùeùed
:

46 
WimshMac
* 
mac_
;

54 
	mbufSize_
;

57 
	mmaxBufSize_
;

59 
	mpublic
:

61 
WimshScheduËr
 (
WimshMac
* 
m
);

63 
	mvœtu®
 ~
	$WimshScheduËr
 () { }

66 
vœtu®
 
	`š™Ÿlize
 () = 0;

69 
vœtu®
 
	`addPdu
 (
WimaxPdu
* 
pdu
) = 0;

72 
vœtu®
 
	`scheduË
 (
WimshF¿gm’tiÚBufãr
& 
äag
, 
WimaxNodeId
 
d¡
) = 0;

75 
vœtu®
 
	`ÃighbÜ
 (
ndx
) = 0;

78 
vœtu®
 
	`commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

81 
vœtu®
 
	$bufSize
 (è{  
bufSize_
; 
	}
}

93 şas 
	cWimshScheduËrBS
 : 
public
 
WimshScheduËr
 {

94 
public
:

95 
WimshScheduËrBS
();

96 ~
WimshScheduËrBS
();

102 şas 
	cWimshScheduËrSS
 : 
public
 
WimshScheduËr
 {

103 
public
:

104 
WimshScheduËrSS
();

105 ~
WimshScheduËrSS
();

126 şas 
	cWimshScheduËrFifo
 : 
public
 
WimshScheduËr
 {

129 
¡d
::
veùÜ
< std::
queue
<
WimaxPdu
*> > 
bufãr_
;

132 
	m¡d
::
veùÜ
<> 
size_
;

134 
	mpublic
:

136 
WimshScheduËrFifo
 (
WimshMac
* 
m
);

138 ~
	$WimshScheduËrFifo
 () { }

141 
	`š™Ÿlize
 ();

144 
	`addPdu
 (
WimaxPdu
* 
pdu
);

147 
	`scheduË
 (
WimshF¿gm’tiÚBufãr
& 
äag
, 
WimaxNodeId
 
d¡
);

150 
	$ÃighbÜ
 (
ndx
è{  
size_
[ndx]; 
	}
}

153 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

	@wimsh_scheduler_frr.cc

20 
	~<wimsh_scheduËr_är.h
>

22 
	~<wimsh_mac.h
>

23 
	~<wimsh_·ck‘.h
>

24 
	~<wimsh_bwmªag”.h
>

26 
	~<¡©.h
>

27 
	~<.h
>

29 
	gWimshScheduËrFaœRR
::
	$WimshScheduËrFaœRR
 (
WimshMac
* 
m
) :

30 
	`WimshScheduËr
 (
m
), 
	$tim”_
(
this
)

32 
roundDu¿tiÚ_
 = 0;

33 
bufãrSh¬šgMode_
 = 
SHARED
;

34 
š‹rv®_
 = 0;

35  
i
 = 0 ; i < 
WimaxMeshCid
::
MAX_PRIO
 ; i++ )

36 
´ioWeights_
[
i
] = 1.0;

37 
	}
}

40 
	gWimshScheduËrFaœRR
::
	$commªd
 (
¬gc
, cÚ¡ * cÚ¡* 
¬gv
)

42 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "round-duration") == 0 ) {

43 iàĞ
	`©oi
 (
¬gv
[1]) <= 0 ) {

44 
	`årštf
 (
¡d”r
, "Invalid„ound duration '%s'. "

45 "Choo£‡…os™ivnumb”, iÀby‹s\n", 
¬gv
[1]);

46  
TCL_ERROR
;

48 
roundDu¿tiÚ_
 = (è
	`©oi
 (
¬gv
[1]);

49  
TCL_OK
;

50 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "buffer-sharing") == 0 ) {

51 iàĞ
	`¡rcmp
 (
¬gv
[1], "shared") == 0 ) {

52 
bufãrSh¬šgMode_
 = 
SHARED
;

53 } iàĞ
	`¡rcmp
 (
¬gv
[1], "per-link") == 0 ) {

54 
bufãrSh¬šgMode_
 = 
PER_LINK
;

55 } iàĞ
	`¡rcmp
 (
¬gv
[1], "per-flow") == 0 ) {

56 
bufãrSh¬šgMode_
 = 
PER_FLOW
;

58 
	`årštf
 (
¡d”r
, "Invalid buffer sharing strategy '%s'. "

59 "Choo£ 'sh¬ed' o¸'³r-lšk' o¸'³r-æow'\n", 
¬gv
[1]);

60  
TCL_ERROR
;

62  
TCL_OK
;

63 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "weight-timeout") == 0 ) {

64 
š‹rv®_
 = 
	`©of
 (
¬gv
[1]);

65  
TCL_OK
;

66 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[0], "prio-weight") == 0 ) {

67 
i
 = 
	`©oi
 (
¬gv
[1]);

68 
x
 = 
	`©of
 (
¬gv
[2]);

69 iàĞ
i
 >ğ
WimaxMeshCid
::
MAX_PRIO
 ) {

70 
	`årštf
 (
¡d”r
, "priority '%d'ƒxceedshe maximum value '%d'\n",

71 
i
, 
WimaxMeshCid
::
MAX_PRIO
 - 1 );

72  
TCL_ERROR
;

74 iàĞ
x
 <= 0 ) {

75 
	`årštf
 (
¡d”r
,

76 "´iÜ™y weighˆmu¡ b>ğ0 ('%f'‚Ù‡Îowed)\n", 
x
);

77  
TCL_ERROR
;

79 
´ioWeights_
[
i
] = 
x
;

80  
TCL_OK
;

83  
WimshScheduËr
::
	`commªd
 (
¬gc
, 
¬gv
);

84 
	}
}

87 
	gWimshScheduËrFaœRR
::
	$š™Ÿlize
 ()

90 
lšk_
.
	`»size
 (
mac_
->
	`Âeighs
());

91 
unfšishedRound_
.
	`»size
 (
mac_
->
	`Âeighs
());

94 iàĞ
š‹rv®_
 > 0 ) 
tim”_
.
	`¡¬t
 ( interval_ );

95 
	}
}

98 
	gWimshScheduËrFaœRR
::
	$addPdu
 (
WimaxPdu
* 
pdu
)

100 iàĞ
WimaxDebug
::
	`Œaû
("WSCH::addPdu"èè
	`årštf
 (
¡d”r
,

102 
NOW
, 
mac_
->
	`nodeId
(), 
WimaxDebug
::
	`fÜm©
(
pdu
));

105 cÚ¡ 
ndx
 = 
mac_
->
	`Ãigh2ndx
 (
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
());

108 cÚ¡ 
´io
 = 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
();

111 iàĞĞ
bufãrSh¬šgMode_
 =ğ
SHARED
 &&

112 
bufSize_
 + 
pdu
->
	`size
(è> 
maxBufSize_
 ) ||

113 Ğ
bufãrSh¬šgMode_
 =ğ
PER_LINK
 &&

114 
lšk_
[
ndx
].
size_
 + 
pdu
->
	`size
(è> 
maxBufSize_
) ) {

115 
	`drİ
 (
pdu
);

126 cÚ¡ 
WimaxNodeId
 
¤c
 = (WimaxNodeIdè
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`§ddr
();

127 cÚ¡ 
WimaxNodeId
 
d¡
 = (WimaxNodeIdè
	`HDR_IP
(
pdu
->
	`sdu
()->
	`
())->
	`daddr
();

130 
FlowDesc
 
	`tmp
 (
¤c
, 
d¡
, 
´io
);

133 
boŞ
 
v®id
;

134 
FlowDesc
& 
desc
 = 
lšk_
[
ndx
].
¼_
.
	`fšd
 (
tmp
, 
v®id
);

137 iàĞ
bufãrSh¬šgMode_
 =ğ
PER_FLOW
 &&

138 
desc
.
size_
 + 
pdu
->
	`size
(è> 
maxBufSize_
 ) {

139 
	`drİ
 (
pdu
);

144 
desc
.
queue_
.
	`push
 (
pdu
);

151 
desc
.
size_
 +ğ
pdu
->
	`size
();

152 
lšk_
[
ndx
].
size_
 +ğ
pdu
->
	`size
();

153 
bufSize_
 +ğ
pdu
->
	`size
();

155 
St
::
	`put
 ("wimsh_bufsize_mac_a", 
mac_
->
	`šdex
(), 
bufSize_
 );

156 
St
::
	`put
 ("wimsh_bufsize_mac_d", 
mac_
->
	`šdex
(), 
bufSize_
 );

160 iàĞ! 
v®id
 ) {

161 
lšk_
[
ndx
].
¼_
.
	`š£¹
 (
desc
);

162 
	`»compu‹
 (
lšk_
[
ndx
].
¼_
);

166 
mac_
->
	`bwmªag”
()->
	`backlog
 (

167 
desc
.
¤c_
,

168 
desc
.
d¡_
,

169 
pdu
->
	`hdr
().
	`meshCid
().
	`´iÜ™y
(),

170 
pdu
->
	`hdr
().
	`meshCid
().
	`d¡
(),

171 
pdu
->
	`size
());

172 
	}
}

175 
	gWimshScheduËrFaœRR
::
	$scheduË
 (
WimshF¿gm’tiÚBufãr
& 
äag
, 
WimaxNodeId
 
d¡
)

178 
ndx
 = 
mac_
->
	`Ãigh2ndx
(
d¡
);

181 iàĞ
WimaxDebug
::
	`Œaû
("WSCH::schedule") ) {

182 
	`årštf
 (
¡d”r
,

184 
NOW
, 
mac_
->
	`nodeId
(), 
d¡
, 
äag
.
	`size
());

186 
CœcuÏrLi¡
<
FlowDesc
>& 
¼
 = 
lšk_
[
ndx
].
¼_
;

187 
	`årštf
 (
¡d”r
, " backlog %d", 
lšk_
[
ndx
].
size_
);

188 iàĞ
¼
.
	`size
() == 0 ) {

189 
	`årštf
 (
¡d”r
, " qsize 0");

191 
	`årštf
 (
¡d”r
, " qsiz%d", 
¼
.
	`size
());

192  
i
 = 0 ; i < 
¼
.
	`size
() ; i++ ) {

193 
FlowDesc
& 
æow
 = 
¼
.
	`cu¼’t
();

194 
	`årštf
 (
¡d”r
, " (%d,%d,%d; %d; %d,%d)",

195 
æow
.
¤c_
, flow.
d¡_
, flow.
´io_
,

196 
æow
.
size_
,

197 
æow
.
quªtum_
, flow.
defic™_
);

198 
¼
.
	`move
 ();

202 
	`årštf
 (
¡d”r
, "\n");

206 
boŞ
 
¥¬e
 = 
Œue
;

213 iàĞ
unfšishedRound_
[
ndx
] ) 
¥¬e
 = 
	`£rve
 (
äag
,‚dx, 
Œue
);

216 
CœcuÏrLi¡
<
FlowDesc
>& 
¼
 = 
lšk_
[
ndx
].
¼_
;

221  ! 
¼
.
	`em±y
(è&& 
¥¬e
 ) s·» = 
	`£rve
 (
äag
, 
ndx
, 
çl£
);

222 
	}
}

225 
	gWimshScheduËrFaœRR
::
	$drİ
 (
WimaxPdu
* 
pdu
)

227 
pdu
->
	`sdu
()->
	`ä“Paylßd
();

228 
d–‘e
 
pdu
->
	`sdu
();

229 
d–‘e
 
pdu
;

231 
St
::
	`put
 ("wimsh_drİ_ov”æow", 
mac_
->
	`šdex
(), 1.0);

232 
	}
}

234 
boŞ


235 
	gWimshScheduËrFaœRR
::
	$£rve
 (
WimshF¿gm’tiÚBufãr
& 
äag
,

236 
ndx
, 
boŞ
 
unfšished
)

239 
CœcuÏrLi¡
<
FlowDesc
>& 
¼
 = 
lšk_
[
ndx
].
¼_
;

242 
FlowDesc
& 
æow
 = 
¼
.
	`cu¼’t
();

245 iàĞ! 
unfšished
 ) {

246 
æow
.
defic™_
 +ğæow.
quªtum_
;

247 
æow
.
defic™_
 =

248 Ğ
æow
.
defic™_
 > flow.
size_
 ) ? flow.size_ : flow.deficit_;

252 
boŞ
 
¥¬e
 = 
Œue
;

255  
¥¬e
 && 
æow
.
defic™_
 > 0 ) {

258 
WimaxPdu
* 
pdu
 = 
æow
.
queue_
.
	`äÚt
 ();

262 iàĞ
pdu
->
	`size
(è> 
æow
.
defic™_
 ) ;

270 
æow
.
queue_
.
	`pİ
 ();

273 
æow
.
size_
 -ğ
pdu
->
	`size
();

274 
lšk_
[
ndx
].
size_
 -ğ
pdu
->
	`size
();

275 
bufSize_
 -ğ
pdu
->
	`size
();

277 
St
::
	`put
 ("wimsh_bufsize_mac_a", 
mac_
->
	`šdex
(), 
bufSize_
 );

278 
St
::
	`put
 ("wimsh_bufsize_mac_d", 
mac_
->
	`šdex
(), 
bufSize_
 );

283 
æow
.
defic™_
 -ğ
pdu
->
	`size
();

287 
¥¬e
 = 
äag
.
	`addPdu
 (
pdu
);

295 iàĞ! 
¥¬e
 ) {

296 
unfšishedRound_
[
ndx
] = 
Œue
;

297  
¥¬e
;

300 
unfšishedRound_
[
ndx
] = 
çl£
;

303 iàĞ
æow
.
size_
 == 0 )

304 
¼
.
	`”a£
 ();

308 
¼
.
	`move
 ();

310  
¥¬e
;

311 
	}
}

314 
	gWimshScheduËrFaœRR
::
»compu‹
 (
CœcuÏrLi¡
<
FlowDesc
>& 
¼
)

317 cÚ¡ 
N
 = 
¼
.
size
();

319 
	gsum
 = 0;

322  
	gi
 = 0 ; i < 
	gN
 ; i++ ) {

323 
	gsum
 +ğ
´ioWeights_
[
¼
.
cu¼’t
().
´io_
];

324 
	g¼
.
move
 ();

328  
	gi
 = 0 ; i < 
	gN
 ; i++ ) {

329 
	gquªtum
 = (èĞ
roundDu¿tiÚ_
 *

330 Ğ
´ioWeights_
[
¼
.
cu¼’t
().
´io_
] / ()
sum
 ) );

331 
	g¼
.
cu¼’t
().
	gquªtum_
 = ( 
quªtum
 > 0 ) ? quantum : 1;

332 
	g¼
.
move
 ();

337 
	gWimshScheduËrFaœRR
::
	$hªdË
 ()

339 iàĞ
WimaxDebug
::
	`Œaû
("WSCH::hªdË"èè
	`årštf
 (
¡d”r
,

340 "%.9àWSCH::hªdË [%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

346 iàĞ
š‹rv®_
 <= 0 ) ;

349 
¡d
::
veùÜ
<
LškDesc
>::
™”©Ü
 
lšk
;

350  
lšk
 = 
lšk_
.
	`begš
(è;†šk !ğlšk_.
	`’d
() ; ++link ) {

351 
CœcuÏrLi¡
<
FlowDesc
>& 
¼
 = 
lšk
->
¼_
;

353 
boŞ
 
chªged
 = 
çl£
;

355  
i
 = 0 ; i < 
¼
.
	`size
() ; i++ ) {

357 
FlowDesc
& 
æow
 = 
¼
.
	`cu¼’t
();

362 iàĞ
NOW
 - 
æow
.
Ï¡_
 > 
š‹rv®_
 && flow.
queue_
.
	`em±y
() ) {

363 
¼
.
	`”a£
 ();

364 
chªged
 = 
Œue
;

366 
¼
.
	`move
 ();

370 iàĞ
chªged
 ) 
	`»compu‹
 (
¼
);

374 
tim”_
.
	`¡¬t
 ( 
š‹rv®_
 );

375 
	}
}

	@wimsh_scheduler_frr.h

20 #iâdeà
__NS2_WIMSH_SCHEDULER_FRR_H


21 
	#__NS2_WIMSH_SCHEDULER_FRR_H


	)

23 
	~<wimsh_scheduËr.h
>

29 şas 
	cWimshScheduËrFaœRR
 : 
public
 
WimshScheduËr
 {

31 
public
:

33 
	eBufãrSh¬šgMode
 { 
SHARED
, 
	mPER_LINK
, 
	mPER_FLOW
 };

35 
	g´Ùeùed
:

45 
	sFlowDesc
 {

47 
WimaxNodeId
 
¤c_
;

49 
WimaxNodeId
 
	gd¡_
;

51 
	g´io_
;

54 
	gÏ¡_
;

57 
	gquªtum_
;

59 
	gdefic™_
;

62 
	gsize_
;

65 
	g¡d
::
queue
<
WimaxPdu
*> 
queue_
;

68 
FlowDesc
 (
WimaxNodeId
 
¤c
=0, WimaxNodeId 
d¡
=0, 
´io
=0) :

69 
¤c_
 (
¤c
), 
d¡_
 (
d¡
), 
´io_
(
´io
),

70 
Ï¡_
(0), 
quªtum_
(0), 
defic™_
 (0), 
size_
 (0) { }

73 
boŞ
 
	gİ”©Ü
=ğ(cÚ¡ 
FlowDesc
& 
x
) const {

74  ( 
d¡_
 =ğ
x
.d¡_ && 
¤c_
 =ğx.¤c_ && 
´io_
 == x.prio_ ); }

77 
boŞ
 
	gİ”©Ü
!ğ(cÚ¡ 
FlowDesc
& 
x
) const {

78  ! ( *
this
 =ğ
x
 ); }

86 
	sLškDesc
 {

88 
	gsize_
;

91 
	gCœcuÏrLi¡
<
	gFlowDesc
> 
	g¼_
;

94 
LškDesc
 (è{ 
	gsize_
 = 0; }

101 
	g´ioWeights_
[
WimaxMeshCid
::
MAX_PRIO
];

103 
	gš‹rv®_
;

105 
	gTTim”
<
	gWimshScheduËrFaœRR
> 
	gtim”_
;

108 
	groundDu¿tiÚ_
;

111 
	g¡d
::
veùÜ
<
LškDesc
> 
lšk_
;

122 
	g¡d
::
veùÜ
<
boŞ
> 
unfšishedRound_
;

125 
BufãrSh¬šgMode
 
	gbufãrSh¬šgMode_
;

127 
	gpublic
:

129 
WimshScheduËrFaœRR
 (
WimshMac
* 
m
);

131 ~
	$WimshScheduËrFaœRR
 (è{ 
	}
}

134 
š™Ÿlize
 ();

137 
hªdË
 ();

140 
addPdu
 (
WimaxPdu
* 
pdu
);

143 
scheduË
 (
WimshF¿gm’tiÚBufãr
& 
äag
, 
WimaxNodeId
 
d¡
);

146 
	$ÃighbÜ
 (
ndx
è{  
lšk_
[ndx].
size_
; 
	}
}

149 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

151 
	g´iv©e
:

153 
drİ
 (
WimaxPdu
* 
pdu
);

156 
boŞ
 
£rve
 (
WimshF¿gm’tiÚBufãr
& 
äag
,

157 
ndx
, 
boŞ
 
unfšished
);

160 
»compu‹
 (
CœcuÏrLi¡
<
FlowDesc
>& 
¼
);

	@wimsh_topology.cc

20 
	~<wimsh_tİŞogy.h
>

21 
	~<wimax_defs.h
>

24 
	~<m©h.h
>

25 
	~<¡dlib.h
>

26 
	~<sys/ty³s.h
>

27 
	~<sys/times.h
>

35 şas 
	cWimshTİŞogySim¶eCÏss
 : 
public
 
TşCÏss
 {

36 
public
:

37 
	$WimshTİŞogySim¶eCÏss
(è: 
	`TşCÏss
("WimshTopology/Simple") {}

38 
TşObjeù
* 
	$ü—‹
(, const *const*) {

39  (
Ãw
 
WimshTİŞogySim¶e
);

40 
	}
}

41 } 
	gşass_wimsh_tİŞogy_sim¶e
;

43 
	gWimshTİŞogySim¶e
::
	$WimshTİŞogySim¶e
 ()

45 
upd©e_
 = 
Œue
;

46 
ÃxtLšk_
 = 1;

47 
	}
}

49 
	gWimshTİŞogySim¶e
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

54 iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
 (
¬gv
[1], "connect") == 0 ) {

55 
i
 = (è
	`©oi
 (
¬gv
[2]);

56 
j
 = (è
	`©oi
 (
¬gv
[3]);

57 iàĞ
i
 =ğ
j
 )  
TCL_ERROR
;

58 
cÚÃùiv™y_
.
	`©
 (
i
, 
j
èğ
ÃxtLšk_
++;

59 
cÚÃùiv™y_
.
	`©
 (
j
, 
i
èğ
ÃxtLšk_
++;

61 
upd©e_
 = 0;

62  
TCL_OK
;

67 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "dump") == 0 ) {

68 
	`dump
 (
¡d”r
);

69  
TCL_OK
;

74 iàĞ
¬gc
 =ğ4 && 
	`¡rcmp
 (
¬gv
[1], "distance") == 0 ) {

78 
M©rix
<> 
·th
;

80 
M©rix
<> 
di¡
;

82 
	`b–lmªFÜd
Ğ
cÚÃùiv™y_
, 
di¡
, 
·th
 );

84 
WimaxNodeId
 
a
 = (WimaxNodeIdè
	`©oi
 (
¬gv
[2]);

85 
WimaxNodeId
 
b
 = (WimaxNodeIdè
	`©oi
 (
¬gv
[3]);

86 
Tş
::
	`š¡ªû
().
	`»suÉf
("%d", 
di¡
.
	`©
(
a
,
b
));

87  
TCL_OK
;

92 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "initialize") == 0 ) {

93 
	`»compu‹
 ();

94  
TCL_OK
;

96  
	`commªd
 (
¬gc
, 
¬gv
);

97 
	}
}

99 
	gWimshTİŞogySim¶e
::
	$»compu‹
 ()

103 cÚ¡ 
N
 = 
cÚÃùiv™y_
.
	`g‘Rows
();

105 
M©rix
<>& 
M
 = 
cÚÃùiv™y_
;

107 
M©rix
<
boŞ
>& 
C
 = 
cÚæiù_
;

109 
NhİsNeighbÜsM­
& 
NM
 = 
nHİsNeighbÜs_
;

112 
lšks_
.
	`ş—r
();

117  
¤c
 = 0 ; srø< 
N
 ; src++ ) {

118  
d¡
 = 0 ; d¡ <
N
 ; dst++ ) {

119 iàĞ
M
.
	`©
Ğ
¤c
, 
d¡
 ) > 0è
lšks_
.
	`push_back
Ğ
	`Lšk
( src, dst ) );

124 
num
=
lšks_
.
	`size
();

125 
lšks¤c_
[
num
];

126 
lšksd¡_
[
num
];

129  
¤c
 = 0 ; srø< 
num
 ; src++ ) {

130 
lšks¤c_
[
¤c
]=0;

131 
lšksd¡_
[
¤c
]=0;

133  
¤c
 = 0 ; srø< 
N
 ; src++ ) {

134  
d¡
 = 0 ; d¡ <
N
 ; dst++ ) {

135 iàĞ
M
.
	`©
Ğ
¤c
, 
d¡
 ) > 0){

136 
lšks¤c_
[
M
.
	`©
(
¤c
,
d¡
)-1]=src;

137 
lšksd¡_
[
M
.
	`©
(
¤c
,
d¡
)-1]=dst;

142 
cÚæiù_
.
	`»£t
 ();

146  
i
 = 0; i < 
lšks_
.
	`size
(); i++ ) {

147  
j
 = 0; j < 
lšks_
.
	`size
(); j++ ) {

148 iàĞ
i
 =ğ
j
 ) 
C
.
	`©
 ( i, j ) = 0;

150 
lšks¤c_
[
i
] =ğlšks¤c_[
j
] ||

151 
lšks¤c_
[
i
] =ğ
lšksd¡_
[
j
] ||

152 
lšksd¡_
[
i
] =ğ
lšks¤c_
[
j
] ||

153 
lšksd¡_
[
i
] =ğlšksd¡_[
j
] ||

154 
M
.
	`©
Ğ
lšks¤c_
[
i
], 
lšksd¡_
[
j
] ) ||

155 
M
.
	`©
Ğ
lšksd¡_
[
i
], 
lšks¤c_
[
j
] )

157 
C
.
	`©
 ( 
i
, 
j
 ) = 1;

158 
C
.
	`©
 ( 
i
, 
j
 ) = 0;

165 
M©rix
<> 
·th
;

167 
M©rix
<> 
di¡
;

169 
	`b–lmªFÜd
Ğ
M
, 
di¡
, 
·th
 );

172 
NM
.
	`ş—r
 ();

175 
¡d
::
m­
< , std::
veùÜ
<
WimaxNodeId
> > 
nhİs_Ãigh
;

178  
i
 = 0 ; i < 
N
 ; i++ ) {

179  
j
 = 0 ; j < 
N
 ; j++ ) {

181 
nhİs_Ãigh
[
di¡
.
	`©
(
i
, 
j
)].
	`push_back
(j);

183 
NM
[
i
] = 
nhİs_Ãigh
;

184 
nhİs_Ãigh
.
	`ş—r
();

194  
i
 = 0 ; i < 
N
 ; i++ ) {

195  
j
 = 0 ; j < 
N
 ; j++ ) {

198 iàĞ
i
 =ğ
j
 ) {

199 
ÃxtHİ_
.
	`©
(
i
, 
j
) = 0;

203 } iàĞ
M
.
	`©
(
i
, 
j
) > 0 ) {

204 
ÃxtHİ_
.
	`©
(
i
, 
j
) = j;

209 
¡d
::
veùÜ
<
wimax
::
NextHİInfo
> 
nhi
 = 
	`g‘De¡š©iÚVeù
 (
i
, 
j
);

210 
¡d
::
veùÜ
<
wimax
::
NextHİInfo
>::
™”©Ü
 
™
;

213 
mšDi¡
 = 
UINT_MAX
;

214  
™
 = 
nhi
.
	`begš
(è; iˆ!ğnhi.
	`’d
() ; ++it ) {

215 iàĞ
™
->
nHİs_
 < 
mšDi¡
 ) minDist = it->nHops_;

219 iàĞ
mšDi¡
 =ğ
UINT_MAX
 ) 
	`abÜt
 ();

222 
¡d
::
veùÜ
<
WimaxNodeId
> 
mšHİs
;

223  
™
 = 
nhi
.
	`begš
(è; iˆ!ğnhi.
	`’d
() ; ++it ) {

224 iàĞ
™
->
nHİs_
 =ğ
mšDi¡
 ) 
mšHİs
.
	`push_back
 (™->
ÃxtHİ_
);

228 
ÃxtHİ_
.
	`©
(
i
, 
j
èğ
mšHİs
[
ºg
.
	`unifÜm
(()mšHİs.
	`size
())];

234 
upd©e_
 = 1;

235 
	}
}

238 
	gWimshTİŞogySim¶e
::
g‘NextHİ
 (

239 
i
,

240 
j
,

241 
M©rix
<>& 
·th
)

243 iàĞ
	gi
 !ğ
j
 && 
cÚÃùiv™y_
.
©
(
i
, 
·th
.at(i, j) ) == 0 )

244  
g‘NextHİ
 (
i
, 
·th
.
©
(i, 
j
),…ath);

245  
	g·th
.
©
(
i
, 
j
);

248 
boŞ


249 
	gWimshTİŞogySim¶e
::
	$š‹rã»
 (

250 
WimaxNodeId
 
a
, WimaxNodeId 
b
,

251 
WimaxNodeId
 
x
, WimaxNodeId 
y
)

254 iàĞ
cÚÃùiv™y_
.
	`©
(
a
, 
b
è=ğ0 || cÚÃùiv™y_.©(
x
, 
y
è=ğ0 )  
çl£
;

256  
cÚæiù_
.
	`©
 (
cÚÃùiv™y_
.©(
a
, 
b
), cÚÃùiv™y_.©(
x
, 
y
));

257 
	}
}

261 
	gWimshTİŞogySim¶e
::
ÃighbÜs
 (
WimaxNodeId
 
x
,

262 
¡d
::
veùÜ
<
WimaxNodeId
>& 
Ãigh
, 
nhİs
)

264 
	gNhİsNeighbÜsM­
::
™”©Ü
 
™
 = 
nHİsNeighbÜs_
.
fšd
(
x
);

265 
	g¡d
::
m­
< , std::
veùÜ
<
WimaxNodeId
> >::
™”©Ü
 
™2
;

268 iàĞ
	g™
 !ğ
nHİsNeighbÜs_
.
’d
() )

269 iàĞ(
™2
 = 
™
->
£cÚd
.
fšd
Ğ
nhİs
 ) ) !ğ™->£cÚd.
’d
() )

270 
Ãigh
 = 
™2
->
£cÚd
;

274 
	g¡d
::
veùÜ
< 
wimax
::
NextHİInfo
 >

275 
WimshTİŞogySim¶e
::
	$g‘De¡š©iÚVeù
 ( 
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
 )

277 
¡d
::
veùÜ
< 
wimax
::
NextHİInfo
 > 
de¡Veù
;

278 
wimax
::
NextHİInfo
 
hİ
;

280 iàĞ
cÚÃùiv™y_
.
	`©
Ğ
¤c
, 
d¡
 ) ){

281 
hİ
.
ÃxtHİ_
 = 
d¡
;

282 
hİ
.
nHİs_
 = 0;

283 
de¡Veù
.
	`push_back
 ( 
hİ
 );

284  
de¡Veù
;

287 
M©rix
<> 
C
 = 
cÚÃùiv™y_
;

290 
¡d
::
veùÜ
 < 
WimaxNodeId
 > 
Ãigh
;

291 
	`ÃighbÜs
Ğ
¤c
, 
Ãigh
 );

293 
M©rix
<> 
·th
;

294 
M©rix
<> 
di¡
;

298  
i
 = 0; i < 
C
.
	`g‘Rows
(); i++ ){

299 
C
.
	`©
Ğ
¤c
, 
i
 ) = 0;

300 
C
.
	`©
Ğ
i
, 
¤c
 ) = 0;

303 
	`b–lmªFÜd
 ( 
C
, 
di¡
, 
·th
 );

305 
M©rix
<> 
ÃxtHİ
;

308  
i
 = 0 ; i < 
C
.
	`g‘Rows
() ; i++ ) {

309  
j
 = 0 ; j < 
C
.
	`g‘Rows
() ; j++ ) {

310 
ÃxtHİ
.
	`©
(
i
, 
j
) =

311 Ğ
i
 =ğ
j
 ) ? 0 :

312 Ğ
C
.
	`©
(
i
, 
j
) > 0 ) ? j :

313 
	`g‘NextHİ
 (
i
, 
j
, 
·th
);

317  
i
 = 0; i < 
Ãigh
.
	`size
(); i++ ){

319 iàĞ
ÃxtHİ
.
	`©
 ( 
Ãigh
.©Ğ
i
 ), 
d¡
 ) !ğ
¤c
 ) {

321 
hİ
.
ÃxtHİ_
 = 
Ãigh
.
	`©
Ğ
i
 );

322 
hİ
.
nHİs_
 = 
di¡
.
	`©
 ( 
Ãigh
.©Ğ
i
 ), 
d¡
 );

323 if(
hİ
.
nHİs_
 < 
UINT_MAX
/2è
de¡Veù
.
	`push_back
 ( hop );

326  
de¡Veù
;

327 
	}
}

330 
	gWimshTİŞogySim¶e
::
b–lmªFÜd
 ( 
M©rix
<>& 
M
,

331 
M©rix
<>& 
di¡
,

332 
M©rix
<>& 
·th
 )

335 cÚ¡ 
	gN
 = 
M
.
g‘Rows
();

345 cÚ¡ 
	gšfš™y
 = 
UINT_MAX
/2;

347  
	gi
 = 0 ; i < 
	gN
 ; i++ ) {

348  
	gj
 = 0 ; j < 
	gN
 ; j++ ) {

349 iàĞ
	gi
 !ğ
j
 && 
M
.
©
(
i
, jè=ğ0 ) 
di¡
.©(i, jèğ
šfš™y
;

350 iàĞ
	gM
.
©
(
i
, 
j
è> 0 ) 
	gdi¡
.at(i, j) = 1;

351 
	gdi¡
.
©
(
i
, 
j
) = 0;

355  
	gi
 = 0 ; i < 
	gN
 ; i++ ) {

356  
	gj
 = 0 ; j < 
	gN
 ; j++ ) {

357 iàĞ
	gdi¡
.
©
(
i
, 
j
è> 0 ) 
	g·th
.at(i, j) = i;

358 
	g·th
.
©
(
i
, 
j
) = 0;

363  
	gk
 = 0 ; k < 
	gN
 ; k++ ) {

364  
	gi
 = 0 ; i < 
	gN
 ; i++ ) {

365  
	gj
 = 0 ; j < 
	gN
 ; j++ ) {

366 iàĞ
	gdi¡
.
©
(
i
, 
j
è> di¡.©(i, 
k
) + dist.at(k, j) ) {

367 
	gdi¡
.
©
(
i
, 
j
èğ
di¡
.©(i, 
k
) + dist.at(k, j);

368 
	g·th
.
©
(
i
, 
j
èğ
·th
.©(
k
, j);

375 
	g¡d
::
veùÜ
< 
WimaxNodeId
 >

376 
WimshTİŞogySim¶e
::
	$g‘MaxTwoHİNeighbÜhood
 ()

378 
NhİsNeighbÜsM­
::
™”©Ü
 
™
;

379 
¡d
::
veùÜ
<
WimaxNodeId
> 
ŞdNeigh
;

380 
¡d
::
veùÜ
<
WimaxNodeId
> 
ÃwNeigh
;

382  
™
 = 
nHİsNeighbÜs_
.
	`begš
(è; iˆ!ğnHİsNeighbÜs_.
	`’d
() ; ++it ) {

385 
¡d
::
veùÜ
<
WimaxNodeId
> 
Úe
 = (
™
->
£cÚd
)[1];

387 
¡d
::
veùÜ
<
WimaxNodeId
> 
two
 = (
™
->
£cÚd
)[2];

392 iàĞ
™
 =ğ
nHİsNeighbÜs_
.
	`begš
() ) {

394  
i
 = 0 ; i < 
Úe
.
	`size
() ; i++ )

395 
ŞdNeigh
.
	`push_back
 (
Úe
[
i
]);

396  
i
 = 0 ; i < 
two
.
	`size
() ; i++ )

397 
ŞdNeigh
.
	`push_back
 (
two
[
i
]);

402 
ÃwNeigh
.
	`ş—r
();

404  
i
 = 0 ; i < 
Úe
.
	`size
() ; i++ )

405 
ÃwNeigh
.
	`push_back
 (
Úe
[
i
]);

406  
i
 = 0 ; i < 
two
.
	`size
() ; i++ )

407 
ÃwNeigh
.
	`push_back
 (
two
[
i
]);

409 iàĞ
ÃwNeigh
.
	`size
(è> 
ŞdNeigh
.size() ) oldNeigh =‚ewNeigh;

413  
ŞdNeigh
;

414 
	}
}

417 
	gWimshTİŞogySim¶e
::
	$dump
 (
FILE
* 
os
)

419 iàĞ! 
upd©e_
 ) 
	`»compu‹
();

421 
	`årštf
 (
os
, "** connectivity graph **\n");

422  
i
 = 0 ; i < 
cÚÃùiv™y_
.
	`g‘Rows
() ; i++ ) {

423  
j
 = 0 ; j < 
cÚÃùiv™y_
.
	`g‘CŞs
() ; j++ ) {

424 iàĞ
j
 > 0 ) 
	`årštf
 (
os
, " ");

425 
	`årštf
 (
os
, "%3u", 
cÚÃùiv™y_
.
	`©
(
i
, 
j
));

427 
	`årštf
 (
os
, "\n");

429 
	`årštf
 (
os
, "**†ink‚aming **\n");

430  
i
 = 0; i < 
lšks_
.
	`size
(); i++ ) {

431 
	`årštf
 (
os
, "Link ID: %d => src: %d, dst: %d",

432 
i
 , 
lšks_
.
	`©
Ğ˜).
¤c_
,†šks_.©Ğ˜).
d¡_
 );

433 
	`årštf
 (
os
, "\n");

436 
	`årštf
 (
os
, "** conflict graph **\n");

437  
i
 = 0 ; i < 
cÚæiù_
.
	`g‘Rows
() ; i++ ) {

438  
j
 = 0 ; j < 
cÚæiù_
.
	`g‘CŞs
() ; j++ ) {

439 iàĞ
j
 > 0 ) 
	`årštf
 (
os
, " ");

440 
	`årštf
 (
os
, "%u", ( 
cÚæiù_
.
	`©
(
i
, 
j
è=ğ
Œue
 ) ? 1 : 0);

442 
	`årštf
 (
os
, "\n");

445 
	`årštf
 (
os
, "**‚ext-hop graph **\n");

446  
i
 = 0 ; i < 
ÃxtHİ_
.
	`g‘Rows
() ; i++ ) {

447  
j
 = 0 ; j < 
ÃxtHİ_
.
	`g‘CŞs
() ; j++ ) {

448 iàĞ
j
 > 0 ) 
	`årštf
 (
os
, " ");

449 
	`årštf
 (
os
, "%3u", 
ÃxtHİ_
.
	`©
(
i
, 
j
));

451 
	`årštf
 (
os
, "\n");

454 
	`årštf
 (
os
, "**‚-hops data structure **\n");

455 
NhİsNeighbÜsM­
::
™”©Ü
 
™
;

456 
¡d
::
m­
< , std::
veùÜ
<
WimaxNodeId
> >::
™”©Ü
 
™2
;

457  
™
 = 
nHİsNeighbÜs_
.
	`begš
(); iˆ!ğnHİsNeighbÜs_.
	`’d
(); ++it ) {

458 
	`årštf
 (
os
, "% %d", "Nod", 
™
->
fœ¡
);

459 
	`årštf
 (
os
, "\n");

460  
™2
 = 
™
->
£cÚd
.
	`begš
(); it2 !ğ™->£cÚd.
	`’d
(); ++it2 ) {

461 iàĞ
™2
 !ğ
™
->
£cÚd
.
	`’d
(èè
	`årštf
 (
os
, "% %d", "di¡:", it2->
fœ¡
);

462 
	`årštf
 (
os
, "%s", "‚odes: ");

463  
i
 = 0; i < 
™2
->
£cÚd
.
	`size
(); i++){

464 
	`årštf
 (
os
, "%d ", 
™2
->
£cÚd
[
i
]);

466 
	`årštf
 (
os
, "\n");

468 
	`årštf
 (
os
, "\n");

471 
	`årštf
 (
os
, "\n");

474 
	}
}

	@wimsh_topology.h

20 #iâdeà
__NS2_WIMSH_TOPOLOGY_H


21 
	#__NS2_WIMSH_TOPOLOGY_H


	)

23 
	~<wimax_commÚ.h
>

25 
	~<ºg.h
>

27 
	~<veùÜ
>

30 
	sli¡a_
{

31 
	mgruµo
;

32 
	m–em’ti
;

33 
li¡a_
 *
	mÃxt
;

39 şas 
	cWimshTİŞogy
 : 
public
 
TşObjeù
 {

40 
public
:

42 
	$WimshTİŞogy
 () { }

44 
vœtu®
 ~
	$WimshTİŞogy
 (è{ 
	}
}

47 
vœtu®
 
boŞ
 
š‹rã»
 (
WimaxNodeId
 
a
, WimaxNodeId 
b
,

48 
WimaxNodeId
 
x
, WimaxNodeId 
y
) = 0;

51 
vœtu®
 
ÃighbÜs
 (
WimaxNodeId
, 
¡d
::
veùÜ
<WimaxNodeId>& 
Ãigh
, 
nhİs
 = 1) = 0;

54 
vœtu®
 
boŞ
 
ÃighbÜs
 (
WimaxNodeId
, WimaxNodeId) = 0;

57 
vœtu®
 
WimaxNodeId
 
ÃxtHİ
 (WimaxNodeId 
x
, WimaxNodeId 
y
) = 0;

60 
vœtu®
 
	g¡d
::
veùÜ
< 
WimaxNodeId
 > 
g‘MaxTwoHİNeighbÜhood
 () = 0;

67 
vœtu®
 
	g¡d
::
veùÜ
< 
wimax
::
NextHİInfo
 > 
g‘De¡š©iÚVeù


68 Ğ
WimaxNodeId
 
¤c
, WimaxNodeId 
	gd¡
 ) = 0;

72 
vœtu®
 
numNodes
() = 0;

75 
vœtu®
 
commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
) = 0;

76 
	g´iv©e
:

77 
WimshTİŞogy
 (const WimshTopology&);

78 
	gİ”©Ü
ğ(cÚ¡ 
WimshTİŞogy
&);

91 şas 
	cWimshTİŞogySim¶e
 : 
public
 
WimshTİŞogy
 {

92 
¡d
::
	tm­
< 
	tWimaxNodeId
, 
	t¡d
::map< ,

93 
	t¡d
::
	tveùÜ
<
	tWimaxNodeId
> > > 
	tNhİsNeighbÜsM­
;

96 
	sLšk
 {

97 
WimaxNodeId
 
	m¤c_
;

98 
WimaxNodeId
 
	md¡_
;

99 
Lšk
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
 ){

100 
	m¤c_
 = 
¤c
; 
	md¡_
 = 
d¡
;

109 
	gM©rix
<> 
	gcÚÃùiv™y_
;

115 
	g¡d
::
veùÜ
< 
Lšk
 > 
lšks_
;

122 
	gM©rix
<
	gboŞ
> 
	gcÚæiù_
;

130 
	gM©rix
<> 
	gÃxtHİ_
;

137 
NhİsNeighbÜsM­
 
	gnHİsNeighbÜs_
;

140 
boŞ
 
	gupd©e_
;

142 
	gÃxtLšk_
;

149 
RNG
 
	gºg
;

151 
	gpublic
:

153 
WimshTİŞogySim¶e
 ();

155 ~
	$WimshTİŞogySim¶e
 (è{ 
	}
}

157 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

162 
boŞ
 
š‹rã»
 (
WimaxNodeId
 
a
, WimaxNodeId 
b
, WimaxNodeId 
x
, WimaxNodeId 
y
);

164 
ÃighbÜs
 (
WimaxNodeId
 
x
, 
¡d
::
veùÜ
<WimaxNodeId>& 
Ãigh
, 
nhİ
 = 1);

166 
boŞ
 
	$ÃighbÜs
 (
WimaxNodeId
 
x
, WimaxNodeId 
y
) {

167  ( 
cÚÃùiv™y_
.
	`©
 (
x
, 
y
è> 0 ) ? 
Œue
 : 
çl£
; 
	}
}

169 
WimaxNodeId
 
	$ÃxtHİ
 (
WimaxNodeId
 
x
, WimaxNodeId 
y
) {

170  
ÃxtHİ_
.
	`©
(
x
, 
y
); 
	}
}

172 
	g¡d
::
veùÜ
< 
WimaxNodeId
 > 
g‘MaxTwoHİNeighbÜhood
 ();

178 
	g¡d
::
veùÜ
< 
wimax
::
NextHİInfo
 > 
g‘De¡š©iÚVeù


179 Ğ
WimaxNodeId
 
¤c
, WimaxNodeId 
	gd¡
 );

181 
	$numNodes
(è{  
cÚÃùiv™y_
.
	`g‘Rows
(); 
	}
}

183 
	g´Ùeùed
:

185 
»compu‹
 ();

187 
dump
 (
FILE
* 
os
);

189 
	g´iv©e
:

191 
g‘NextHİ
 (, , 
M©rix
<>&);

193 
b–lmªFÜd
 ( 
M©rix
<>& 
cÚÃùiv™y
,

194 
M©rix
<>& 
di¡ªû
,

195 
M©rix
<>& 
·th
 );

	@wimsh_udptunnel.cc

20 
	~"wimsh_ud±uÂ–.h
"

21 
	~"¹p.h
"

22 
	~"¿ndom.h
"

23 
	~"add»ss.h
"

24 
	~".h
"

25 
	~"¡©.h
"

27 
	gWimshUdpTuÂ–
::
Çg’ts_
 = 0;

29 şas 
	cWimshUdpTuÂ–CÏss
 : 
public
 
TşCÏss
 {

30 
public
:

31 
	$WimshUdpTuÂ–CÏss
(è: 
	`TşCÏss
("Agent/WimshUdpTunnel") {}

32 
TşObjeù
* 
	$ü—‹
(, const *const*) {

33  (
Ãw
 
	`WimshUdpTuÂ–
());

34 
	}
}

35 } 
	gşass_wimsh_udp_tuÂ–_ag’t
;

37 
	gWimshUdpTuÂ–
::
	$WimshUdpTuÂ–
(è: 
	`Ag’t
(
PT_UDP
), 
	`£qno_
(-1)

39 
	`bšd
("·ck‘Size_", &
size_
);

40 
tuÂ–Ty³_
 = 
SPONSOR
;

41 
	}
}

43 
	gWimshUdpTuÂ–
::
	$WimshUdpTuÂ–
(
·ck‘_t
 
ty³
è: 
	$Ag’t
(
ty³
)

45 
	`bšd
("·ck‘Size_", &
size_
);

46 
tuÂ–Ty³_
 = 
SPONSOR
;

47 
	}
}

51 
	gWimshUdpTuÂ–
::
	$£ndmsg
(
nby‹s
, 
AµD©a
* 
d©a
, cÚ¡ * 
æags
)

53 iàĞ
debug_
 ) {

54 
	`årštf
 (
¡d”r
, "%.9à£ndmsg flow id %d\n", 
NOW
, 
fid_
);

57 
Pack‘
 *
p
;

59 
p
 = 
	`®loıkt
();

60 
hdr_¹p
* 
rh
 = hdr_¹p::
	`acûss
(
p
);

62 
rh
->
	`æags
(èğ(
u_št16_t
è
AUTH_REQ
;

63 
hdr_cmn
::
	`acûss
(
p
)->
	`size
(èğsiz((
MsgTy³
)
rh
->
	`æags
());

64 
rh
->
	`£qno
(èğ++
£qno_
;

65 
hdr_cmn
::
	`acûss
(
p
)->
	`time¡amp
(èğ
NOW
;

66 
p
->
	`£td©a
(
d©a
);

67 
rg‘_
->
	`»cv
(
p
);

68 
	`idË
();

69 
	}
}

71 
	gWimshUdpTuÂ–
::
	$size
 (
MsgTy³
 
msgTy³
)

73 
s
;

74 
msgTy³
) {

75 0: 
s
 = 30; ;

76 1: 
s
 = 30; ;

77 2: 
s
 = 30; ;

78 3: 
s
 = 30; ;

79 4: 
s
 = 30; ;

80 5: 
s
 = 30; ;

81 6: 
s
 = 30; ;

82 7: 
s
 = 30; ;

83 8: 
s
 = 30; ;

84 9: 
s
 = 30; ;

85 10: 
s
 = 30; ;

86 11: 
s
 = 30; ;

87 12: 
s
 = 30; ;

88 13: 
s
 = 30; ;

89 : 
	`abÜt
();

91  
s
;

92 
	}
}

94 
	gWimshUdpTuÂ–
::
	$»cv
(
Pack‘
* 
pkt
, 
HªdËr
*)

96 iàĞ
debug_
 ) {

97 
	`årštf
 (
¡d”r
, "%.9f Received…acketype %d flow id %d "

99 
NOW
, 
hdr_¹p
::
	`acûss
(
pkt
)->
	`æags
(), 
fid_
,

100 
hdr_cmn
::
	`acûss
(
pkt
)->
	`time¡amp
());

103 iàĞ
hdr_¹p
::
	`acûss
(
pkt
)->
	`æags
(è=ğ
TFTP_RSP
 ) {

104 
St
::
	`put
 ("udp_tuÂ–_d–ay", 
fid_
,

105 
NOW
 - 
hdr_cmn
::
	`acûss
(
pkt
)->
	`time¡amp
());

106 
Çg’ts_
--;

107 iàĞ
Çg’ts_
 > 0 ) ;

108 ** 
¬gv
 = 
Ãw
 *[1];

109 
¬gv
[0] = "print";

110 
St
::
	`commªd
 (1, 
¬gv
);

111 
	`ex™
 (0);

114 
Pack‘
 *
p
;

116 
p
 = 
	`®loıkt
();

117 
hdr_¹p
* 
rh
 = hdr_¹p::
	`acûss
(
p
);

119 
rh
->
	`æags
(èğ(
u_št16_t
è
hdr_¹p
::
	`acûss
(
pkt
)->flags() + 1;

120 
hdr_cmn
::
	`acûss
(
p
)->
	`size
(èğsiz((
MsgTy³
)
rh
->
	`æags
());

121 
hdr_cmn
::
	`acûss
(
p
)->
	`time¡amp
(èğhdr_cmn::acûss(
pkt
)->timestamp();

122 
rh
->
	`£qno
(èğ++
£qno_
;

123 
p
->
	`£td©a
(0);

124 
rg‘_
->
	`»cv
(
p
);

125 
Pack‘
::
	`ä“
 (
pkt
);

126 
	}
}

129 
	gWimshUdpTuÂ–
::
	$commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

131 iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[1], "set-node") == 0 ) {

132 iàĞ
	`¡rcmp
 (
¬gv
[2], "bs") == 0 ) {

133 
tuÂ–Ty³_
 = 
BS
;

134 } iàĞ
	`¡rcmp
 (
¬gv
[2], "sponsor") == 0 ) {

135 
tuÂ–Ty³_
 = 
SPONSOR
;

137 
	`årštf
 (
¡d”r
, "UnknowÀnodty³ '%s'\n", 
¬gv
[1]);

138  
TCL_ERROR
;

140  
TCL_OK
;

141 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[1], "start") == 0 ) {

142 
Çg’ts_
++;

143 
	`£ndmsg
 (0, 0, 0);

144  
TCL_OK
;

146  (
Ag’t
::
	`commªd
(
¬gc
, 
¬gv
));

147 
	}
}

	@wimsh_udptunnel.h

20 #iâdeà
__NS2_WIMSH_UDPTUNNEL_H


21 
	#__NS2_WIMSH_UDPTUNNEL_H


	)

23 
	~"ag’t.h
"

24 
	~"Œafg’.h
"

25 
	~"·ck‘.h
"

27 şas 
	cWimshUdpTuÂ–
 : 
public
 
Ag’t
 {

28 
´Ùeùed
:

30 
	eMsgTy³
 {

31 
AUTH_REQ
 = 0,

32 
	mAUTH_RSP
,

33 
	mREG_REQ
,

34 
	mREQ_RSP
,

35 
	mDHCP_DISCOVER
,

36 
	mDHCP_OFFER
,

37 
	mDHCP_REQ
,

38 
	mDHCP_ACK
,

39 
	mTIME_REQ
,

40 
	mTIME_RSP
,

41 
	mTFTP_RRQ
,

42 
	mTFTP_DATA
,

43 
	mTFTP_CPLT
,

44 
	mTFTP_RSP


46 
	eTuÂ–Ty³
 {

47 
	gSPONSOR
,

48 
	gBS


50 
	gpublic
:

51 
WimshUdpTuÂ–
();

52 
WimshUdpTuÂ–
(
·ck‘_t
);

53 
vœtu®
 
£ndmsg
(
nby‹s
, cÚ¡ *
æags
 = 0)

55 
£ndmsg
(
nby‹s
, 
NULL
, 
æags
);

57 
vœtu®
 
£ndmsg
(
nby‹s
, 
AµD©a
* 
d©a
, cÚ¡ *
æags
 = 0);

58 
vœtu®
 
»cv
(
Pack‘
* 
pkt
, 
HªdËr
*);

59 
vœtu®
 
commªd
(
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

60 
	g´Ùeùed
:

61 
TuÂ–Ty³
 
tuÂ–Ty³_
;

62 
	g£qno_
;

63 
	gÇg’ts_
;

65 
size
 (
MsgTy³
 
ty³
);

	@wimsh_weight_manager.cc

20 
	~<wimsh_weight_mªag”.h
>

22 
	gWimshWeightMªag”
::
	$WimshWeightMªag”
 (
WimshMac
* 
m
è: 
	`mac_
(m), 
	$tim”_
 (
this
)

24 
š‹rv®_
 = 0;

25 
nFlowDesc_
 = 0;

26 
nÜm®izeFlow_
 = 
çl£
;

27  
i
 = 0 ; i < 
WimaxMeshCid
::
MAX_PRIO
 ; i++ )

28 
´ioWeights_
[
i
] = 1.0;

29 
	}
}

32 
	gWimshWeightMªag”
::
	$»compu‹
 ()

34 
DescLi¡
::
cÚ¡_™”©Ü
 
™
;

35 
NdxLi¡
::
cÚ¡_™”©Ü
 
jt
;

38 cÚ¡ 
N
 = 
mac_
->
	`Âeighs
();

41  
i
 = 0 ; i < 
N
 ; i++ ) {

42 
weightIn_
[
i
] = 0;

43 
weightOut_
[
i
] = 0;

47 iàĞ
nFlowDesc_
 == 0 ) ;

50 
sum
 = 0;

54  
™
 = 
š_
.
	`begš
(è; iˆ!ğš_.
	`’d
() ; ++it ) {

57  
jt
 = 
™
->
ndx_
.
	`begš
(è; jˆ!ğ™->ndx_.
	`’d
() ; ++jt ) {

58 
un™
 = 
´ioWeights_
[
™
->
´io_
];

59 iàĞ
nÜm®izeFlow_
 ) 
un™
 /ğ()
™
->
ndxSize_
;

60 
weightIn_
[*
jt
] +ğ
un™
;

61 
sum
 +ğ
un™
;

66  
™
 = 
out_
.
	`begš
(è; iˆ!ğout_.
	`’d
() ; ++it ) {

69  
jt
 = 
™
->
ndx_
.
	`begš
(è; jˆ!ğ™->ndx_.
	`’d
() ; ++jt ) {

70 
un™
 = 
´ioWeights_
[
™
->
´io_
];

71 iàĞ
nÜm®izeFlow_
 ) 
un™
 /ğ()
™
->
ndxSize_
;

72 
weightOut_
[*
jt
] +ğ
un™
;

73 
sum
 +ğ
un™
;

78  
i
 = 0 ; i < 
N
 ; i++ ) {

79 
weightIn_
[
i
] /ğ
sum
;

80 
weightOut_
[
i
] /ğ
sum
;

82 
	}
}

85 
	gWimshWeightMªag”
::
	$š™Ÿlize
 ()

88 cÚ¡ 
N
 = 
mac_
->
	`Âeighs
();

91 
weightIn_
.
	`»size
 (
N
);

92 
weightOut_
.
	`»size
 (
N
);

94  
i
 = 0 ; i < 
N
 ; i++ ) {

95 
weightIn_
[
i
] = 0;

96 
weightOut_
[
i
] = 0;

100 iàĞ
š‹rv®_
 > 0 ) 
tim”_
.
	`¡¬t
 ( interval_ );

101 
	}
}

104 
	gWimshWeightMªag”
::
	$hªdË
 ()

106 iàĞ
WimaxDebug
::
	`Œaû
("WWMN::hªdË"èè
	`årštf
 (
¡d”r
,

107 "%.9àWWMN::hªdË [%d]\n", 
NOW
, 
mac_
->
	`nodeId
());

113 iàĞ
š‹rv®_
 <= 0 ) ;

115 cÚ¡ 
now
 = 
ScheduËr
::
	`š¡ªû
().
	`şock
();

117 
DescLi¡
::
™”©Ü
 
™
;

120  
™
 = 
š_
.
	`begš
(è; iˆ!ğš_.
	`’d
() ; ) {

121 iàĞ
now
 - 
™
->
Ï¡Rcvd_
 > 
š‹rv®_
 ) {

122 
DescLi¡
::
™”©Ü
 
drİ
 = 
™
++;

123 
š_
.
	`”a£
 (
drİ
);

124 --
nFlowDesc_
;

127 ++
™
;

131  
™
 = 
out_
.
	`begš
(è; iˆ!ğout_.
	`’d
() ; ) {

132 iàĞ
now
 - 
™
->
Ï¡Rcvd_
 > 
š‹rv®_
 ) {

133 
DescLi¡
::
™”©Ü
 
drİ
 = 
™
++;

134 
š_
.
	`”a£
 (
drİ
);

135 --
nFlowDesc_
;

138 ++
™
;

142 
	`»compu‹
 ();

145 
tim”_
.
	`¡¬t
 ( 
š‹rv®_
 );

146 
	}
}

149 
	gWimshWeightMªag”
::
æow
 (

150 
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
,

151 
´io
,

152 
ndx
,

153 
wimax
::
LškDœeùiÚ
 
dœ
)

155 
DescLi¡
::
™”©Ü
 
™
;

156 
	gNdxLi¡
::
™”©Ü
 
jt
;

159 
	gDescLi¡
& 
	gli¡
 = ( 
dœ
 =ğ
wimax
::
IN
 ) ? 
š_
 : 
out_
;

161  
	g™
 = 
li¡
.
begš
(è; iˆ!ğli¡.
’d
() ; ++it ) {

162 
boŞ
 
	gfound
 = 
çl£
;

164 iàĞ! 
	g™
->
	gšcom¶‘e_
 &&

165 
	g™
->
	g¤c_
 =ğ
¤c
 && 
™
->
d¡_
 =ğ
d¡
 && it->
´io_
 =ğ
´io
 ) {

166  
jt
 = 
™
->
ndx_
.
begš
(è; 
	gjt
 !ğ™->ndx_.
’d
() ; ++jt ) {

167 iàĞ*
	gjt
 =ğ
ndx
 ) {

168 
™
->
Ï¡Rcvd_
 = 
NOW
;

169 
	gfound
 = 
Œue
;

174 iàĞ
	gfound
 ) ;

178 iàĞ
	g™
 !ğ
li¡
.
’d
() ) ;

183  
	g™
 = 
li¡
.
begš
(è; iˆ!ğli¡.
’d
() ; ++it ) {

184 iàĞ
	g™
->
	gšcom¶‘e_
 && *(™->
	gndx_
.
begš
()è=ğ
ndx
 ) ;

190 iàĞ
	g™
 !ğ
li¡
.
’d
() ) {

191 --
nFlowDesc_
;

192 
	gli¡
.
”a£
 (
™
);

197  
	g™
 = 
li¡
.
begš
(è; iˆ!ğli¡.
’d
() ; ++it ) {

198 iàĞ! 
	g™
->
	gšcom¶‘e_
 &&

199 
	g™
->
	g¤c_
 =ğ
¤c
 && 
™
->
d¡_
 =ğ
d¡
 && it->
´io_
 =ğ
´io
 ) {

200 
™
->
ndx_
.
push_back
 (
ndx
);

201 
	g™
->
	gndxSize_
++;

207 iàĞ
	g™
 !ğ
li¡
.
’d
() ) {

208 
»compu‹
 ();

213 
FlowDesc
 
	gÃwæow
;

214 
	gÃwæow
.
	g¤c_
 = 
¤c
;

215 
	gÃwæow
.
	gd¡_
 = 
d¡
;

216 
	gÃwæow
.
	g´io_
 = 
´io
;

217 *(
	gÃwæow
.
	gndx_
.
begš
()èğ
ndx
;

218 
	gÃwæow
.
	gšcom¶‘e_
 = 
çl£
;

219 
	gÃwæow
.
	gÏ¡Rcvd_
 = 
NOW
;

222 
	gli¡
.
push_back
 (
Ãwæow
);

225 ++
	gnFlowDesc_
;

228 
»compu‹
 ();

232 
	gWimshWeightMªag”
::
æow
 (
ndx
, 
wimax
::
LškDœeùiÚ
 
dœ
)

234 
DescLi¡
::
™”©Ü
 
™
;

235 
	gNdxLi¡
::
™”©Ü
 
jt
;

238 
	gDescLi¡
& 
	gli¡
 = ( 
dœ
 =ğ
wimax
::
IN
 ) ? 
š_
 : 
out_
;

242  
	g™
 = 
li¡
.
begš
(è; iˆ!ğli¡.
’d
() ; ++it ) {

243 
boŞ
 
	gfound
 = 
çl£
;

244  
	gjt
 = 
™
->
ndx_
.
begš
(è; jˆ!ğ™->ndx_.
’d
() ; ++jt ) {

245 iàĞ*
	gjt
 =ğ
ndx
 ) { 
found
 = 
Œue
; ; }

247 iàĞ
	gfound
 ) ;

251 iàĞ
	g™
 !ğ
li¡
.
’d
() ) ;

254 
FlowDesc
 
Ãwæow
 (
ndx
);

257 ++
	gnFlowDesc_
;

260 
	gli¡
.
push_back
 (
Ãwæow
);

263 
»compu‹
 ();

267 
	gWimshWeightMªag”
::
	$commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
)

269 iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "weight-flow") == 0 ) {

270 iàĞ
	`¡rcmp
 (
¬gv
[1], "on") == 0 ) {

271 
nÜm®izeFlow_
 = 
Œue
;

272 } iàĞ
	`¡rcmp
 (
¬gv
[1], "off") == 0 ) {

273 
nÜm®izeFlow_
 = 
çl£
;

275 
	`årštf
 (
¡d”r
, "invalid weight-flow '%s' command. "

276 "Choo£ƒ™h” 'Ú' o¸'off'", 
¬gv
[1]);

277  
TCL_ERROR
;

279  
TCL_OK
;

280 } iàĞ
¬gc
 =ğ2 && 
	`¡rcmp
 (
¬gv
[0], "weight-timeout") == 0 ) {

281 
š‹rv®_
 = 
	`©of
 (
¬gv
[1]);

282  
TCL_OK
;

283 } iàĞ
¬gc
 =ğ3 && 
	`¡rcmp
 (
¬gv
[0], "prio-weight") == 0 ) {

284 
i
 = 
	`©oi
 (
¬gv
[1]);

285 
x
 = 
	`©of
 (
¬gv
[2]);

286 iàĞ
i
 >ğ
WimaxMeshCid
::
MAX_PRIO
 ) {

287 
	`årštf
 (
¡d”r
, "priority '%d'ƒxceedshe maximum value '%d'\n",

288 
i
, 
WimaxMeshCid
::
MAX_PRIO
 - 1 );

289  
TCL_ERROR
;

291 iàĞ
x
 <= 0 ) {

292 
	`årštf
 (
¡d”r
,

293 "´iÜ™y weighˆmu¡ b>ğ0 ('%f'‚Ù‡Îowed)\n", 
x
);

294  
TCL_ERROR
;

296 
´ioWeights_
[
i
] = 
x
;

297  
TCL_OK
;

299  
TCL_ERROR
;

300 
	}
}

	@wimsh_weight_manager.h

20 #iâdeà
__NS2_WIMSH_WEIGHT_MANAGER_H


21 
	#__NS2_WIMSH_WEIGHT_MANAGER_H


	)

23 
	~<wimsh_·ck‘.h
>

24 
	~<wimsh_mac.h
>

26 
	~<veùÜ
>

38 şas 
	cWimshWeightMªag”
 {

39 
	m¡d
::
	tli¡
<> 
	tNdxLi¡
;

47 
	sFlowDesc
 {

49 
WimaxNodeId
 
	m¤c_
;

51 
WimaxNodeId
 
	md¡_
;

53 
	m´io_
;

60 
NdxLi¡
 
	mndx_
;

62 
	mndxSize_
;

75 
boŞ
 
	mšcom¶‘e_
;

80 
	mÏ¡Rcvd_
;

83 
boŞ
 
	mİ”©Ü
=ğ(cÚ¡ 
FlowDesc
& 
desc
) {

84  ( 
¤c_
 =ğ
desc
.¤c_ && 
d¡_
 == desc.dst_ &&

85 
´io_
 =ğ
desc
.´io_ ) ? 
Œue
 : 
çl£
; }

92 
FlowDesc
 (
ndx
 = 0) {

93 
´io_
 = 0; 
	mndxSize_
 = 1; 
	mndx_
.
push_back
(
ndx
); 
	mšcom¶‘e_
 = 
Œue
; }

96 
	g¡d
::
	tli¡
<
	tFlowDesc
> 
	tDescLi¡
;

99 
DescLi¡
 
	gš_
;

101 
DescLi¡
 
	gout_
;

107 
	g´ioWeights_
[
WimaxMeshCid
::
MAX_PRIO
];

110 
	gnFlowDesc_
;

113 
	g¡d
::
veùÜ
<> 
weightIn_
;

115 
	g¡d
::
veùÜ
<> 
weightOut_
;

118 
WimshMac
* 
	gmac_
;

121 
	gTTim”
<
	gWimshWeightMªag”
> 
	gtim”_
;

133 
	gš‹rv®_
;

136 
boŞ
 
	gnÜm®izeFlow_
;

138 
	gpublic
:

140 
WimshWeightMªag”
 (
WimshMac
* 
m
);

142 
	gvœtu®
 ~
	$WimshWeightMªag”
 (è{ 
	}
}

145 
commªd
 (
¬gc
, cÚ¡ *cÚ¡* 
¬gv
);

148 
š™Ÿlize
 ();

151 & 
	$š‹rv®
 (è{  
š‹rv®_
; 
	}
}

154 
hªdË
 ();

157 
weight
 (
ndx
, 
wimax
::
LškDœeùiÚ
 
dœ
) {

158  ( 
dœ
 =ğ
wimax
::
IN
 ) ? 
weightIn_
[
ndx
] : 
weightOut_
[ndx]; }

168 
æow
 (
WimaxNodeId
 
¤c
, WimaxNodeId 
d¡
, 
´io
,

169 
ndx
, 
wimax
::
LškDœeùiÚ
 
dœ
);

178 
æow
 (
ndx
, 
wimax
::
LškDœeùiÚ
 
dœ
);

181 
»compu‹
 ();

184 
	gboŞ
& 
	$nÜm®izeFlow
 (è{  
nÜm®izeFlow_
; 
	}
}

187 & 
	$´ioWeight
 (
i
) {

188 iàĞ
i
 >ğ
WimaxMeshCid
::
MAX_PRIO
 ) 
	`abÜt
();

189  
´ioWeights_
[
i
]; 
	}
}

	@
1
.
0
31
574
wimsh_buffers.cc
wimsh_buffers.h
wimsh_bwmanager.cc
wimsh_bwmanager.h
wimsh_bwmanager_frr.cc
wimsh_bwmanager_frr.h
wimsh_channel.cc
wimsh_channel.h
wimsh_coordinator.cc
wimsh_coordinator.h
wimsh_coordinator_std.cc
wimsh_coordinator_std.h
wimsh_forwarding.cc
wimsh_forwarding.h
wimsh_header.h
wimsh_mac.cc
wimsh_mac.h
wimsh_packet.cc
wimsh_packet.h
wimsh_phy.cc
wimsh_phy.h
wimsh_scheduler.cc
wimsh_scheduler.h
wimsh_scheduler_frr.cc
wimsh_scheduler_frr.h
wimsh_topology.cc
wimsh_topology.h
wimsh_udptunnel.cc
wimsh_udptunnel.h
wimsh_weight_manager.cc
wimsh_weight_manager.h
